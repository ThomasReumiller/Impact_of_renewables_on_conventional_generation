
```{r 'check_ps', include=FALSE}

user.name = 'ENTER A USER NAME HERE'
```



# Impacts of renewable energy on conventional generation

Author: Thomas Reumiller

## Welcome...
...to this interactive RTutor problem set. The goal of this work, which is part of my master thesis at Ulm University, is to provide a fun and educational way to deepen your comprehension of econometric analysis and to sharpen your *R* skills. The problem set is based on the research paper **"Setting with the Sun: The Impacts of Renewable Energy on Conventional Generation"** which was written by James Bushnell and Kevin Novan. It was published in 2021 by the *"Association of Environmental and Resource Economists"*. The paper examines the potential mid- and long-term effects of increasing amounts of renewable energy sources on prices, emissions and conventional generation. The authors of the paper focus on California's electricity market and utility-scale solar and wind capacity.

You can find the published paper at this link:
https://www.journals.uchicago.edu/doi/abs/10.1086/713249

the original data is available here:
https://doi.org/10.7910/DVN/6XQZ3L

**Note:**  Please always open links in a new tab to avoid losing your progress. Right-click the respective link and select "Open link in new tab.".

The problem set is published here:

-   `GitHub`:
    <https://github.com/ThomasReumiller/Impact_of_renewables_on_conventional_generation>
-   `ShinyApps`:
    <https://thomasreumiller.shinyapps.io/Impact_of_renewables_on_conventional_generation/>


## Exercise Introduction

For several years, countries worldwide have been adopting measures to slow down and hopefully stop human-caused climate change. One of the most popular approaches is to decrease greenhouse gases, especially CO2 (HÃ¶hne et al., 2012). Since the energy and transportation sectors are the primary emitters of climate-harming gases (Ritchie et al., 2020), switching to clean energy sources is a vital priority. Replacing fossil fuels in generating heat can be challenging, but it is comparatively easy with regard to the production of electricity. This is done by substituting fossil fuel power generators with sustainable energy sources.

As some renewables like hydro and geothermal energies are only available in limited regions, one main focus for expanding renewable energy is solar and wind power (IREA, 2023). These energy forms have experienced significant capacity growth in many countries in recent years. Nevertheless, the production of energy with wind and solar comes with very unique characteristics. The energy production with these technologies is highly dependent on weather changes, daytime hours and seasons. For example, solar power plants generate electricity solely when the sun shines intensely, leading to an absence or a substantial decrease of power during the night or cloudy weather. Similarly, wind power stations' output hinges on external factors, such as the wind intensity.

Due to these characteristics and their fast-growing capacities, these two renewable energy technologies have a very specific impact on the associated electricity markets. Bushnell and Novan's paper explores these effects, with a focus on hourly wholesale electricity prices, the impacts on conventional power plants and resulting emission changes.


## How to work on the problem set

Since RTutor problem sets are meant to be interactive, it contains several tasks and quizzes. These different tasks are organized as exercises, which can be solved in an arbitrary order. Nevertheless, I would recommend following the structure of the paper in order to achieve the best user experience. Within each exercise, it is necessary to follow the order of the tasks.
You will encounter various types of tasks:

* quizzes where you can check whether you understood the theoretical background;
* empty *R* code chunks where to complete the task you have to fill in code by yourself;
* code chunks with gaps where you are asked to complete the code by replacing ___ correctly;
* furthermore code chunks which are already completed and you are only asked to execute by pressing `check`;


Some of these code-related task types may be challenging at first sight when you have only little experience using *R*, but you can always ask for a `hint`. If you got stuck or lose your motivation, you are always able to get the correct solution by pressing `solution`. If you wrote some code and you want to execute it, press `run`. Please note that, to correctly complete a task you have to verify the solution by clicking `check`.

Sometimes before working on a code chunk, you have to press `edit` first.

From time to time, you will get awards for completing tasks or exercises. These awards reflect your progress in becoming an expert in econometrics and coding in R. Additionally, they are intended to motivate you to complete further tasks and increase your knowledge even more.

When you have finished a (sub-)exercise, click on `Go to next exercise...`. Alternatively, you can navigate between the exercises with the tabs on the top.


## Exercise Table of content

1.  Data overview & descriptive analysis <br/>
1.1 Data overview <br/>
1.2 Descriptive analysis <br/>

2.  Possible concerns and resulting adjustments when performing regression analysis <br/>
2.1 Estimate the effect of wind and solar production on real-time market (RTM) prices with OLS-regression - introducing control variables <br/>
2.2 Standard errors (optional exercise) <br/>

3. Real-time market price changes <br/>
3.1 The model <br/>
3.2  Average change in hourly prices <br/>
3.3 Substitution between renewables and other sources <br/>

4. Impacts on emissions <br/>

5. Impacts on operating profits (counterfactual scenarios) <br/>
5.1 Counterfactual prices <br/>
5.2  Operating profit changes for conventional generators <br/>
5.3  Marginal energy value of renewable capacity additions <br/>

Recap & Conclusion

References


## Exercise 1 -- Data overview & descriptive analysis

The initial step of most economic analysis consists of the gathering and cleaning process of data. It is not uncommon, that this process needs much more time than the actual analysis. But as this may sound annoying it is very important to choose suitable data sources with care. Economic findings can easily get distorted or untrustworthy when built upon insufficiently meaningful sources of information. Besides the right choice for the data sources, it is important to build a dataset that contains all necessary information in the right format needed for the later analysis. Additionally, one should think about handling missing observations and outliers.

Thankfully, we do not need to build our dataset as we replicate a published study that also published the used dataset. But as we do not have gathered the dataset by ourselves it is important to familiarize ourselves with the given data.

To do so it is useful to ask yourself the following questions:

- Where does the data come from?

- Who was the collector and which purpose did he have? 

- What time period does the data reflect?

- What information does it hold? 

- In what condition is the data available? 

- What difficulties or distortions could the data contain? 

Especially if a dataset is already given, it should first be critically examined. This is because inaccurate, altered or misconstrued data may lead to faulty outcomes or conclusions. 

Before following Bushnell and Novan's steps through the paper, let us have a look at the dataset together and make some initial descriptive analyses to get a better feeling for the data.
We will also use this chapter to take our first steps in *R*.


### Structure

1.1  Data overview
 
1.2 Descriptive analysis


## Exercise 1.1 -- Data overview

The dataset contains hourly observations of electricity market data from California. The main source of the data is the California Independent System Operator ([CAISO](https://www.caiso.com/Pages/default.aspx)). This data is complemented by data from other sources like the Energy Information Administration ([EIA](https://www.eia.gov/)), the Continuous Emissions Monitoring Systems ([CEMS](https://www.epa.gov/emc/emc-continuous-emission-monitoring-systems)) of the Environmental Protection Agency or the National Oceanic and Atmospheric Administration ([NOAA](https://www.noaa.gov/)). We will now start by getting an overview of the data set and checking some of the questions we asked earlier. In particular, we will ascertain the observed time period and identify potential issues that probably require attention.

Before we can start exploring the dataset we need to load the provided data file. Since the original analysis is done in the programming language *stata*, the file has a `.dta` format. This is not a standard format for files in *R*.  Therefore, we need the command `read_dta()` from the package `haven` to read the file.

In the following info box, you can take a look at how to load the `haven` package which includes the function `read_dta()` that allows us to load the data.


```{r eval=FALSE}
# Run for additional info in the Viewer pane
info("How to load data with read_dta().")
```

**Task:** In order to use the `read_dta()` command load the package `haven` using the function `library()`.
```{r "4_4"}
#use the command library() combined with the correct parameter to load the haven package

```

**Task:** Now use `read_dta()` to read the file *Setting_Sun_dataset.dta* and store it in a variable called `dat`.
```{r "4_5"}
#use read_dta() to load "Setting_Sun_dataset.dta" and save it in 'dat'

```

We are now able to access the dataset using the variable name `dat`. To take an initial look at the data, use the `head()` command with `dat` as a parameter. This will display the first six rows of the dataset.

**Task:** Use `head()` on `dat` to view the first six rows.
```{r "4_6"}
#use head() on 'dat' 

```

We see that the dataset consists of 37 columns containing very different information. Before we take a closer look at the columns, we want to know how many different data points or observations (rows) are included in the dataset. To get the number of rows, we use the command `NROW()` on our variable  `dat`.

**Task:** Use `NROW()` on `dat` to get the number of rows.
```{r "4_7"}
#use NROW() on 'dat' 

```

Wow! We have a lot of data points. Luckily, we have such a great tool like *R* that helps us to work with this large quantity of data.

So let us now continue by inspecting the columns a little bit more. To get the names of all columns we can use the command `colnames()` on our dataset.

**Task:** Use `colnames()` on `dat` to get the column names.
```{r "4_8"}
#use colnames() on 'dat' 

```

Great, we see the names of the different columns. We can realise that the first five columns give some sort of hourly time stamp for each observation. We have columns for `year`, `month`, `day` and `hour`. But the first column `julian` may be unfamiliar to some.  Therefore, I will explain the meaning of it.

A Julian date is a continuous count of days since a specific origin date. This origin date can differ depending on the area of application or in our case the software used. Since we know that the original analysis is done in *stata* we need the origin of the Julian date which is used in *stata*.

Again, take a look at the first six rows from above. Can you guess (or calculate) the right origin?



Quiz: What is the right origin date used by *stata's* Julian date?

(1) 01.01.1960
(2) 01.01.2000
(3) 31.12.1899
(4) 24.11.-4714
(5) 01.01.1970

```{r eval=FALSE}
# Run line to answer the quiz above
answer.quiz("origin date of stata")
```

We can see that the Julian date gives every day a specific and unique number. If you want to learn more about Julian dates just read [the corresponding Wikipedia article.](https://en.wikipedia.org/wiki/Julian_day)

To determine the duration of the observation period covered by the dataset, we can use the Julian date and the `range()` command. This will provide us with the minimum and maximum entry of the column `julian`.

If we wish to obtain the range of a particular column, we must only address that column. In base *R*, we can achieve this by using the `$` syntax. For instance, to extract the `day` column from a data frame named `dat`, we would input `dat$hour`.

**Task:** Fill in the right argument using the data frame stored in `dat` and the `$` syntax to get the range of the column `julian`.
```{r "4_9"}
#fill in the right argument 
range(___)

```

Now we have the range for `julian`, but we do not know the dates that correspond to the result. To obtain the dates, simply run to the code chunk below.

**Task:** Just `check` the code chunk to get the dates corresponding to the Julian dates.
```{r "4_10"}
range(as.Date(dat$julian, origin="1960-01-01"))
```

We see that the observations are recorded from 01.01.2013 to 31.05.2017. We can quickly confirm the correctness and completeness of this result by calculating the number of observations that should be between these two dates and comparing it with the number of rows. Every Julian date (every observed day) should have 24 hourly observations. 

Therefore:
$$
(20970-19359+1) \times 24 = 38688 \neq \text{NROW}(dat) = 38683 = \# \text{Obseravtions}
$$
Oh no! Something seems to be wrong. We did not get the correct number of observations. Let us investigate where the five missing ones may be. To do so another package is very helpful.

If you want to analyse a dataset, there is a potent package that brings many helpful functions. It is called `dplyr`. We will use this package to locate the missing observations. Load the `dplyr` package by using the same function as before.

**Task:** Load the package `dplyr` using the command `library()`. 
```{r "4_11"}
#use the command library() combined with the correct parameter to load the dplyr package

```

Superb, now we are able to use all functions provided by the package `dplyr`. If you want to learn more about the package and its functions, please read [here](https://dplyr.tidyverse.org/).

If you never worked with the `dplyr` package or with pipes ` %>% ` it might be helpful to read the following two info boxes on how to access rows and columns using `filter()` and `select()` and on how to write code using pipes `%>%`. 


```{r eval=FALSE}
# Run for additional info in the Viewer pane
info("How to access rows and columns using filter() and select().")
```


```{r eval=FALSE}
# Run for additional info in the Viewer pane
info("How to write code using pipes (%>%).")
```

We now want to verify whether each Julian date in our data frame `dat` is covered by 24 hours. To do this, we will use a series of pipes. First, we will select the `julian` column from `dat` and then use the `table()` function to display each unique value that appears in the selected column together with its number of appearance. Next, we will use `sort()` to arrange the result such that the Julian date values that appear less frequently will be displayed at the top. Finally, we will display the first 10 rows by utilizing `head()`. To view more than six rows when using head, you need to pass the number of rows as an additional argument.

**Task:** Fill in the missing code lines to achieve the explained functionality.
```{r "4_18"}
#fill in the missing code
___ %>% 
  select(___) %>% 
  table() %>% 
  sort() %>% 
  head(___)

```

We have found out that there are five Julian dates, each of which has a missing observation. These findings correspond exactly with the five rows that were missing in the previous calculation. Since we have in total 38983 rows and only five are missing, we can ignore these missing values, particularly since they occurred during the night hours (hour == 2 and hour == 3), which are not as critical for our analysis as the morning or evening hours.

Until now we have only examined the first 5 columns of the dataset, which contain the time stamp of the observations. Now it is time to look at the other columns. Since they consist entirely of numerical values, we can obtain a quick overview by executing the `summary()` function on the data frame stored in `dat`.

**Task:** Just `check` the chunk to see a summary of all stored variables.
```{r "4_19"}
summary(dat)
```

 As you can see, the `summary()` function provides basic statistics for each variable including the minimum, maximum, mean, median, and the first and third quantile. Although some of this information is not useful for our further analysis, there is a line that displays the count of `NA` values. `NA` stands for "not available" and indicates missing entries.

When working with datasets containing `NA`'s, it is important to carefully consider how to handle them. If a column has a lot of missing data, this could lead to a higher grade of uncertainty or, in the worst case, incorrect results. It can also cause issues when running *R* commands.

Since the original analysis was conducted using *stata* and the authors did not select a specific method to manage missing information, we will follow their approach and just exclude observations that have missing data values in the selected variables.

Additionally to the information about NA values, the `summary()` command provides us an overview of all variables which are present in the dataset.


```{r eval=FALSE}
# Run for additional info in the Viewer pane
info("Description of the variables in the dataset")
```

Well, now we have an overview of the data which is available in the dataset. We have seen the names and descriptions of the variables, the time period which is covered and the source of the data. We also discovered some minor problems with the quality of our data.  However, until now we do not have a qualitative understanding of what information the data contains. So, the next exercise brings some descriptive graphics that probably increase our comprehension.


## Exercise 1.2 -- Descriptive analysis

In this exercise, we want to gain a deeper understanding of the qualitative information contained in our dataset as well as the framework conditions in which our later analysis will take place.

The study of Bushnell and Novan examines the response of the CAISO electricity market to growing renewable capacity. Previous similar studies either used simulation studies, which explore the long-term response to renewable capacity growth or used econometric approaches, which identify how daily variations in renewable output affect the wholesale price. The Paper of Bushnell and Novan extends the latter approach, differentiating itself with three key features from previous empirical studies.

The first key feature of the analysis performed in the paper and this problem set is that it is not the goal to observe and analyse effects caused by short-time fluctuations in solar production but to explicitly focus on long-time variations. Other studies often correct for these long-term effects (Bushnell & Novan, 2021a, p. 764). Due to this special research question the CAISO electricity market looks very promising as the renewable output and particularly utility-scale solar production steadily increased as capacity grew. Additionally, this recorded growth of renewable capacity in California is particularly large.

The second key feature of the analysis in the paper is that the authors focus on how the price response differs across hours of the day and seasons compared to just looking at an average change in the wholesale price (Bushnell & Novan, 2021a, p. 765).

The third difference is that throughout the whole analysis, it is not assumed that the wholesale price can only respond to the contemporaneous level of renewable output (Bushnell & Novan, 2021a, p. 765). The meaning of this assumption as well as the resulting consequences of this will be discussed in chapter 3.2.

For comparison, the authors did their whole analysis not only for solar energy but also for wind energy. We will follow this example and perform most of our analysis also for wind energy.

The current exercise aims to slowly guide you into the CAISO market in which the observations have been collected. Additionally, we want to explore why especially this market fits the requirements for the analysis very well. In the end, we will find some first evidence that raises the later answered research question. Moreover, in this exercise, you will learn to create some first plots using the package `ggplot2`. Some of the illustrations in this exercise can also be found in the original paper (Bushnell & Novan, 2021a, p. 766).

To ensure that each exercise in this problem set can be done without relying on previous exercises, you may have to reload the dataset, necessary variables and some needed packages at the start of each exercise. To do so please just `check` the following code chunk. Note, that this time the loaded dataset has the standard `.RDS` format for `R` data files. Although technically the loaded file is not the same as the one before it contains the same data and also looks identical in *R*.

**Task:** `Check` the chunk to reload the dataset and save it in a variable called `dat`. Additionally, the `dplyr` package is also reloaded.
```{r "5_1"}
dat = readRDS("Setting_Sun_dataset.RDS")
library(dplyr)
```

The first thing we want to do is to take a look at the growth of utility-scale solar capacity in California. 

Before we start doing the visualization we need to prepare our data such that we can easily create useful plots. First, we need to determine the calendar date that corresponds to each day of observation. This can be accomplished using the `mutate()` function from the `dplyr` package. With this function, we can add, modify or delete columns of a data frame.


```{r eval=FALSE}
# Run for additional info in the Viewer pane
info("Create, modify and delete columns of a data frame using mutate().")
```

**Task:** Transform every Julian day number in `dat` to the corresponding calendar date. To do this add a column named `date` which contains the corresponding transformation of the variable `julian`.
```{r "5_5"}
#fill in the missing code
dat = mutate(___, ___ = as.Date(julian, origin="1960-01-01"))

```

Excellent, we now have a new column containing the dates for every observation day.

Next, let us create our first visual representations using the `ggplot2` package. 

To do so, you need to import the `ggplot2` package, just as you did previously with `haven` and `dplyr`.

**Task:** Load the package `ggplot2`.
```{r "5_6"}
#load the ggplot2 package

```

Perfect, now we can use the whole toolbox provided by `ggplot2`. The most important function of this package is called `ggplot()`. For more information on how to use this function please read the info box.


```{r eval=FALSE}
# Run for additional info in the Viewer pane
info("Creating graphics with ggplot().")
```

As our goal is to look at the growth of **solar capacity (`solar_cap`)** during the observation period, we want to create a plot that shows the date on the x-axis and utility-scale solar capacity on the y-axis.

**Task** Create a basic line plot using `ggplot()` combined with `geom_line()` which shows the variable `date` on the x-axis and `solar_cap` on the y-axis.
```{r "5_8"}
#fill in the missing code to complete the task
ggplot(___, aes(x = ___, ___ = solar_cap)) +
  geom_line()+
  xlab("Year")+
  ylab("Solar capacity in MW")+
  labs(title = "Growth of solar capacity over observation period")

```

We see that the utility-scale solar capacity increased steadily and rapidly throughout the observation period. At the beginning of the period, the capacity was around 1208 MW and by the end, it had increased substantially to around 10003 MW. This confirms that there has been significant growth in California's utility-scale solar capacity.

In our next plot, we will focus on the **accumulated daily solar electricity production (`daily_solar`)** of each day. 

**Task** Create a graphic that shows the daily solar electricity production `daily_solar` over the days.
```{r "5_9"}
#fill in the missing code to complete the task
ggplot(dat, aes(x = date, y = ___)) +
  geom_line()+
  xlab("Year")+
  ylab("Daily solar production in GWh")+
  labs(title = "Solar production over observation period")


```

The graph shows the amount of solar energy produced by utility-scale solar plants. If you are familiar with solar energy production curves, you will recognize the typical shape.  During winter, the energy production drops sharply due to the lower angle of the sun and poorer weather conditions. In contrast, during the summer months, we see the highest production. Additionally, we can see a clear trend towards higher production over time due to the increasing solar capacity.

You may have wondered why I always mention the term "utility-scale" when discussing production or capacity. The answer is that the data provided by CASIO only covers utility-scale energy production and does not include distributed energy production. This is also why the description for some variables in the earlier exercise stated, "less distributed generation." Due to the limited information available for distributed generation, the fact that this energy is not usually sold on the wholesale market and the fact that utility-scale production is meaningful enough, the authors focused only on this type of energy production.

The second feature of the analysis is, that we are focusing on hourly changes rather than overall average changes, therefore we now want to produce the first hourly plot. Again, we need to prepare the data for this new task. Here you will get to know two additional helpful commands coming with the `dplyr` package. These commands are often used together. The first command is `group_by()` and the second is `summarise()`. If you are not familiar with these commands, please read the info box below.


```{r eval=FALSE}
# Run for additional info in the Viewer pane
info("Group tables with group_by() and summarise grouped variables with summarise().")
```

As our goal is to display average hourly quantities from different years, we need to group the data frame according to `hour` and `year` variables using `group_by`. After that, we can `summarise()` the average quantities using the function `mean()`. As this is only preparation work, I will not discuss the quantities we calculate in detail.

**Task** Group the data frame stored in `dat` by `hour` and `year`. Then summarise the mean of some quantities and save the solution in `dat_hour_avg`. Finally, show the first six rows of the new variable.
```{r "5_13"}
#fill in the missing code to complete the task
dat_hour_avg = ___ %>% 
  ___(hour,___) %>% 
  ___(load = ___(load),
      solar =  mean(solar),
      price = mean(rtm_total, na.rm = TRUE),
      wind = mean(wind),
      low_cost = mean(renewables + nuclear + large_hydro),
      high_cost = mean(thermal + imports))

head(___)


```

The new dataset includes 120 rows, with each row representing a unique combination of hour and year (24 hours * 5 years = 120). The output displays the variables `hour` and `year` that have been grouped, along with the columns defined in `summarise()`. These variables contain the defined entries that satisfy the specific grouping combination of hour and year. It is important to note, that for the calculation of the average price `na.rm = TRUE` needs to be added to the `mean()` command. This is because the column containing the hourly real-time market price `rtm_total` contains `NA` values. If we do not instruct the `mean()` function to remove them, the result would be also `NA`.

Now let us create a plot that shows the **hourly energy consumption (load)** over an average day in 2013 compared to 2016 (Bushnell & Novan, 2021a, p. 766).

**Task** Just `check` the chunk to generate the plot.
```{r "5_14"}
ggplot() +
  geom_line(data = filter(dat_hour_avg,year == 2016), aes(x = hour, y = load, color = "2016"))+
  geom_line(data = filter(dat_hour_avg,year == 2013), aes(x = hour, y = load, color = "2013"), linetype = "dashed")+
  ylim(15000, 35000)+
  ylab("Load in MW")+
  xlab("Hour")+
  labs(title = "Average hourly load 2013 and 2016")+
  theme(legend.position = "bottom",
        legend.title = element_blank())
  
```

The average hourly energy consumption in 2016 looks very similar to the one in 2013. However, there was a slight decrease in consumption at midday compared to 2013. At first, this pattern may appear strange, as one could expect a higher consumption over time, but Bushnell and Novan suggest that this is due to the increase in distributed solar, which is not part of CAISO's measured load (2021a, p. 765). Therefore, a higher production of distributed solar leads to a lower consumption measured by CAISO, which looks like a drop in the load profile at midday.

We also create charts like this for the average hourly solar and wind generation (Bushnell & Novan, 2021a, p. 766).

**Task** Just `check` the chunk to generate the plots.
```{r "5_15"}
ggplot() +
  geom_line(data = filter(dat_hour_avg, year == 2016), aes(x = hour, y = solar, color = "2016"))+
  geom_line(data = filter(dat_hour_avg, year == 2013), aes(x = hour, y = solar, color = "2013"), linetype = "dashed")+
  ylab("Solar power in MW")+
  xlab("Hour")+
  labs(title = "Average hourly solar power 2013 and 2016")+
  theme(legend.position = "bottom",
        legend.title = element_blank())
  
ggplot() +
  geom_line(data = filter(dat_hour_avg, year == 2016), aes(x = hour, y = wind, color = "2016"))+
  geom_line(data = filter(dat_hour_avg, year == 2013), aes(x = hour, y = wind, color = "2013"), linetype = "dashed")+
  ylab("Wind power in MW")+
  xlab("Hour")+
  labs(title = "Average hourly wind power 2013 and 2016")+
  theme(legend.position = "bottom",
        legend.title = element_blank())
```

The first of these two plots shows a notable increase in solar power generation during daylight hours, with a sharp rise in the morning and a sharp drop in the evening. The plot also highlights that solar power is as expected only generated during daylight hours.

The second plot for wind generation shows a curve with a drop at midday and higher production at night. There has been no significant increase in wind production over the years.

Before we draw the next graph about the average hourly real-time market prices of electricity, I would like to ask you to guess the shape of the following curve. As a little hint, you may read the following info block about the merit order principle.


```{r eval=FALSE}
# Run for additional info in the Viewer pane
info("Merit order principle")
```

With the merit order principle and the previous plots in mind, how do you think the average hourly real-time market price for electricity changed from 2013 to 2016?



Quiz: How do you think the average hourly real-time market price for electricity changed from 2013 to 2016?

(1) the price has fallen in all hours
(2) the price has remained roughly the same
(3) the price has risen in all hours
(4) the price has fallen in most hours but not as much in the morning and evening hours
(5) the price has fallen in the daylight hours and risen in the night hours

```{r eval=FALSE}
# Run line to answer the quiz above
answer.quiz("initial evidence")
```

To create the plot revealing the answer please just `check` the code chunk (Bushnell & Novan, 2021a, p. 766).

**Task** Just `check` the chunk to generate the answer plot.
```{r "5_16"}
ggplot() +
  geom_line(data = filter(dat_hour_avg, year == 2016), aes(x = hour, y = price, color = "2016"))+
  geom_line(data = filter(dat_hour_avg, year == 2013), aes(x = hour, y = price, color = "2013"), linetype = "dashed")+
  ylab("Price in $/MWh")+
  xlab("Hour")+
  labs(title = "Average hourly price 2013 and 2016")+
  theme(legend.position = "bottom",
        legend.title = element_blank())
```

As expected, the price decreased at almost every hour except the evening hours. The biggest drop can be identified during the midday hours. Surprisingly, there is also a drop in price during night hours, although there is no additional solar generation in these hours. 

In order to find an explanation for the lower prices also in the night hours, we can create another interesting graph.

**Task** Just `check` the chunk to generate the plot.
```{r "5_17",fig.width=10.5, fig.height=7}
ggplot() +
  geom_line(data = filter(dat_hour_avg,year == 2016), aes(x = hour, y = low_cost, color = "low_cost_2016"))+
  geom_line(data = filter(dat_hour_avg,year == 2013), aes(x = hour, y = low_cost, color = "low_cost_2013"), linetype = "dashed")+
  geom_line(data = filter(dat_hour_avg,year == 2016), aes(x = hour, y = high_cost, color = "high_cost_2016"))+
  geom_line(data = filter(dat_hour_avg,year == 2013), aes(x = hour, y = high_cost, color = "high_cost_2013"), linetype = "dashed")+
  ylab("Power production in MW")+
  xlab("Hour")+
  labs(title = expression(paste("Average hourly power production differentiated by \n variable costs of production 2013 and 2016")))+
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        plot.margin = margin(1, 0, 0, 0, "cm"))

```

In this graph, we use the average hourly production supplied by high marginal cost energy sources (thermal and imports) and low marginal cost energy sources such as renewables (including solar and wind), nuclear and large hydro (NREL, 2017). The plot shows that particularly at midday (but also at night) there is an increase in the production of electricity from low-cost power stations and a corresponding decrease in the production of electricity from high-cost power stations and imports. This explains the lower price also at night. But it cannot fully explain why prices did not fall in the evening hours.

In Bushnell and Novan's original paper, they used 2012 as a comparison (2021a, p. 766). Unfortunately, the data for this year is not available to us. In their comparison of the average hourly real-time market price, they found an even stronger price increase in the evening hours and also a small increase in the morning hours. You can see their original figure below.

**Average hourly price 2012 and 2016:**

![](figure1c.png)

Source: (Bushnell & Novan, 2021a, p. 766)

Bushnell and Novan take this emerging pattern as a first piece of evidence for their further analysis (which we will also perform later). They seek to answer the question of what causes this pattern and how it affects conventional generation. To do this, they allow renewable generation to have non-contemporaneous effects on wholesale prices.

Now that we have a basic overview of the information contained in the dataset, we will try to follow the steps of the authors of the paper to find similar answers. Before we can do this, we need to discuss the theoretical foundation of the economical approach our later analysis is based on. This is done in the following chapter.


## Exercise 2 -- Possible concerns and resulting adjustments when performing regression analysis

The goal of this new chapter is to introduce you to the main analysis methods used by Bushnell and Novan in their paper. This method is one of the standard methods used in empirical economic studies like this. The specific method being referred to is linear regression using ordinary least squares (OLS) estimation also called **OLS regression**. 

Using OLS regression, we will later determine the effect of increasing solar or wind generation on wholesale prices. Additionally, we will identify substitution patterns between renewables and other sources and investigate the impact of increased daily solar on CO2 and NOx emissions. OLS regression also lays the groundwork for our more advanced predictive analysis performed after the basic regression analysis.

However, before we start performing advanced OLS regressions as conducted in the paper, I would like to draw your attention to the characteristics of this regression method, possible challenges and the resulting adjustments that are necessary to obtain meaningful regression results.

The first exercises in this chapter provide a brief introduction to linear regression, including OLS estimation. The key takeaway from this exercise is that when performing OLS regression, one must carefully consider hidden confounders and resulting control variables to overcome endogeneity problems, such as omitted variable biases.

After that, the second exercise is dedicated to standard errors and possible adjustments that are useful when certain assumptions of OLS regression are not met. There I will introduce you to the Newey-West standard error. This section is conceived as an optional exercise for those of you who are interested in the theoretical background of error adjustment and assumption control. It explains how to handle errors in empirical analysis.


### Structure

2.1 Estimate the effect of wind and solar production on real-time market (RTM) prices with OLS-regression - introducing control variables

2.2 Standard errors (optional exercise)


## Exercise 2.1 -- Estimate the effect of wind and solar production on real-time market (RTM) prices with OLS-regression - introducing control variables

In this exercise we will perform an initial estimation of the impact wind and solar production has on real-time market prices using OLS regression. The methodology of OLS regressions is assumed to be familiar to many readers, but for those who are not familiar with this approach, all the necessary information is provided in the info box below.


```{r eval=FALSE}
# Run for additional info in the Viewer pane
info("OLS regression")
```

When thinking about a model to determine the effect of renewable generation (wind and solar) on the real-time market (RTM) price the easiest way would be to only include the variables of interest. The resulting model would look like

$$
\text{Price}_{h,d} = \beta^s_h \cdot \text{Solar}_{h,d} +  \beta^w_h \cdot \text{Wind}_{h,d} + \varepsilon_{h,d}
$$
where $h$ denotes the hour and $d$ the day.  

Without further consideration, one would automatically take hourly prices and also hourly wind and solar production variables.
So, we will now follow this naive approach and perform a simplified regression.

You can execute OLS regressions using the `lm()` command available in the `stats` package.


```{r eval=FALSE}
# Run for additional info in the Viewer pane
info("Fit and regress linar models using lm()")
```

Before we can use the dataset in this exercise, we need to reload it. We also directly load the `dplyr` package as we will need it for this exercise.

**Task** Just `check` the chunk to load the dataset and the already included packages again. 
```{r "7_2"}
dat = readRDS("Setting_Sun_dataset.RDS")

library(dplyr)
```

To simplify OLS regression with hourly variables, we begin by examining one hour of the day and then expand our analysis to include all other hours. We arbitrarily choose an observation at midday at 12 o'clock. Later we will extend to the entire day. We filter the observations to have a dataset that only contains the observations of interest.

**Task** Use the command `filter()` to create a new dataset called `dat_h12` which contains only observations that satisfy `hour == 12`. To confirm that everything went right show the first 6 rows of the new dataset.
```{r "7_3"}


```

Nice, everything seems fine.

So, let us take our first steps into the world of regression analysis by running the simple regression.

**Task** Perform a first simple regression using `lm()` which regresses `solar` and `wind` onto `rtm_total`. Use the dataset stored in `dat_h12` and name the result of the regression `reg_short`.
```{r "7_4"}
library(stats)

#fill in the missing code
reg_short = lm(___ ~ ___ + ___, data = ___)
___

```

The result of the regression is now stored in the variable `reg_short`.
Before we look at the result, I would like to ask you a brief question:



Quiz: What effects of the solar and wind production would you expect on the real-time market price at 12 pm?

(1) solar has no effect, wind has a negative effect
(2) solar has no effect, wind has a positive effect
(3) solar has a negative effect, wind has no effect
(4) solar has a positive effect, wind has no effect
(5) both have no effect
(6) both have a positive effect
(7) both have a negative effect 

```{r eval=FALSE}
# Run line to answer the quiz above
answer.quiz("reg_short results")
```

Great, both solar and wind production are expected to have a negative impact on real-time market prices. This is because solar and wind power plants have lower variable costs compared to other electricity sources, resulting in a higher supply of low-cost energy and subsequently leading to lower prices (NREL, 2017).

Let us now look at the results of our short regression model.

**Task** Just `check` the chunk to see the result of the short regression.
```{r "7_5"}
reg_short
```

Well, we now see the results of our simple regression. We identify the intercept ($\beta_0$) and the two betas ($\beta_1,\beta_2$) which give the estimated effects of the solar production and the wind production. We can interpret these regression results economically as follows:

Offset $\beta_0$,</br>
when there is neither wind nor solar production at 12 o'clock, the real-time wholesale market price of electric energy during the same hour is on average 62.30 $/MW.

solar $\beta_1$,</br>
each MW of solar production at 12 o'clock corresponds to an average reduction in the real-time wholesale market price during the same hour by -0.0055 $/MW.

wind $\beta_2$,</br>
each MW of wind production at 12 o'clock corresponds to an average reduction in the real-time wholesale market price during the same hour by -0.0071 $/MW.

As we expected both effects are negative.

To get more information about the results of the regression you can use the command `summary()`.

**Task** Just `check` the chunk to get more detailed information about the regression results. 
```{r "7_6"}
summary(reg_short)
```

The command provides us with more detailed information about the regression results. The `summary()` command gives not only the coefficients but also the standard errors, the residuals and some statistics. We are particularly interested in the t-statistic and the value of R-squared, in addition to the coefficients and standard errors.

If you are not familiar with these statistical measures, please read the info box.


```{r eval=FALSE}
# Run for additional info in the Viewer pane
info("t-tests, p-values and R-squared values")
```

The summary shows that, according to the t-statistic, both estimated coefficients are significantly different from zero. That means that our regression model finds a significant effect of hourly solar and wind production on the RTM prices. If we look at the adjusted R-squared, we see that, following this measure, about 13% of the observations can be explained by our model.

At first glance, the regression model appears to be meaningful for our research question. However, we now want to consider whether there are possible confounding variables that could falsify our estimate.


### Omitted variable bias and confounders

One difficulty when performing OLS regression is identifying and including all relevant variables in the regression model. If a variable from the actual (true) data-generating model is omitted from the regression model, the estimation results of the OLS regression may be biased. We call variables that may bias the regression results when omitted **confounders**. Note that this is not a general definition of a confounding variable, but as a full definition of a confounder is quite complex, we will stick to this simplified definition (for a full definition see VanderWeele et al., 2013).

One bias that can occur when a confounder is omitted is called **omitted variable bias**.

The **"omitted variable Bias"**(Stock et al., 2019, pp. 211-217; Wooldridge, 2013, p. 88) is a form of an endogeneity problem that contradicts one main assumption of the OLS regression theory.

The bias appears when a variable is omitted that:

- is correlated with a variable used as an independent variable in the model

**AND**

- has an effect on the explained variable (besides the effect over the correlated already used variable). 

The OLS regression assumption which is not fulfilled when omitting such a confounding variable is the **assumption of exogeneity** (Wooldridge, 2013, p. 87).


```{r eval=FALSE}
# Run for additional info in the Viewer pane
info("Exogeneity assumption of the OLS regression")
```

To make things clearer here is a graphical relationship chart for such a confounder.


![](confounder_1.png)

In the picture, we see the different variables and their relationship to each other. The one-sided arrow represents a causal relationship whereas the double-sided one represents a more general correlation. </br>
As confounding variables are a possible source of biased results it is necessary to find ways to counteract their biasing influence. One way to do this is by including the confounding variable as a **control variable** in the model (Wooldridge, 2013, p. 87). Control variables are explanatory variables that are not particularly of interest but are necessary to obtain unbiased results for the causal effects of the other explanatory variables. Therefore, one has to think about occurring bias based on confounders to probably add them to the model. However, adding control variables comes with its own risks. On the one hand, adding too many control variables can lead to overfitting problems and, on the other hand, poorly chosen control variables can change the economic question on which the model is based (Wooldridge, 2013, p. 88). 

We now concentrate on just one confounding variable of our model namely the **hourly demand of electric energy** also called `load`. First, we answer the question, if `load` really is a confounder biasing our result and what are the consequences when omitting `load` in our regression model.

An important fact for the following explanation is that the `load` measured by CAISO **does not include distributed solar generation**.

We first start with the obvious relationships. On the one hand, we have solar production where we assume that a higher production of solar energy has, due to the low variable costs of solar, a negative effect on the wholesale market price. On the other hand, we have the load where we assume that a higher demand for electricity leads to a higher energy price. These two relationships are causal and therefore fulfill the second condition for a confounder leading to an omitted variable bias.

The not-so-obvious part is the relationship between `solar` and `load`. As we will later see this is indeed not as easy as it might seem here. With our important fact about distributed solar in mind, we state that the variable weather or more accurate sunny weather influences solar production such that there is more solar production when there is more sunlight. Also, sunny weather influences the measured load, as the sunny weather leads to a higher production of distributed solar and therefore to a smaller amount of residual load measured by CAISO.

We can see the mentioned relationships on the left image of the graphic below.

![](confounder_2.png)

Simplified, the relationships found look like the picture on the right. Here the variables "Load" and "Solar" have a negative relationship. 

The right relationship chart now looks like our definition of a confounder variable causing omitted variable bias which proves our statement that `load` is a confounder variable true. Note, that the negative correlation relationship between "Solar" and "Load" is not causal, since they do not affect each other but are both affected by a third variable "Sunny Weather". 

As we also marked the sign of the relationships, we can now make an educated guess which direction our bias of $\hat\beta^s_h$ (the hourly price effect of additional solar generation) in the short regression has.
Remember that $\hat\beta^s_h$ of the short regression was `-0.005497`.



Quiz: Based on the relationship chart, which direction of the bias associated with the coefficient of solar do you expect in the short regression?

(1) I expect the biased coefficient to be biased towards zero (underestimating the effect).
(2) I expect the biased coefficient to be biased away from zero  (overestimating the effect).

```{r eval=FALSE}
# Run line to answer the quiz above
answer.quiz("bias of confounder ")
```

We achieve this answer by thinking about the consequences of the effect of "Solar" on "Price" when neglecting "Load". Assume we neglect the confounder "Load" although this relationship exists. A rise in solar production leads to a decrease in the market price, BUT the growth in solar output is also correlated to a decrease of measured load which leads to an additional price reduction on the wholesale market. If we do not control for `load` this correlated additional reduction is added to the estimated effect of `solar`, although this decrease is not causally affected by the growth of solar output. To summarize, without controlling for `load` (short regression) we overestimate the effect of `solar` on `rtm_total`.

If the variable `load` would be causally affected by `solar`, it is not obvious that we would include `load` as a control variable. This is because the decrease resulting from the lowered measured load would then be a part of the total effect of increasing solar on the market price, which is the effect we want to analyze. The decision whether to include a control variable or not depends strongly on the research question.

If you are sometimes confused about the difference between "causality" and "correlation", you are not alone. Therefore, a short differentiation is provided in the info box.


```{r eval=FALSE}
# Run for additional info in the Viewer pane
info("Difference between correlation and causality")
```

With the help of our dataset, we now check if the bias behaves as predicted. We therefore regress a longer regression model that includes `load` as a control variable. To include control variables in the `lm()` command, just add them as any other independent variable.

**Task** Perform the new regression using `lm()` and including `load` as control variable. Use the same dataset as in the short regression and name the new regression result `reg_long`. After performing the regression show the results using `summary`.
```{r "7_7"}
#write the code to perform the task

```

Again, we see the results of the regression and some statistics. In addition to the coefficients for `solar` and `wind`, we now have $\hat{\beta}$ for `load`. The coefficient shows that an increase in electricity demand by 1 MWh corresponds to an increase in the electricity real-time market price of about 0.002 $/MW. This result coincides with our relationship diagram above, where we stated that higher demand leads to higher prices. Note that the addition of an extra control variable also affects the other coefficients.

To compare both regression results side by side we can use the command `stargazer()` from the package `stargazer`.

**Task** Just `check` the chunk to compare the solutions of the two regressions using `stargazer()`. 
```{r "7_8"}
library(stargazer)

stargazer(reg_short, reg_long, type = "text", digits = 5)
```

Comparing the regression results, we notice that the longer regression shifts the results for the effect of `solar` more in the direction we expect. The effect estimated by the long regression is slightly lower than estimated with the short regression.

As the longer regression estimates results which are more in line with our econometric expectations and an additional reasonable control factor have been included in the model, we would prefer the longer regression model.

When directly comparing the results for $\hat{\beta}_{solar}$ we see that the coefficient changed by around 0.00013. This bias is the omitted variable bias $Bias(\hat{\beta}_{solar})$ for $\hat{\beta}_{solar}$ when omitting `load`. 

If in a model with one exploratory variable, only one confounder is omitted, it is possible to calculate the omitted variable bias (Stock et al., 2019, p. 214):

$$
Bias(\hat{\beta}_{solar}) = \text{E}[\hat{\beta}_{solar}]-\beta_{solar} = \beta_{load} \cdot \frac{Cov(solar,gas\_price)}{Var(solar)} \tag{1}
$$
Although this formula is only exact if just one variable is omitted and there is just one exploratory variable, we use it anyway to get a feeling of the possible bias produced by omitting the confounder `load`.

Often, it is more important to know the direction of the bias than its actual value. Luckily, the direction can be much easier determined. Since $Var(solar)$ is always positive it directly follows:

$$
sgn(Bias(\hat{\beta}_{solar})) = sgn(\beta_{load}) \cdot sgn(Cov(solar, load))
$$
$sgn()$ here means the **sign function**, which is either 1 if the argument is positive, 0 if the argument is zero and -1 if the argument is negative.
Although $\beta_{load}$ and $Cov(solar,gas\_price)$ are not always trivial to determine, one can make an educated guess, as we did with our relationship graph above, to get their sign. 

Following the explanation of the relationship graph above we would expect $sgn(\beta_{load})$ to be positive and therefore equal to 1. For $sgn(Cov(solar, load))$ we found a negative sign and therefore -1. </br>
All in all, we get that the direction of the bias $sgn(Bias(\hat{\beta}_{solar}))$ is negative. We can confirm this with our two different regression models where we see that the short regression gets a lower $\hat{\beta}_{solar}$ than the longer regression. We call the bias a **downward bias** when the direction is negative and an **upward bias** when it is positive.

As we already performed the longer regression and determined $\hat{\beta}_{load}$ we can also confirm equation $(1)$.

**Task** Following equation $(1)$ calculate the bias of $\hat{\beta}_{solar}$. Use the already given variables.
```{r "7_9"}
var_solar = var(dat_h12$solar)
cov_solar_load = cov(dat_h12$solar, dat_h12$load)
beta_load = coef(reg_long)[4]

#write the formula for the calculation using the given variables

```

We see that the solution is very close to the bias we found between the two regression results. The found difference was 0.00013. Note that the used formula actually only holds if `load` would be the only omitted variable and solar would be the only exploratory variable.

This ends the theoretical part about OLS regression, confounder variables, control variables and omitted variable bias. Now you should know how the basic OLS regression works and why we need to add control variables to face possible endogeneity problems due to confounders. It should also be clear why it is crucial to define a model that is thought through to ensure sensible results.

As you might recognize when explaining the relationship between `solar` and `load`, I claimed that this connection is not as simple as it might have seemed in the following explanation. The brave of you who want to see some difficulties that occur when trying to identify confounders and their effects can read the info box below. The rest of you can just skip these additional thoughts.


#! start_note "Confounders can cause confusions"

Unfortunately, when working with real-world data it is often not obvious which possible confounders affect the regression results. Even if a confounder is identified, its effect on the result cannot always be determined with certainty. In the above explanation, we ignored other effects that influence both solar output `solar` and electricity demand `load` for didactic reasons.

A more precise but also much more complex relationship graph could be sketched like this:

![](confounder_4.png)

The figure shows that the relationship we focused on is just a small part of a much more complex relationship structure. 

For example, the sunny weather here called "Sunshine" also affects temperatures which further affects load. This connection can look like this: If the sun heats buildings, people start to use their air conditioning, which consumes a lot of energy. In contrast, if the sun is not shining people probably have to heat their buildings.

Another relationship between solar and load is found due to "Daytime". Normally the sun is shining during the daytime and also people tend to work during these hours. When companies and especially industrial consumers therefore use more power during day hours the load is again correlated with solar.

A third and very unsatisfying relationship between solar and load are "long-run patterns". As we saw in exercise 1.2, solar output grew during our observation period. Probably there are also long-run patterns in demand or supply which are correlated with this growth in solar output. As these long-run patterns are much more subtle it is not obvious in which direction they bias our OLS regression result.

Due to all these different factors, it is not trivial to predict the direction of the bias which is introduced by omitting the variable `load`. Thankfully, in the normal everyday analysis work, it is not necessary to know the direction of the bias. It is sufficient to realize that there is a potential bias. Luckily, for the educational explanation above, we chose the right assumptions that led to the right direction (probably these choices were not by chance).

When you execute the following code, you will see that in many hours the correlation between `solar` and `load` is not as in our example. 

**Task** Just `check` the chunk to see the relationship between the variables `solar` and `load` in the different hours of the day.
```{r "7_10",optional=TRUE}
for (h in 1:24) {
  print(paste("The correlation of solar and load in hour", h, "is", round(cor(filter(dat, hour == h)$solar, filter(dat, hour == h)$load, use = "pairwise.complete.obs"), digits = 3)))
}
```

#! end_note

The next exercise will be dedicated to standard errors and how we have to adjust them, if some other assumptions of the OLS regressions do not fit. Although this is also an important part of data analysis, I know that probably not all of you are interested in this rather theoretical topic. Therefore, the following exercise is just **optional** for those who want to learn more about standard errors and in particular Newey-West errors.


## Exercise 2.2 -- Standard errors (optional exercise)

The top priority for a regression analysis is to get accurate estimators for the effects of interest. In addition, the regression should also provide standard errors for the estimated coefficients $\hat\beta$, which show the uncertainties of the model and the real-world background in a meaningful way. Luckily, with the OLS regression approach, sensible standard errors can be calculated. 


### Standard errors and confident intervals

In OLS regression, the **standard errors** of the estimators measure how much the estimators vary or spread out. It is a measure for the accuracy of the estimation. Put simply, a standard error indicates how distant an estimated coefficient is expected to be from the true population coefficient. 

If all OLS regression assumptions are satisfied, the variance-covariance matrix of the estimator $\hat\beta$ is defined as $Var(\hat\beta) = \sigma^2(X'X)^{-1}$ (Verbeek, 2004, p. 80; Kennedy, 2008, p. 48). But since we typically lack knowledge of the real variance of the error term $\sigma^2$, we can compute an estimator for the variance-covariance matrix such as

$$
\hat{Var}(\hat\beta) = \hat\sigma^2(X'X)^{-1}
$$

Remember $X$ is a matrix containing the independent variables.
You can see that the only difference between the estimated variance matrix and the definition is, that we use the estimate $\hat\sigma^2$ instead of the unknown real error term. The calculation of the approximation $\hat\sigma^2$ can be accomplished through the use of the formula (Verbeek, 2004, p. 82):

$$
\hat\sigma^2 = \frac{1}{T-K}\sum^T_{t=1}\hat\varepsilon_t^2 = \frac{1}{T-K}\cdot SSR
$$
$T-K$ represents the **degrees of freedom (df)** where $T$ is the number of observations and $K$ is the number of estimated coefficients. Again, SSR is the square sum of the residuals $\hat\varepsilon_t$.

To obtain the estimated standard errors from the variance-covariance matrix, simply concentrate on the diagonal entries of the matrix. These entries represent the variances of the different estimators $\hat\beta_k$. To compute the standard errors, you only need to take the square root of the variances (the diagonal entries).

$$
\hat {se}(\hat \beta_k) = \sqrt{[\hat{Var(\hat\beta)}]_{kk}}
$$
In *R*, you can use the `vcov()` function to compute the variance-covariance matrix from a `lm()` output. After that, you can calculate the standard errors following the formula above. To directly display standard errors out of a `lm()` output you can just use `summary()` as we did before.

To confirm that both methods yield the same outcome, determine the standard errors using the above formula and then compare them to the results of `summary()`. As this is a new exercise you need to reload the dataset and redo the regression we did earlier.

**Task** Just `check` the code chunk to reload the dataset and needed packages and run the regression as we did in the previous exercise.
```{r "8_1"}
dat = readRDS("Setting_Sun_dataset.RDS")

library(stats)
library(dplyr)

dat_h12 = filter(dat, hour == 12)
reg_long = lm(rtm_total ~ solar + wind + load, data = dat_h12)
```

**Task** Calculate the standard errors of the regression using the formula and compare them to the solutions provided by `summary()`.
```{r "8_2"}
# Hint: use the commands sqrt(),vcov() and diag()
#sqrt() calculates the square root of the argument
#diag() selects the diagonal elements of a matrix
se = ___(reg_long) %>% 
  ___() %>% 
  ___()

se

summary(reg_long)

```

We find that the errors calculated by hand are identical to those calculated by the `summary()` command.

Standard errors are essential for establishing **confidence intervals** for the estimates of regression analysis. These intervals allow us to determine a range of values, based on the standard errors, where the actual population parameter is likely to be.

To work out the confident interval of an estimator $\hat\beta_k$, you need to add and subtract a certain multiple (margin of error) $z_\gamma$ of the standard error $\hat {se}(\hat \beta_k)$ (Stock et al., 2019, p. 250).   

$$
CI_\gamma(\hat\beta_k) = \hat\beta_k \pm z_\gamma \cdot  \hat {se}(\hat \beta_k)
$$
The value for $z_\gamma$ varies depending on the confidence level $\gamma$ you choose and can be looked up in tables such as [here](https://en.wikipedia.org/wiki/Margin_of_error#Maximum_margin_of_error_at_different_confidence_levels). Some common options for $\gamma$ are 68%, 90%, 95%, or 99%.



Quiz: Which multiple of the standard error is used to calculate the 95% confidence interval?

(1) 1.96
(2) 2.33
(3) 0.99
(4) 2.97

```{r eval=FALSE}
# Run line to answer the quiz above
answer.quiz("multiple of 95 percent confidence interval")
```

As discussed earlier, we consider an effect significant if the 95% confidence interval excludes zero. Hence, we typically choose $z_\gamma = 1.96$.

Standard errors are utilized to define confidence intervals since they provide a measure of the precision of our estimates. A smaller standard error indicates greater precision. A 95% confidence interval can be interpreted as follows: "We are 95% confident that the population parameter lies within this range." This helps us measure the uncertainty in our estimates, which is vital for informed decisions based on statistical analysis outcomes.

In *R*, you can use the `confint(..., level = 0.95)` command to determine 95% confidence intervals. The first argument should be the result of a regression.

Please compute the 95% confidence interval manually using the formula above and compare it with the result of `confint()`. As $1.96 \approx 2$ we often use the rounded integer to calculate the interval.

**Task** Calculate the 95% confidence interval using the formula above and $z_\gamma \approx 2$, then compare it with the results from the `confint()` command.
```{r "8_3"}
conf_upper = coef(reg_long) + ___*se
conf_upper

conf_lower = ___
conf_lower

___(reg_long)

```

Although we have approximated the margin of error, the results are very close to those obtained by `coefint()`. Hence, it is acceptable to use the approximation in the remaining exercises.

Until now we have talked about standard errors and confidence intervals of OLS regressions when the assumptions of OLS regression are satisfied. But now we want to look at possible cases where the assumptions are not fulfilled. Common assumptions, that do not hold are homoscedasticity and non-autocorrelation.


```{r eval=FALSE}
# Run for additional info in the Viewer pane
info("Spherical errors assumption of the OLS regression (heteroskedasticity and autocorrelation)")
```


### Heteroskedasticity and autocorrelation

Empirical economic studies usually work with real-world data that typically do not meet all of the OLS regression assumptions. Especially the assumption of homoscedasticity and the non-existent autocorrelation are often not met.

To check if there are some possible violations of these two assumptions, we can take a look at the data itself.
Let us first check the homoscedasticity assumption. To do so we want to plot the residuals $\hat\varepsilon_t$ vs. the fitted explained value $\hat y_t$.

**Task** Please just `check` the chunk to create a residual vs. fitted plot.
```{r "8_4"}
library(ggplot2)

dat_plot = data.frame(residuals = resid(reg_long), fitted = fitted(reg_long))

ggplot(dat_plot, aes(x = fitted, y = residuals))+
  geom_point()+
  labs(title = "residuals vs. fitted plot")+
  xlab("Fitted values")+
  ylab("Residuals")+
  ylim(-75, 75)    #you can change the limit to -250,750 and press `run chunk` to see all data points
```

With this figure, we can confirm whether the OLS regression homoscedasticity assumption is valid or not. While there are some fluctuations and outliers, we do not find any clear violation of the homoscedasticity assumption as there is no systematic change in the residuals. Usually, this assumption tends to hold when dealing with datasets that have a large number of observations.

You can discover additional tests for homoscedasticity using *R* [here](https://www.codingprof.com/3-easy-ways-to-test-for-heteroscedasticity-in-r-examples/).

The second issue we are probably dealing with is a possible autocorrelation. To examine this, we will use two different methods. The first method is the Durbin-Watson Test (Kennedy, 2008, p. 119). This test shows the amount of autocorrelation for diverse lags, along with some statistical values to classify the results. This test is included in the `durbinWatsonTest()` command of the package `car`.  Another method to verify autocorrelation is through inspecting the autocorrelation function plot. The `stats` package provides the necessary `acf()` command for this purpose.

**Task** Just `check` the chunk to perform a Durbin-Watson-Test and to create a plot of the autocorrelation function.
```{r "8_5"}
library(car)

durbinWatsonTest(reg_long, max.lag = 10)

acf(resid(reg_long), lag.max = 10, main = "Amount of autocorrelation for different lags")
```

The Durbin-Watson-Test shows the autocorrelation for lags up to ten as well as a so-called "D-W statistic". This statistic ranges from 0 to 4, with 2 denoting no autocorrelation. The closer the statistic is to 0, the more evidence there is for positive autocorrelation. The closer it is to 4, the more evidence there is for negative autocorrelation. The p-value shows the possibility of getting the given result if the correlation coefficient was in fact zero (the null hypothesis). At a lag of 1, we see some significant (p-value < 0.05) autocorrelation.

The graph of the autocorrelating function shows the same results. There we see the lags on the x-axis and the autocorrelation on the y-axis. The dashed blue line represents the significance level of 0.05.  This figure helps us to identify the crucial lags and to estimate the intensity of autocorrelation more efficiently. Keep in mind that these autocorrelations only apply for our `reg_long` model and `hour == 12`

You can discover additional tests for autocorrelation using *R* [here](https://www.codingprof.com/3-easy-ways-to-test-for-autocorrelation-in-r-examples/).

The authors Bushnell and Novan adjust their standard errors to be heteroscedasticity and autocorrelation consistent (HAC). They achieve this by using Newey-West standard errors with a maximum lag of 7 (Bushnell & Novan, 2021a, p. 772). This means that the errors of each hour might be correlated over a 7-day lag. 


### Newey-West standard errors

One way to solve problems with autocorrelation and heteroskedasticity is to use the **Newey-West estimator** as an estimate for the variance-covariance matrix of an OLS regression (Newey & West, 1987). This estimate ensures that the results are **heteroscedasticity and autocorrelation consistent (HAC)**. Whitney K. Newey and Kenneth D. West introduced this method in 1987.

The Newey-West estimator $\hat{NW}$ looks like (Greene, 2002, p. 200):

$$
\hat{NW} = S_0 + \frac{1}{T} \sum^L_{l = 1} \sum^T_{t = l+1} w_l \hat\varepsilon_t \hat\varepsilon_{t-l} (x_t x'_{t-l} + x_{t-l} x_t')
$$
with

$$
S_0 = \frac{1}{T} \sum^T_{t = 1} \hat\varepsilon^2_t x_t x_t'
$$

In this equation, the size of the sample is represented by $T$, the residuals are denoted as $\hat\varepsilon_t$ and the rows from the matrix of independent variables ($X$) are represented by $x_t$. When calculating the Newey-West estimator, it is important to choose the coefficient $L$, which indicates the lag up to which the disturbance term is assumed to be autocorrelated. There is no clear rule for selecting $L$, but a commonly used suggestion is to choose $L \approx T^{1/4}$ (Greene, 2002, p. 200). $w_l$ is a factor that determines how much influence distant residuals have compared to closer ones. It appears like this:

$$
w_l = 1 - \frac{l}{L+1}
$$

To obtain the standard errors from the adjusted variance-covariance matrix, one just performs the same calculation as before with the unadjusted standard errors.

$$
\hat{se}_{NW}(\hat\beta_k) = \sqrt{[\hat{NW}]_{kk}}
$$
In *R*, you can compute the Newey-West variance-covariance matrix by using the `NeweyWest()` command provided by the `sandwich` package. We now compare the normal standard errors and the HAC standard errors computed as Newey-West errors to see the differences. To obtain outcomes similar to those in *stata*, we have to add the parameter `prewhite = FALSE` to the `NeweyWest()` command.

**Task** Please fill in the missing lines of code to compute the Newey-West standard errors. Use `lag = 7` and the standard error formula above.
```{r "8_6"}

#fill in the missing code to complete the task

library(sandwich)
library(stargazer)

nw = NeweyWest(reg_long,lag = ___, prewhite = FALSE)
nw_error = ___(___(___))

stargazer(reg_long, reg_long, type = "text", se = list(NULL, nw_error), column.labels = c("Normal SE", "HAC SE"))

```

The table shows that the errors have slightly changed. In future analyses, we will use HAC standard errors, as Bushnell and Novan did. However, we are unable to reproduce the exact standard errors reported in the paper, possibly due to differences in calculation methods between *Stata* and *R*. 

We will now end this exercise dedicated to standard errors and their adjustment techniques. We have seen which possible concerns may occur when specific assumptions of the OLS regression are not fulfilled. We also checked these assumptions together with our dataset and worked out that our standard errors need some type of adjustment. Like Bushnell and Novan, we therefore chose Newey-West standard errors to adjust the estimated errors.

Finally, also chapter 2 comes to an end and we shift our focus back to the OLS regression analysis. Our next step will be to complement the simple regression model with the remaining control variables Bushnell and Novan used. We also now want to expand the regression to cover not only one hour of the day but instead all 24 hours of one day.


## Exercise 3 -- Real-time market price changes

The next chapter discusses the main regression analysis conducted by Bushnell and Novan (2021a, pp. 771-779). Unlike the previous exercises, where we used simplified models to gain deeper understanding of the econometric approaches, we now follow the steps outlined in the paper (except for the digression on hourly or daily time aggregation in exercise two). The primary objective of the first analysis is to estimate the impact of the increased capacity and following increased production of renewable energy, on real-time market (RTM) prices.

In the first exercise of this new chapter, I will introduce the main regression model we will use. There I will explain why certain variables, particularly the controls, were chosen and which endogeneity problems they probably solve.

In the second exercise, we perform the OLS regression to analyse the impact of increasing renewable energy production on prices. While Bushnell and Novan used daily aggregate production variables right away, we regress the model obtained in the first exercise twice. Once with hourly production variables and the other time with daily aggregate production variables as in the paper. We then compare and discuss the differences between these two choices for time aggregation when estimating the effect of increasing output on the real-time market electricity price. The differences between contemporaneous and non-contemporaneous effects is introduced here. After this digression, we stick to the choice of Bushnell and Novan and discuss the results of the daily variable regressions in detail.

The last exercise of the current chapter is dedicated to substitution patterns between renewables and conventional energy sources to determine the reasons for the found effects in exercise two. Our findings show that the price effect of increasing daily solar can be explained by a shift in energy generation of conventional generators. This shift results in a reduction of the output from fuel-efficient but inflexible power plants and an increase in the use of more flexible but less efficient power generators.


### Structure

3.1 The model

3.2 Average change in hourly prices
 
3.3 Substitution between renewables and other sources


## Exercise 3.1 -- The model

As we now follow the analysis Bushnell and Novan performed in their paper, I want to shortly recall the main goals of the analysis and the approach Bushnell and Novan chose (2021a, pp. 768-771). 


### Goals of the price analysis

The paper conducts a detailed examination of how renewable generation affects electricity prices. Unlike most other studies that estimate average changes in wholesale prices caused by renewable generation, the analysis performed in the paper investigates how the response  to renewable capacity growth varies across different hours of the day and across different seasons. This approach provides a more nuanced understanding of the long run impact of increasing renewable energy on the electricity market.

The regression analysis examines the impact of solar and wind energy on wholesale prices, including non-contemporaneous effects. Daily aggregate production variables are used to analyze this special form of impacts renewable energy has, resulting in a deeper understanding of how solar energy affects prices during both production and non-production hours. This approach differs from most studies that only consider the contemporaneous level of renewable output when estimating the hourly wholesale price response (the next exercise of this chapter will focus on this important, but probably difficult to understand difference between contemporaneous and non-contemporaneous effect estimation). The analysis therefore captures a broader effect of renewable energy on the electricity market by working with the total daily output.

The empirical approach of the authors also differs from previous studies in how it deals with the longer-run trends in renewable output, specifically the steady increase in solar output during the observation period. Previous studies mostly do not exploit this longer-run variation, instead focusing on short-run fluctuations in renewable generation. By considering the longer-run trends, the analysis can capture the impact of long-term growth in renewable energy capacity.


### Building the model

As we have seen before, a sensible regression model including relevant control variables is crucial when performing regression analysis. Therefore, we will now discuss the used regression model including all necessary confounding variables. Here, we will follow the argumentation proposed by Bushnell and Novan (2021a, pp. 771-773). At the end we will achieve a model that allows a sensible regression analysis.

Similarly to the simple regression models used before our main variables of interest are the solar and wind production. Obviously these two factors should be included in the model. However, we do not want to commit ourselves whether to use hourly or daily production variables. 

After including the variables of interest, we take a look at possible confounding variables. One assumption the authors made when building their model is, that it is possible to directly control for factors that drive long-run trends in wholesale electricity prices in the CAISO market. Possible long-run patterns could be found in demand or supply of electricity. Fortunately, controlling for demand-driven trends is straightforward. This can be done by including the hourly CAISO load as a control. Due to that one automatically controls for weather-related shifts in demand, which could be correlated with renewable generation and shifts in distributed solar output. The last point is due to the fact that the measure of CAISO load is equal to the quantity demanded less behind-the-meter.


```{r eval=FALSE}
# Run for additional info in the Viewer pane
info("California generation by fuel")
```

The information box displays the supply side of California's power grid. Based on that we can think of possible supply-driven price trends. One such trend could be the increase in natural gas price, which is the primary fuel source used by California's thermal generators. To account for this, the authors suggest to include the daily Henry Hub spot price in the model. Another price trend associated with the supply side could be observed in the patterns of hydroelectric power output. Here we are facing the problem that hydroelectric generation could directly respond to renewable power output. Therefore, it is not possible to control for hydroelectric production itself. Thus, Bushnell and Novan suggest to use an uncorrelated proxy for the monthly hydroelectric potential. As proxy they suggest a measure of the aggregate, state-level precipitation over the preceding 12 months (Bushnell & Novan, 2021a, p. 772).

The only relevant nonrenewable fuel source left which could be assumed to be the reason for a supply-driven trend in wholesale price is nuclear.



Quiz: Do you think nuclear power plants are assumed to drive a supply-driven price trend?

(1) Yes
(2) Yes, but we already control for this trend
(3) I do not know
(4) No

```{r eval=FALSE}
# Run line to answer the quiz above
answer.quiz("supply-driven price trend")
```

You are right, nuclear power plants are not assumed to induce supply-driven price trends as their capacity is fixed over the period and no trends in the marginal cost of these generators are observed.

As we now thought about demand driven trends as well as supply driven ones, we assume that all major confounding variables are established. Therefore, we expect a model built using these control variables and the variables of interest to be unbiased by any spurious relationships during the observation period.

All in all, the above explanation leads to the following model. This model is used to estimate the impacts of renewable expansions on the wholesale power market. To determine the impact of utility-scale solar and wind production on the average real-time market price changes, the model is estimated separately for each hour of the day.

$$
P_{h,d} = \alpha_{h,m} + \underbrace{\beta^s_h \cdot \text{Solar} + \beta^w_h \cdot \text{Wind}}_{\text{key coefficients of interest}} + \beta^g_h \cdot \text{Gas price}_d + \beta^l_h \cdot \text{Load}_d + \beta^i_h \cdot \text{Inches lag}_d + \varepsilon_{h,d}
$$
The index $h$ represents the hour, the index $d$ the day and the index $m$ the month. Our key coefficients of interest are $\beta^w_h$ and $\beta^s_h$ in front of the wind ($\text{Wind}$) and solar ($\text{Solar}$) production. As described above we add the spot market price for natural gas ($\text{Gas price}_d$) , the load of the CAISO power market ($\text{Load}_d$) and the aggregate, state-level precipitation over the preceding 12 months ($\text{Inches lag}_d$)  as proxy for the hydroelectric potential to control for supply- and demand-driven longer-run price trends. To control for monthly price trends, monthly fixed effects ($\alpha_{h,m}$) are included. The dependent variable $P_{h,d}$ is the average hourly real-time market (RTM) price (in Dollar per MWh) in the CAISO market for hour $h$ of day $d$. 

To correct for heteroscedasticity and autocorrelation Newey-West standard errors with a 7-day lag (`lag = 7`) are reported. 

To obtain accurate results regarding the impact of wind and solar production on the real-time market price, it is crucial to assume that the renewable energy output varies exogenously with respect to the real-time market price. This assumption raises two potential concerns.

First, it could be possible that the renewable capacity is changing in response to changes in the energy market price. For example, higher electricity prices could be an incentive to invest in solar power plants with near zero variable costs. According to Bushnell and Novan (2021a, p. 772) this first concern can be neglected. Do you have a clue why they propose this neglection?



Quiz: Why do you think may Bushnell and Novan propose to neglect this first concern?

(1) because we already control for drivers of long-run changes in RTM prices
(2) because growth in renewable capacity was not mainly influenced by market forces
(3) both
(4) It is a trick question! It cannot be neglected

```{r eval=FALSE}
# Run line to answer the quiz above
answer.quiz("neglecting concern")
```

According to Bushnell and Novan this first concern can be neglected as we directly control for drivers of long-run changes in the wholesale market price and as the growth in renewable capacity over the observed period was mainly influenced by policies and not by market forces (2021a, p. 772).

The second concern regarding the exogeneity assumption however is potentially more difficult to overcome. This second threat comes with the fact that sometimes renewable energy production is curtailed. 


```{r eval=FALSE}
# Run for additional info in the Viewer pane
info("What is energy curtailment")
```

The timing of renewable energy curtailment is probably correlated with the RTM price. For example, if there is low energy demand, energy producers in the CAISO market could curtail solar or wind production to maintain the balance between supply and demand. In these times certainly the energy price is low. Therefore, this example shows how curtailment could be correlated with low energy prices.

Bushnell and Novan not really present a way to overcome this problem, but they propose and execute some robustness checks where they show that the influence of the potential bias introduced by this endogeneity is not meaningful to the estimates (2021a, p. 773).


## Exercise 3.2 -- Average change in hourly prices

In this exercise we replicate the first regression analysis Bushnell and Novan performed in their paper. Its aim is to estimate the effect of growing solar and wind capacity on real-time market (RTM) prices. As already mentioned in the exercise before Bushnell and Novan  use for their analysis daily aggregate prices to include non-contemporaneous effects (2021a, p. 768). As the consequences of using this form of variables is not straightforward, we will investigate this difference in more detail. To do so, we will perform two regressions and compare them. One using the hourly production variables as we did in the other exercises before and one using the daily production variables as Bushnell and Novan did in the paper. The model itself will stay unchanged except for these variables.

We start our analysis by preparing the dataset and setting up the two models.

As always, we have to reload the dataset at the beginning.

**Task** Just `check` the code chunk to reload the dataset.
```{r "11_1"}
dat = readRDS("Setting_Sun_dataset.RDS")
```

Since the regression model includes monthly fixed effects, we need to build dummy variables `m1-m12` for each month. The purpose of these variables is to indicate in which month of the year an observation is recorded. As they are dummy variables the entry can only be `1` if the observation is recorded in the specific month or `0` if it is not (Kennedy, 2008, p. 232).

As the creation of these dummies works by applying the same logic multiple times, it is useful to use a `for()` loop.


```{r eval=FALSE}
# Run for additional info in the Viewer pane
info("for() loops")
```

A second function we will use to create the dummies is `ifelse()`.


```{r eval=FALSE}
# Run for additional info in the Viewer pane
info("Conditional element selection with ifelse()")
```

Now let us create twelve dummies `m1-m12` using a `for()` loop and a `ifelse()` statement. As it is not straightforward to set variable names according to the variable of a loop, we go an unusual way using `!!paste(...) := ...`. This command allows us to force *R* to accept the dynamic definition of variable names.


```{r eval=FALSE}
# Run for additional info in the Viewer pane
info("Adding together different strings with paste()")
```

After creating the dummy variables, we take a look at the dataset to ensure that we have created the dummies correctly. Since the observations are sorted by date, the first six rows of the dataset are all covering the same month, making it difficult to verify the new dummies by just looking at these rows. To obtain a clearer picture of the resulting pattern, we will filter the observations to get a more vivid subset, before displaying some observations.  

**Task** Fill in the missing code to create dummy variables for the twelve months and to show a part of the resulting data frame.
```{r "11_8"}
library(dplyr)

#fill in the missing code to complete the task

for (m in ___) {
  dat = dat %>% 
  mutate(!!paste("m", toString(m), sep = "") := ifelse(month == ___, 1, 0))
}

dat %>% 
  filter(day == 1 & hour == 1) %>%
  select(year, month, day, hour, m1, m2, m3, m4, m5, m6, m7, m8, m9, m10, m11, m12) %>%
  head()

```

As expected, everything worked out well and the dummies really represent the corresponding month of observation.

After preparing the data, we can focus on the two different regression models. We begin by constructing the two regression formulas `formula_hourly` and `formula_daily`.

**Task** Just `check` the code chunk to create the regression formulas and to show them.
```{r "11_9"}
formula_m = paste("m", 1:12, sep = "", collapse = " + ")

model_hourly = "rtm_total ~ solar + wind + gas_price + load + inches_lag"
formula_hourly = paste(model_hourly, formula_m, sep = " + ")

model_daily = "rtm_total ~ daily_solar + daily_wind + gas_price + load + inches_lag"
formula_daily = paste(model_daily, formula_m, sep = " + ")


formula_hourly
formula_daily
```

Great, the formulas are as we need them. This means that we are now almost ready to perform the regressions. In contrast to the exercises earlier, we now not only want to analyse the observations of one specific hour but of all 24 hours of the day. Therefore, we perform for each hour an own regression. Besides that, this is another great opportunity to use a `for()`-loop. As it is not sensible anymore to compare the results using `stargazer()`, we create two empty data frames and save the results of interest there.

We start by initializing two solution data frames (`rtm_change_hourly` and `rtm_change_daily`). 

**Task** `Check` the code chunk to initialize the solution data frames. 
```{r "11_10"}
rtm_change_hourly = data.frame(
    hour = 1:24,
    beta_solar = NA,
    beta_wind = NA,
    beta_gas_price = NA,
    stddev_solar = NA,
    stddev_wind = NA,
    stddev_gas_price = NA
  )

rtm_change_daily = data.frame(
    hour = 1:24,
    beta_solar = NA,
    beta_wind = NA,
    beta_gas_price = NA,
    stddev_solar = NA,
    stddev_wind = NA,
    stddev_gas_price = NA
  )
```

Well, we can now perform the regression of the two models. Notice, that they are regressed for each hour of the day separately. The `for()` loop performs the regressions for each `h` value ranging from `1-24`. Each time we filter the dataset to match the criteria `hour == h`. After the regression, we save the estimated coefficient and Newey-West errors into the solution data frame. At the end, we inspect the now-filled data frames. Since the units of `solar` and `wind` are **MWh** while the units of `daily_solar` and `daily_wind` are **GWh** we multiplied the solutions of the hourly regressions to match the daily ones.

**Task** `Check` the code chunk to perform the OLS regressions and to view the solution data frames. 
```{r "11_11"}
library(sandwich)
library(stats)

for (h in 1:24){
  
  dat_filtered = filter(dat, hour == h)
  
  
  reg_hourly = lm(formula_hourly, data = dat_filtered)
  
  rtm_change_hourly[h, 2] = coef(reg_hourly)[2]
  rtm_change_hourly[h, 3] = coef(reg_hourly)[3]
  rtm_change_hourly[h, 4] = coef(reg_hourly)[4]
  
  nw_error = sqrt(diag(NeweyWest(reg_hourly, lag = 7, prewhite = FALSE)))
  rtm_change_hourly[h, 5] = nw_error[2]
  rtm_change_hourly[h, 6] = nw_error[3]
  rtm_change_hourly[h, 7] = nw_error[4]
  
  
  reg_daily = lm(formula_daily, data = dat_filtered)
  
  rtm_change_daily[h, 2] = coef(reg_daily)[2]
  rtm_change_daily[h, 3] = coef(reg_daily)[3]
  rtm_change_daily[h, 4] = coef(reg_daily)[4]
  
  nw_error = sqrt(diag(NeweyWest(reg_daily, lag = 7, prewhite = FALSE)))
  rtm_change_daily[h, 5] = nw_error[2]
  rtm_change_daily[h, 6] = nw_error[3]
  rtm_change_daily[h, 7] = nw_error[4]
}

#adjustment of the units
rtm_change_hourly_adj = rtm_change_hourly
rtm_change_hourly_adj[, 2:7] = 1000  *rtm_change_hourly_adj[, 2:7]

rtm_change_hourly_adj
rtm_change_daily
```

As you might see, it is not easy to compare the two solutions only using the tables. Therefore, we create a graphical representation of the results. We plot the results for the solar coefficients of both regressions together with their 95%-confident interval. To arrange the figures side by side, we use the `patchwork` library which allows us to combine plots. To see how this figure combination is done, take a look at the last line of the code chunk.

**Task** Just `check` the code chunk to plot the regression results.
```{r "11_12",fig.width=10.5}
library(ggplot2)
library(patchwork)

figure_hourly = ggplot(rtm_change_hourly_adj, aes(x = hour)) +
  geom_point(aes(y = beta_solar), color = "grey", size = 3) +
  geom_errorbar(aes(ymax = beta_solar +  2 * stddev_solar, ymin = beta_solar - 2 * stddev_solar), size = 0.5) +
  geom_hline(yintercept = 0, color = "black", size = 1.2, linetype = "solid")+
  labs(title = expression(paste("Change of avg. hourly price due to an \n additional GWh of solar production \n during the same hour")), x = "Hour", y = expression(paste("Change in avg. hourly price \n ($/MWh)"))) +
  scale_x_continuous(limits = c(1, 24), breaks = 1:24) +
  scale_y_continuous(limits = c(-10, 2), breaks = seq(-10, 2, 1)) +
  theme_classic()+
  theme(
    panel.grid.major.y = element_line(),
    panel.grid.minor = element_blank(),
    plot.margin = margin(1, 0, 0, 1, "cm")
  )

figure_daily = ggplot(rtm_change_daily, aes(x = hour)) +
  geom_point(aes(y = beta_solar), color = "grey", size = 3) +
  geom_errorbar(aes(ymax = beta_solar + 2 * stddev_solar, ymin = beta_solar - 2 * stddev_solar), size = 0.5) +
  geom_hline(yintercept = 0, color = "black", size = 1.2, linetype = "solid")+
  labs(title = expression(paste("Change of avg. hourly price due to an \n additional GWh of daily solar production")), x = "Hour", y = expression(paste("Change in avg. hourly price \n ($/MWh)"))) +
  scale_x_continuous(limits = c(1, 24), breaks = 1:24) +
  scale_y_continuous(limits = c(-0.75, 0.5), breaks = seq(-0.75, 0.5, 0.25)) +
  theme_classic()+
  theme(
    panel.grid.major.y = element_line(),
    panel.grid.minor = element_blank(),
    plot.margin = margin(1, 0, 0, 1, "cm")
  )

figure_hourly + figure_daily + plot_layout(ncol = 2)
```

Although the coefficients now have the same units, we can see that the two results differ a lot. Especially when comparing them quantitatively. On reflection, this circumstance does not seem surprising, as the two regressions also answer different economic questions due to the different variables used.

The regression using the **hourly** solar and wind generation variables (left picture) estimates the average effect of 1 additional GWh of production output on the price **in the same hours during which this additional output occurs (contemporaneous effect)**. This is the reason why the results for the solar coefficient are only sensible in hours with meaningful solar output. The figure above only shows results in hours where this is the case. We see that in the morning and evening hours, the confident intervals for the estimators already get wider.

In contrast, the regression using the **daily** solar and wind generation variables (right picture) estimates the average effect of 1 additional GWh of daily production output on the price **regardless of the specific hour of the day during which this additional output occurs (non-contemporaneous effect)**. This method allows additional solar and wind production to have a price effect independent of the production time and over more than one hour. We can clearly see this in the results of our regression, as the non-daylight hours also have sensible estimators for the solar coefficient. Since the authors Bushnell and Novan are interested in this non-contemporaneous effect of solar and wind, they used the daily aggregate variables in their analysis.

When comparing both results one can recognize a qualitative similarity during daylight hours. Both results show a reduction of the RTM price during these hours. For the hourly regression, this makes sense as the additional GWh of low marginal cost solar energy lowers the price of electricity in the market during this hour. The same argument holds for the daily regression. An additional GWh of daily production also tends to occur during daytime and reduces the price during this time. Quantitatively we can remark that the daytime effects estimated by the daily variables are smaller. Again, this makes sense as the effect of the additional GWh is not limited to the occurring hour but is distributed over all hours. When focusing on the morning, evening and night hours, there are two main differences between the two regression results. While the estimated effects obtained by the hourly regression are not sensible anymore in the early morning and late evening hours and even vanish during the night, the daily regression finds sensible coefficients for all hours. Especially during morning and evening hours a very interesting pattern emerges. In these hours an additional GWh of solar output leads to an **increase** in electricity price. A more detailed explanation of this pattern and possible reasons are discussed at the end of this and in the following exercise. 

To deepen your understanding of the regression results with daily variables, I want to show you how they can be understood as a weighted version of the hourly variable regression (at least during daylight hours).


### From hourly to daily regression results by weighting the results

In the following, we will see an intuitive explanation of how to understand the regression results using daily output variables as a weighted form of the hourly regression results. Although this only works for the daytime hours, it helps to gain a deeper understanding of the analysis method. The tricky question in this process is: Which weighting factors should be used?

But let us start at the beginning: The variables `daily_solar` and `daily_wind`, represent the sum of all hourly solar and wind outputs for a given day. Therefore, when using them we do not know at which hours the energy output has occurred. On the one hand, this allows us to estimate also non-contemporaneous effects of solar and wind, but on the other hand, it makes the understanding of the economic meaning of the regression result more difficult. This is due to the fact that the effect of 1 additional GWh daily energy production is distributed over all hours.

With this last fact in mind, we probably get a clue which factors are suitable for our purpose. Apparently, we need some information about the way how the price effect of additional daily production is distributed over the different hours. As we assume that this distribution is dependent on the time when the output is produced, there are two possible ways to determine sensible weighting factors. 

The first way is to simply calculate the average share hourly production has of daily production. The second way is to use the regression `solar ~ daily_solar` which estimates the effect of daily aggregated solar output on hourly solar output. This estimation is again performed for every hour of the day separately. The results of this regression can be interpreted as:

An increase of 1 GWh in the overall daily production of solar energy corresponds to a higher solar output of $\hat\beta$ MWh during hour `h`.

Simplified, the estimate indicates how much of the total daily production is accounted for by hourly production. We see that this is very similar to the simple calculation of the hourly share.

We now determine the weighting factors using both ways. Again, we will create an empty solution data frame and fill it with the results of the calculation and the regression. Finally, we will present and compare the results.

**Task** Run the following code chunk to perform the described steps.
```{r "11_13"}
#Initialize the solution data frame
hour_daily_df = data.frame(
    hour = 1:24,
    share = NA,
    beta_solar_daily = NA,
    stddev_solar_daily = NA
  )

#perform the regression
for (h in 1:24){
  reg_data = filter(dat, hour == h)
  reg = lm(solar ~ daily_solar, data = reg_data) #regression model
  hour_daily_df[h, 3] = coef(reg)[2]
  nw_error = sqrt(diag(NeweyWest(reg, lag = 7, prewhite = FALSE)))
  hour_daily_df[h ,4] = nw_error[2]
  
  #calculate the share
  hour_daily_df[h, 2] = mean(reg_data$solar) / mean(reg_data$daily_solar)
}

#view the results
hour_daily_df
```

The table shows that both methods produce quite similar results. The results consistently fall within the same order of magnitude. As one would expect the coefficients in the early morning and late evening hours as well as during the night are zero or near zero. During the daylight hours, they rise until they reach a peak at around midday or early afternoon and then fall again. Also not surprisingly, all meaningful coefficients are positive. This is due to the fact that a share cannot be negative and we would not expect hourly solar production to have a negative impact on daily solar production.

To confirm the statement that the regression performed with daily aggregated production output can be interpreted during the daylight hours as a weighted version of the hourly regression, we perform the multiplication of the hourly coefficients and the determined factors and then plot the solution together with the results of the regression directly performed with the aggregated output.

**Task** Just `check` the code chunk to perform the multiplications and plot the results.
```{r "11_14"}

#initialize the data frame where the multiplied coefficients are stored
multiply_df = data.frame(
    hour = 1:24,
    beta_solar_two_regressions = NA,
    beta_solar_share = NA)

for (h in 1:24){
  #multiply the coefficients of the two regressions
  multiply_df[h, 2] = rtm_change_hourly[h, 3] * hour_daily_df[h, 3]
  multiply_df[h, 3] = rtm_change_hourly[h, 3] * hour_daily_df[h, 2]
}

#plot the results of all three methods
ggplot(multiply_df, aes(x = hour)) +
  geom_line(aes(y = beta_solar_two_regressions, color = "regression weight"), size = 1) +
  geom_line(aes(y = beta_solar_share, color = "share weight"), size = 1) +
  geom_line(data = rtm_change_daily, aes(x = hour, y = beta_solar, color = "direct regression"), size = 1) +
  geom_hline(yintercept = 0, color = "black", size = 1.2, linetype = "solid")+
  labs(title = expression(paste("Change of avg. hourly price due to an \n additional GWh of daily solar production \n determined with three different methods")), x = "Hour", y = expression(paste("Change in avg. hourly price \n ($/MWh)")), colour = "") +
  scale_x_continuous(limits = c(1, 24), breaks = 1:24) +
  scale_y_continuous(limits = c(-0.9, 0.3), breaks = seq(-0.9, 0.3, 0.1))+
  scale_color_manual(values = c("red", "blue", "grey"))+
  theme_classic()+
  theme(
    panel.grid.major.y = element_line(),
    panel.grid.minor = element_blank(),
    plot.margin = margin(1, 0, 0, 1, "cm"),
    legend.position = "bottom"
  )
```

The plot shows the result of the direct regression as well as the two results achieved by the weighting approach:

- The **red** line represents the result from the direct regression where we regressed the daily production variables directly onto the hourly price.

- The **blue** line represents the result where we determined the weighting factors using the regression `solar ~ daily_solar`. 

- The **grey** line represents the result where we determined the weighting factors by calculating the average share each production hour has of the daily solar production. 

During the daylight hours, we see that the results of the weighting approach now get much closer to the estimations of the daily variable regression, although they are still not perfectly matching.

The great disadvantage of this two-step approach using weights is also visible in the figure: As the weights are all positive and only available during daytime, we are not able to produce sensible estimations for the effect of increasing solar in the morning, evening and night hours. That means that this method does not help to cover non-contemporaneous effects. 

 Therefore, we can conclude that for our purpose it is not sensible to focus on the regression with hourly production variables as the results we get do not match our research question. Therefore, in the following, we will focus on the regressions using daily aggregate variables. As we now set focus, we want to interpret the regression results achieved with the daily variables in more detail.


### Interpreting the average price changes in hourly RTM electricity price achieved by daily variable regression

To provide a detailed interpretation of the price changes obtained by the daily variable regression, we again plot the results and the corresponding confidence intervals of this regression.

**Task** Just `check` the code chunk to again display the results together with their 95% confidence intervals. The coefficients $\beta_h^s$ are the average change in the RTM price during hour `h` in response to a 1 GWh increase in daily solar production.
```{r "11_15"}
ggplot(rtm_change_daily, aes(x = hour)) +
  geom_point(aes(y = beta_solar), color = "grey", size = 3) +
  geom_errorbar(aes(ymax = beta_solar + 2 * stddev_solar, ymin = beta_solar - 2 * stddev_solar), size = 0.5) +
  geom_hline(yintercept = 0, color = "black", size = 1.2, linetype = "solid")+
  labs(title = expression(paste("Change of avg. hourly price due to an \n additional GWh of daily solar production")), x = "Hour", y = expression(paste("Change in avg. hourly price \n ($/MWh)"))) +
  scale_x_continuous(limits = c(1, 24), breaks = 1:24) +
  scale_y_continuous(limits = c(-0.8, 0.6), breaks = seq(-0.8, 0.6, 0.2))+
  theme_classic()+
  theme(panel.grid.major.y = element_line(),
        panel.grid.minor = element_blank(),
        plot.margin = margin(1, 0, 0, 1, "cm"))
```

The figure shows that from hour 9 until hour 16 increases in daily solar output result in a very strong reduction of the RTM price. These hours account for around 83% of all solar output during the day. As an example, during hour 13 at midday, the estimates suggest an average decrease in RTM price of around 0.39 \$/MWh for each additional GWh of daily solar energy production.

In contrast to the midday hours where we see decreasing price effects of daily solar, during morning and evening hours, our estimates show that increasing daily solar production has a positive price effect. If we take hour 19 for example, we estimate an increase in the RTM price caused by each additional GWh of solar output of around 0.30 \$/MWh.

Averaged over all hours, the estimates suggest that the average RTM price decreased by 0.10 \$/MWh in response to
a 1 GWh increase in daily solar production.

For comparison reasons, we extracted two further coefficients from our regression solutions: the coefficient associated with the daily wind energy production and the coefficient for the natural gas spot market price. As with the solar coefficients, we create figures to better interpret them.

But before we do that, I want to ask you a question:



Quiz: Do you have a clue how the estimated price effect for these two variables will look like?

(1) Both variables will have a positive effect on RTM prices.
(2) Both variables will have a negative effect on RTM prices.
(3) Daily wind will have a negative effect on RTM prices and the gas spot market price a positive one. 
(4) Daily wind will have a positive effect on RTM prices and the gas spot market price a negative one.
(5) Daily wind will have a similar effect on RTM prices as daily solar and the gas spot market price a positive one.
(6) Daily wind will have a similar effect on RTM prices as daily solar and the gas spot market price a negative one.

```{r eval=FALSE}
# Run line to answer the quiz above
answer.quiz("wind and gas_price price effect")
```

**Task** Just `check` the code chunk to create the plots of the coefficient for the daily wind energy output and the coefficient for the natural gas spot market price.
```{r "11_16"}
ggplot(rtm_change_daily, aes(x = hour)) +
  geom_point(aes(y = beta_wind), color = "grey", size = 3) +
  geom_errorbar(aes(ymax = beta_wind + 2 * stddev_wind, ymin = beta_wind - 2 *stddev_wind), size = 0.5) +
  geom_hline(yintercept = 0, color = "black", size = 1.2, linetype = "solid")+
  labs(title = expression(paste("Change of avg. hourly price due to an \n additional GWh of daily wind production")), x = "Hour", y = expression(paste("Change in avg. hourly price \n ($/MWh)"))) +
  scale_x_continuous(limits = c(1, 24), breaks = 1:24) +
  scale_y_continuous(limits = c(-0.6, 0.2), n.breaks = 8) +
  theme_classic() +
  theme(panel.grid.major.y = element_line(),
        panel.grid.minor = element_blank(),
        plot.margin = margin(1, 0, 0, 1, "cm"))

ggplot(rtm_change_daily, aes(x = hour)) +
  geom_point(aes(y = beta_gas_price), color = "grey", size = 3) +
  geom_errorbar(aes(ymax = beta_gas_price + 2 * stddev_gas_price, ymin = beta_gas_price - 2 * stddev_gas_price), size = 0.5) +
  labs(title = expression(paste("Change of avg. hourly price due to an \n increase in the Henry Hub natural gas market \n spot price of 1 $/MMBtu ")), x = "Hour", y = expression(paste("Change in avg. hourly price \n ($/MWh)"))) +
  scale_x_continuous(limits = c(1, 24), breaks = 1:24) +
  scale_y_continuous(limits = c(0, 16), breaks = seq(0, 16, 2)) +
  theme_classic() +
  theme(panel.grid.major.y = element_line(),
        panel.grid.minor = element_blank(),
        plot.margin = margin(1, 0, 0, 1, "cm"))
```

The effect of additional daily wind output is shown in the first figure and the effect of increasing natural gas market spot price is shown in the second figure.

The results shown in the first figure suggest that an increase of 1 GWh of daily wind production reduces the RTM price in nearly all hours. This matches our economic expectations, as wind energy does not have such regular and strong fluctuations as solar energy. In the afternoon hours the effect is slightly stronger and at hour 23 there is one hour where according to our regression the price is increased due to additional wind production.

The figure with the results for the effect of the natural gas spot market price also follows some naive expectations. Following our estimations a 1 \$/MMBtu increase in the Henry Hub spot price causes the RTM price to increase in all hours. 


```{r eval=FALSE}
# Run for additional info in the Viewer pane
info("The energy unit MMBtu")
```


During evening and morning hours, when high energy demand is present but solar production is reduced, the effect of increasing gas price is higher than in hours when solar energy is available or the energy demand is low. This pattern can be verified with the help of the fuel efficiencies of the working power plants. The fuel efficiency of natural gas units which varies by technology is measured by the heat rate. The **heat rate** gives the amount of fuel in MMBtu that is required to produce a MWh of electric energy (EIA, 2023b). 

During sunlight hours where solar energy is available or during night where the demand is low, we expect mainly the efficient gas power plants to produce electricity. These relatively fuel-efficient power plants are combined cycle natural gas units that have according to Bushnell and Novan heat rates of about 7 MMBtu/MWh (2021a, p. 775). Consequently, in these hours a 1 \$/MMBtu increase in the gas price would lead to a 7 \$/MWh increase in RTM price.

In contrast, during high-demand periods or when there is less solar energy available the lower fuel-efficient gas power plants are expected to be the marginal producers. These more inefficient power plants are often gas turbine units which have according to Bushnell and Novan heat rates of around 11 MMBtu/MWh (2021a, p. 775). That means that in these hours a 1 \$/MMBtu increase in the gas price would lead to a 11 \$/MWh increase in RTM price.

These expected price changes are more or less what we get as a result of our regression.


**Comparing the estimated results with the actual data:**

We can quantitatively evaluate the regression results by calculating the estimated total price effects from 2013 to 2016 in an example hour (`hour == 13`) and comparing it with the actual price differences.

To determine the total estimated price difference between 2013 and 2016 we first need to quantify the average values of the explaining variables (`daily_solar`, `daily_wind` and `gas_price`) in the different years.

**Task** Fill in the missing code fragments to quantify the average values of the explaining variables in the different years.
```{r "11_17"}
#determine the average values of the explaining variables in the different years
dat %>% 
  filter(year < 2017) %>% 
  group_by(___) %>% 
  ___(daily_solar_mean = round(mean(daily_solar), digits = 2),
      daily_wind_mean = round(mean(daily_wind), digits = 2),
      gas_price_mean = round(mean(gas_price), digits = 2))

```

After that, we need to calculate the total price effects according to our regression results. Therefore, we multiply the estimated coefficients ($\beta$) of hour 13 with the changes in the explaining variables between 2013 and 2016. 

**Task** Fill in the missing code fragments to calculate the average price effects.
```{r "11_18"}

#multiply the estimated betas with the difference between the average values of 2016 and 2013

#beta solar = -0.40
effect_solar = -0.40 * (___ - ___)
effect_solar

#beta wind = -0.22
effect_wind = -0.22 * (___ - ___)
effect_wind

#beta gas = 4.23
effect_gas = 4.23 * (___ - ___)
effect_gas

#total effect
effect_total = effect_solar + effect_wind + effect_gas
effect_total

```

We get the estimated price changes in hour 13 between 2013 and 2016 due to the three variables `daily_solar`, `daily_wind` and `gas_price`. As the results show, a major part of the total price effect was induced by the increase in daily solar production. 

To compare the estimated price change to the actual observed price change we first need to determine the average RTM price of hour 13 during the different years.

**Task** Fill in the missing code fragments to determine the average RTM price of hour 13 during the different years.
```{r "11_19"}

#determine the average prices of `hour == 13` in each year
dat %>% 
  filter(year < 2017) %>% 
  group_by(year, ___) %>% 
  summarize(price_mean = round(mean(rtm_total, na.rm = TRUE), digits = 2)) %>% 
  ___(hour == 13)
  

```

Finally, we can compute the RTM price change between the year 2013 and the year 2016.

**Task** Fill in the missing average prices to calculate the difference between the actual prices of the years 2013 and 2016.
```{r "11_20"}

#calculate the difference between the actual prices of the years 2013 and 2016
___ - ___

```

While our estimation suggests an average total RTM price change between 2013 and 2016 due to the three explaining variables of about -22.56 \$/MWh, the observations show an actual average total change of the RTM price between these years of about -18.7 \$/MWh. Therefore, we can conclude that our estimation results look like they would capture the major effects inducing RTM price changes. But we have to remark that here we only look at the effects due to increasing solar and wind production as well as the natural gas price. Therefore, the actual price change may not only be influenced by these three variables.

For comparison, when looking at another hour (for example hour 19) we can calculate an estimated total RTM price change of around -0.25 \$/MWh, while the actual price increase was around 1.1 \$/MWh. 


#! start_note "Calculation for hour == 19 (optional)"

```{r "11_21",optional=TRUE}

#determine the average values of the explaining variables  in the different years
dat %>% 
  filter(year < 2017) %>% 
  group_by(year) %>% 
  summarize(daily_solar_mean = round(mean(daily_solar), digits = 2),
            daily_wind_mean = round(mean(daily_wind), digits = 2),
            gas_price_mean = round(mean(gas_price), digits = 2))


#multiply the estimated betas with the difference between the average values in 2016 and 2013

#beta solar = 0.30
effect_solar = 0.30 * (56.8 - 15.1)
effect_solar

#beta wind = -0.07
effect_wind = -0.07 * (37.9 - 34.6)
effect_wind

#beta gas = 4.23
effect_gas = 10.27 * (2.51 - 3.73)
effect_gas

#total effect
effect_total = effect_solar + effect_wind + effect_gas
effect_total

#determine the average prices of `hour == 13` in each year
dat %>% 
  filter(year < 2017) %>% 
  group_by(year, hour) %>% 
  summarize(price_mean = round(mean(rtm_total, na.rm = TRUE), digits = 2)) %>% 
  filter(hour == 19)

#calculate the difference between the actual prices of the two years
50.6 - 49.5
```

#! end_note

All in all, our results show that daily solar production has a significant impact on the market price of electric energy. Specifically, during midday hours, increasing solar production leads to a decrease in the market price, while during morning and evening hours, it leads to an increase. The following exercise aims to explore the reasons behind this phenomenon by examining substitution patterns between renewables and conventional electric power sources.


## Exercise 3.3 -- Substitution between renewables and other sources

In this exercise, we try to understand the substitution patterns that emerge when daily solar production increases by 1 GWh. We first analyse the generation output of all major energy sources in the CAISO grid using an adjusted version of our existing model. Later, we will focus on fossil fuel power plants, especially natural gas power plants, to identify why daily solar production increases the wholesale market price of energy during certain hours.

As always, we start by reloading the dataset. Additionally, we again create the dummy variables for the different months.

**Task** Just `check` the code chunk to reload the dataset and create the dummies.
```{r "12_1"}
dat = readRDS("Setting_Sun_dataset.RDS")

library(dplyr)

#create dummy variables for the different months
for (m in 1:12) {
  dat = dat %>% 
  mutate(!!paste("m", toString(m), sep = "") := ifelse(month == m, 1, 0))
}
```

To get an overview of the major energy sources present in the CAISO market during our observation period we create a table that shows the average hourly energy supply of the main energy sources. This table includes thermal power plants (mainly natural gas), nuclear, large hydroelectric, net imports into the CAISO market, solar, wind and other renewables. Additionally, the table shows the standard deviations of the energy supplied by these sources. The energy output of the other renewables is calculated by subtracting the output of solar and wind from the total renewable output. The leftover renewable generation includes outputs from small-scale hydroelectric units, geothermal generators, biomass and biogas.

**Task** `Check` the code chunk to create the table of the average hourly energy outputs of the different energy sources.
```{r "12_2"}
dat = mutate(dat, resid_renewables = renewables - solar - wind)

tab = data.frame("Source" = c("Thermal",
                               "Nuclear",
                               "Large hydroelectric",
                               "Solar",
                               "Wind",
                               "Other Renewables",
                               "Net imports"),
                  
                  "Average Hourly Quantity Supplied (MWh)" = c(round(mean(dat$thermal, na.rm = TRUE)),
                                                               round(mean(dat$nuclear)),
                                                               round(mean(dat$large_hydro)),
                                                               round(mean(dat$solar)),
                                                               round(mean(dat$wind)),
                                                               round(mean(dat$resid_renewables, na.rm = TRUE)),
                                                               round(mean(dat$imports))),
                  
                  "SD (MWh)" = c(round(sd(dat$thermal, na.rm = TRUE)),
                                 round(sd(dat$nuclear)),
                                 round(sd(dat$large_hydro)),
                                 round(sd(dat$solar)),
                                 round(sd(dat$wind)),
                                 round(sd(dat$resid_renewables, na.rm = TRUE)),
                                 round(sd(dat$imports))),
                  check.names = FALSE)

library(knitr)
kable(tab)   #shows the table in a vivid style
```

The table shows that thermal power plants and imports into the CAISO market are by far the main energy sources present in the CAISO grid. Thermal power plants account for 44 % and net imports for 31 % of the load excluding solar and wind output. With the help of the standard deviations, we see that some energy sources, such as solar, wind and large hydro have highly fluctuating energy output.

To estimate the effect of increasing daily solar production on the energy production of other sources, a similar model as in the previous exercise is used. Only this time the dependent variable is the energy output of the specific sources instead of the RTM price. To determine how output from the various sources is affected during different hours of the day, we again estimate the model separately for each hour.

The code chunk below creates various regression models, each with a different dependent variable. These regression formulas are saved in a vector, which can be directly iterated over using a `for()` loop. Since the solution data frame is larger this time, we do not initialize the entire data frame at the start. Instead, we dynamically add the necessary columns for each iteration.

**Task** Just `check` the code chunk to perform the regressions for the effect of increasing daily solar onto the different energy sources.
```{r "12_3"}
library(stats)
library(sandwich)

#build the different models
formula_m = paste("m", 1:12, sep = "", collapse = " + ")

independent_variables = " ~ daily_solar + daily_wind + gas_price + load + inches_lag"

formula_rhs = paste(independent_variables, formula_m, sep = " + ")
dependent_variable = c("thermal",
                       "nuclear",
                       "large_hydro",
                       "imports",
                       "resid_renewables")

formulas = paste(dependent_variable, formula_rhs, sep = "")

#counting variable
i = 1

#initialize the solution data frame
output = data.frame(hour = 1:24)
  
#for-loop over all different formulas
for (formel in formulas) {
  
  #dynamically adapt the solution data frame
  output = mutate(output, !!paste("beta_solar", dependent_variable[i], sep = "_") := NA,
                          !!paste("stddev_solar", dependent_variable[i], sep = "_") := NA)
  
  #for-loop over the 24 hours
  for (h in 1:24) {
    reg = lm(formel, data = filter(dat, hour == h))
    output[h, 2 * i] = coef(reg)[2]
    nw_error = sqrt(diag(NeweyWest(reg, lag = 7, prewhite = FALSE)))
    output[h, 2 * i + 1] = nw_error[2]
  }
  i = i + 1
}
```

As the resulting table is not very vivid, we directly plot the results in a figure. Before using the `ggplot()` command in the code chunk below, I added some lines of code to define the style of the graphs combined, instead of separately in each `geom` command.

**Task** `Check` the code chunk to create a graphic that shows the results of the different regressions.
```{r "12_4",fig.width=10.5, fig.height=7}
#defining some styles
dotsize = 2
linesize = 0.5

library(ggplot2)

ggplot(output, aes(x = hour)) +
  geom_point(aes(y = beta_solar_thermal, color = "thermal"), size = dotsize) +
  geom_line(aes(y = beta_solar_thermal, color = "thermal"), size = linesize)+
  geom_point(aes(y = beta_solar_nuclear, color = "nuclear"), size = dotsize) +
  geom_line(aes(y = beta_solar_nuclear, color = "nuclear"), size = linesize)+
  geom_point(aes(y = beta_solar_large_hydro, color = "large hydro"), size = dotsize) +
  geom_line(aes(y = beta_solar_large_hydro, color = "large hydro"), size = linesize)+
  geom_point(aes(y = beta_solar_imports, color = "imports"), size = dotsize) +
  geom_line(aes(y = beta_solar_imports, color = "imports"), size = linesize)+
  geom_point(aes(y = beta_solar_resid_renewables, color = "other renewables"), size = dotsize) +
  geom_line(aes(y = beta_solar_resid_renewables, color = "other renewables"), size = linesize)+
  geom_hline(yintercept = 0, color = "black", size = 1.2, linetype = "solid")+
  scale_color_manual(values = c("red", "blue", "violet", "green", "black"))+
  labs(title = expression(paste("Average change in hourly generation due to an 1 GWh \n increase in solar production")), x = "Hour", y = expression(paste("Avg. change in hourly generation (MWh)")), color = "Energy Source:") +
  scale_x_continuous(limits = c(1, 24), breaks = 1:24) +
  scale_y_continuous(limits = c(-60, 20), breaks = seq(-60, 20, 10)) +
  theme_classic() +
  theme(panel.grid.major.y = element_line(),
        panel.grid.minor = element_blank(),
        legend.position = "bottom",
        plot.margin = margin(1, 0, 0, 0, "cm"))
```

The graph displays the estimated average change in hourly output per source for an additional GWh of daily solar production. The results shown in the graph suggest that the output from nuclear power plants and other renewable energy sources remains largely unaffected by an increase in daily solar production. Would you consider this behavior unusual or expected?



Quiz: Is the behavior of nuclear power and other renewables surprising?

(1) Yes, I think we expected other results.
(2) No, I think that is the result we expected. 

```{r eval=FALSE}
# Run line to answer the quiz above
answer.quiz("behavior of nuclear and other renewables")
```

It is true, that we expected such a behavior from these types of energy sources since they are relatively inexpensive (when considering variable costs) and are therefore not primarily replaced by solar energy.

For large hydro, we see that in the hours from 9 to 6, an additional GWh of daily solar corresponds with a decrease in energy output. However, in all other hours, we see a moderate increase in energy production from hydro power plants. That makes sense as it is easy and cheap to shift hydro production from hours with much cheaper solar production to hours without solar production. This is possible as hydro energy is storable for a certain amount of time.

When looking at the imports into the CAISO market, we see a similar pattern as for large hydro. But for the imports, the decrease during daytime is much stronger and the increase during night hours is smaller. Interestingly, it looks like imported energy is used to meet the early morning demand but not really the evening demand.

The last energy source we look at is thermal energy. There we see that according to our estimation thermal energy output is the most affected energy source. Our estimation suggests that increasing daily solar supply lowers the output of thermal energy at all hours. Again, mostly in the daytime hours but also at night. Only in the evening hours, the decrease is small. Probably this is why there is not such a great demand for additional imports there.

Summing over the estimated hourly betas of each source we get that 1 GWh of additional daily solar production corresponds to the effects that:

- thermal energy output is reduced by 640.38 MWh. 
- renewable energy output is reduced by 44.96 MWh.
- market imports into the CAISO market are reduced by 306.43 MWh.
- nuclear energy output is reduced by 33.83 MWh.
- large hydro energy output is increased by 26.62 MWh.

The total reduction amounts to 998.99 MWh, which is almost equivalent to the additional 1 GWh of solar power. As supply must match demand and the demand has not changed due to the additional solar, an extra GWh of daily solar power has to decrease the aggregated output of other sources by the same amount. This is an initial indication that our estimation may be sensible.

A second quick check which we can perform is to look at the night hours. As during the hours 20 to 6 there is no solar production the non-contemporaneous effect of the additional solar production over the different other sources has to add up to zero in each night hour.

**Task** `Check` the code chunk to perform this second quick check.
```{r "12_5"}
for (h in 1:24) {
  decrease = output %>%
    filter(hour == h) %>% 
    select(starts_with("beta_solar")) %>% 
    sum()
  
    print(paste("The total production decrease over all sources in hour ", h, " is ",  round(decrease, 2)))
}
```

We see that the reductions do not perfectly add up to zero during all individual night hours, but compared to the day hours they are not crucial. Therefore, we can also confirm our estimation based on this result.


### Why does solar increase prices during some hours?

The results so far provide a better understanding of the substitution pattern that emerges between all energy sources due to increasing solar energy. Probably some of you might already guess why increasing solar production increases the wholesale electricity prices in some hours. To confirm your guesses, we further explore how the composition of output supplied by conventional sources is affected by solar output.  Therefore, we focus on the main source of thermal energy namely natural gas power plants. In particular, we will take a look at the three dominant technologies used in these thermal power plants.

The table below shows some basic information about the three natural gas power plant technologies present in the CAISO market.

![](table_2_gas_power_plants.png)

Source: (Bushnell & Novan, 2021a, p. 779)

Based on the table, we can note that the majority of CAISO`s natural gas-powered electricity plants present during our observation period were **Combined Cycle Gas Turbines (CCGT)** or simple **Gas Turbines (GT)**. **Steam Turbines (ST)** only played a minor role in the market's supply. 

CCGT power plants have the lowest heat rate, meaning they require less natural gas to produce electricity compared to the other technologies. This makes them the most efficient natural gas power plants. Furthermore, they produce fewer CO2 and NOx emissions. However, despite these advantages, California does not solely rely on CCGT power plants due to their disadvantages. For our purposes, it is crucial to know that CCGT units have comparatively high fixed start-up costs, a slow increase in production and that they experience inefficiencies at low output levels.

Compared to that the power units relying on GT technology have a 38% higher heat rate causing them to be a lot more inefficient. They also emit more emissions. However, they have the advantage of being highly flexible, experiencing low starting costs and having the ability to reach full load in around 10 minutes. This makes them a good complement to the fluctuating output of renewable energy sources such as solar.

We will use the same regression model as before to analyze how the energy output of the three different gas turbine technologies is affected due to an increase in daily solar production. The hourly net load of the natural gas power plant types will be the dependent variable.

**Task** `Check` the code chunk to perform the same regression as before but this time with the net load of the natural gas power plant types as the dependent variable.
```{r "12_6"}
#build the different models
formula_m = paste("m", 1:12, sep = "", collapse = " + ")

independent_variables = " ~ daily_solar + daily_wind + gas_price + load + inches_lag"

formula_rhs = paste(independent_variables, formula_m, sep = " + ")
dependent_variable = c("net_load_ccgt_caiso",
                       "net_load_gt_caiso",
                       "net_load_st_caiso")

formulas = paste(dependent_variable, formula_rhs, sep = "")

#suffixes of the solution variables
name = c("ccgt",
         "gt",
         "st")

#counting variable
i = 1

#initialize the solution data frame
output = data.frame(hour = 1:24)
  
#for-loop over all different formulas
for (formel in formulas) {
  
  #dynamically adapt the solution data frame
  output = mutate(output, !!paste("beta_solar", name[i] , sep = "_") := NA,
                          !!paste("stddev_solar", name[i] , sep = "_") := NA)
  
  #for-loop over the 24 hours
  for (h in 1:24) {
    reg = lm(formel, data = filter(dat, hour == h))
    output[h, 2 * i] = coef(reg)[2]
    nw_error = sqrt(diag(NeweyWest(reg, lag = 7, prewhite = FALSE)))
    output[h, 2 * i + 1] = nw_error[2]
  }
  i = i + 1
}
```

Again, we directly plot the results before interpreting them.

**Task** `Check` the code chunk to create a figure showing the results from the regressions.
```{r "12_7"}
dotsize = 2
linesize = 0.5
color = c("blue","red","green")

ggplot(output, aes(x = hour)) +
  geom_point(aes(y = beta_solar_ccgt, color = "CCGT"), size = dotsize) +
  geom_line(aes(y = beta_solar_ccgt, color = "CCGT"), size = linesize)+
  geom_point(aes(y = beta_solar_gt, color = "GT"), size = dotsize) +
  geom_line(aes(y = beta_solar_gt, color = "GT"), size = linesize)+
  geom_point(aes(y = beta_solar_st, color = "ST"), size = dotsize) +
  geom_line(aes(y = beta_solar_st, color = "ST"), size = linesize)+
  geom_hline(yintercept = 0, color = "black", size = 1.2, linetype = "solid")+
  scale_color_manual(values = color)+
  labs(title = expression(paste("Average change in hourly generation due to an 1 GWh \n increase in solar production")), x = "Hour", y = expression(paste("Avg. change in hourly generation (MWh)")), color = "Technology:") +
  scale_x_continuous(limits = c(1, 24), breaks = 1:24) +
  scale_y_continuous(limits = c(-35, 15), breaks = seq(-35, 10, 5)) +
  theme_classic() +
   theme(panel.grid.major.y = element_line(),
         panel.grid.minor = element_blank(),
         legend.position = "bottom",
        plot.margin = margin(1, 0, 0, 0, "cm"))
```

The figure shows that based on our estimation, increasing daily solar energy changes the hourly generation of gas-powered energy units in very different ways. When first looking at CCGT units we see that they experience a very strong decrease during daylight hours, a lower decrease in the evening hours and small increases during night hours. Overall, their amount of generation reduces comparatively strong. 
Steam turbine units reduce their output just a little bit primarily during the evening hours.
The curve representing the changes in gas turbine generation due to increasing solar production shows some very different patterns than the other ones. Here we see that again generation is slightly decreased during daylight hours, but in contrast to the other curves during morning and evening hours we see a significant increase in production. Especially during the evening hours, the hourly generation rises by around 10 MWh due to increasing daily solar.

With this figure in mind, we can state that:

**The maximum peaks of the GT curve match the hours of increasing wholesale electricity prices. This supports the hypothesis that the increase in wholesale price is due to a change in the output composition of natural gas units.** 

Since we assume that the fuel costs account for the majority of the variable generation costs of natural gas power plants, the shift away from more
fuel-efficient CCGT production and toward less fuel-efficient GT plants may cause the observed increase in wholesale electricity price.

Finally, we have achieved our first major goal. We analyzed the effect increasing renewable production had during our observation period on hourly wholesale market prices of electricity. With our special analysis approach of also searching for non-contemporaneous effects, we found evidence for increasing prices during morning and evening hours. We also discovered substitution patterns that explain this non-contemporaneous price-increasing effect.

In the next chapter, we will leave the market prices behind and concentrate on the effect of increasing solar production on CO2 and NOx emissions.


## Exercise 4 -- Impacts on emissions

In this new chapter, we want to analyse how the growth of solar production affects emissions. Derby our focus will lie on carbon dioxide (CO2) and nitrogen oxides (NOx). The chapter follows the steps Bushnell and Novan conduct in their paper (Bushnell & Novan, 2021a, pp. 780-784). To identify the emission effect, we will use the same empirical approach as used to analyse the price effects of increasing renewable capacity on electricity prices. The model for the regression analysis may therefore look very familiar to you.

Before we can start with our regression analysis we have to talk about some potential issues when estimating the effect of increasing renewable production on emissions. Take a look back at the different energy sources present in the CAISO market. Can you identify which two energy sources might pose a challenge for our analysis depending the effect on emissions?



Quiz: Which energy sources might be a problem for our analysis?

(1) nuclear and the other renewables
(2) large hydro and imports 
(3) thermal and imports
(4) thermal and other renewables

```{r eval=FALSE}
# Run line to answer the quiz above
answer.quiz("problematic energy sources")
```

You are right, large hydro and the market net imports both may cause problems. 
For the market imports the problem that arises is, that as we saw earlier, increasing renewable production affects market imports. This effect leads to the problem that emission effects will probably occur both inside and outside of California.  Therefore, we also need to find sensible measures for the effect outside of California.
The second challenge we are dealing with concerns large hydro as the emission impact of hydro power will not be limited to the same day as the solar output. This is due to the property of large hydro that allows it to store energy for some time and therefore shift emissions over longer time periods.

To overcome these challenges, we will estimate the emission effect of increasing solar in two steps:

First, we will estimate the direct effect of growing solar generation on CO2 and NOx emissions using a similar regression model as in the exercises before. That means that the new dependent variables are the aggregate hourly CO2 emissions, `co2_caiso`, and the NOx emissions, `nox_caiso`, emitted by conventional power plants inside the CAISO market. This gives us the direct effect of 1 GWh of additional solar generation on emissions from CAISO generators only. Furthermore, this estimated effect is limited to the same day as the additional output occurs.

The second step will be to estimate the changes of increasing daily solar production on large hydro generation `large_hydro` and market imports `imports`. With these estimated changes in generation amounts, we try to quantify the effect imports have on emissions outside of California and the effect hydro power has on emissions during different time periods. For CO2 we do this by multiplying the determined change of energy output with the CO2 emission intensity the California Air Resources Board applies to unspecified imports into the CAISO market. This applied emission intensity is 0.428 tons of CO2 per MWh (California Air Resources Board, 2018, p. 60). As this is nearly the emission intensity of a combined cycle gas turbine, we also use their NOx emission rate of about 0.06 pounds of NOx per MWh. Bushnell and Novan suggest to use the same emission factors for large hydro generators as for market imports (2021a, pp. 780-781).

Two facts arise from the usage of these specific emission factors: 

1. The California Air Resources Board assumes that CCGT power plants are the marginal producers outside of California's electricity market.

2. Bushnell and Novan assume that emissions that are shifted due to storable hydro power are also emitted by CCGT power plants inside or outside of California (2021a, p. 781).

Following Bushnell and Novan we will perform regressions for hydro and imports separately and also summed up as `hydro_imports` = `large_hydro` + `imports`.
As we will later see, the emission effect of increasing daily solar varies between the different seasons.  Therefore, we will perform our analysis this time for each season separately. 

To start the analysis, we again have to import the dataset.

**Task** Just `check` the code chunk to reload the dataset.
```{r "13_1"}
dat = readRDS("Setting_Sun_dataset.RDS")
```

This time, as we perform the regression for each season separately, we create a column named `season` which contains numbers from `1-4` to classify the observations into the four different seasons. To do this, we need the command `mutate()` and a new dplyr-command called `case_when()`.


```{r eval=FALSE}
# Run for additional info in the Viewer pane
info("Vectorise multiple ifelse() statements with case_when()")
```

**Task:** Add a new column called `season` to the data frame stored in `dat` using the function `mutate()`. </br>
The new column should contain: </br>
`1` if `month <= 2 | month >= 12`</br>
`2` if `month >= 3 & month <= 5`</br>
`3` if `month >= 6 & month <= 8`</br>
`4` if `month >= 9 & month <= 11`</br>

You can use the command `case_when()` as the definition of the new column in the command `mutate`.
Save the new data frame again in `dat`. 

```{r "13_3"}
library(dplyr)
#classify the observations into seasons using mutate() and the command case_when().
#Tip: you do not need to define a default.

```

Perfect, as the data is now prepared, we can perform the regressions. Again, we have to use two `for()`- loops (one for the four seasons and one for the 24 hours) which are within each other.  Therefore, we have to perform four times as many regressions as without the seasonal splitting. This extends the computation time a lot. Additionally, Bushnell and Novan suggest to use a lag of 168 for the Newey-West in this regression, which extends the computation time even more.  Therefore, and due to the fact that all five regressions (with the dependent variables `co2_caiso`, `nox_caiso`, `large_hydro`, `imports` and `hydro_imorts`) work the same way only with changed dependent variable, we only perform one regression as an example and I will provide the other results.

Consequently, we only execute the regression with `co2_caiso` as the dependent variable. If you want to check if my provided data frames really contain the right results, you can replace the dependent variable with one of your choice, insert the commented line at the end to show the output and press `run chunk`. After that, you can load the other data frames and compare the result with the provided ones.

**Task** `Check` the code chunk to perform the regression for the CO2 emissions.
```{r "13_4"}
library(stats)
library(sandwich)

seasonal_change_co2 = data.frame(
  "hour" = 1:24,
  "beta_solar_winter" = NA,
  "beta_solar_std_winter" = NA,
  "beta_solar_spring" = NA,
  "beta_solar_std_spring" = NA,
  "beta_solar_summer" = NA,
  "beta_solar_std_summer" = NA,
  "beta_solar_fall" = NA,
  "beta_solar_std_fall" = NA)

for (m in 1:12) {
  dat = dat %>% 
  mutate(!!paste("m", toString(m), sep = "") := ifelse(month == m, 1, 0))
}

formula_m = paste("m", 1:12, sep = "", collapse = " + ")

independent_variables = " ~ daily_solar + daily_wind + gas_price + load + inches_lag"

formula_rhs = paste(independent_variables, formula_m, sep = " + ")
dependent_variable = "co2_caiso"

formula = paste(dependent_variable, formula_rhs, sep = "")

#for-loop over the seasons
for (s in 1:4) {
  dat_temp = filter(dat, season == s)

  #for-loop over the hours
  for (h in 1:24) {
    dat_reg = filter(dat_temp, hour == h)
    reg = lm(formula, data = dat_reg)
    nw = NeweyWest(reg, lag = 168, prewhite = FALSE)
    nw_error = sqrt(diag(nw))
  
    seasonal_change_co2[h, s * 2] = coef(reg)[2]
    seasonal_change_co2[h, s * 2 + 1] = nw_error[2]
  }
}

#seasonal_change_co2
```

The first data frame containing is now established. It contains the results of the estimated effect of increasing daily solar on CO2 emissions which are directly produced in California and during the day of the solar production.  As explained above, for simplicity we will not do the same for the other four regressions instead you load the other results directly from the provided data files.

**Task** Just `check` the code chunk to load the datasets containing the results for the other regressions.
```{r "13_5"}
seasonal_change_nox = readRDS("seasonal_change_nox.RDS")
seasonal_change_large_hydro = readRDS("seasonal_change_large_hydro.RDS")
seasonal_change_imports = readRDS("seasonal_change_imports.RDS")
seasonal_change_hydro_imports = readRDS("seasonal_change_hydro_imports.RDS")

#if you want to view one of the datasets just enter the name of the variable containing the data frame below this line and press `run chunk`

```

Let us first take a look at the results of the CO2 regression. Therefore, we plot the results of each season in an extra figure. Again, we use the `patchwork` library to arrange the plots. 

**Task** `Check` the code chunk to create the figure of the results from the CO2 regressions and display them.
```{r "13_6",fig.width=10.5, fig.height=7}
library(ggplot2)
library(patchwork)

figure_co2_a = ggplot(seasonal_change_co2, aes(x = hour)) +
  geom_point(aes(y = beta_solar_winter), color = "grey", size = 3) +
  geom_errorbar(aes(ymax = beta_solar_winter + 2 * beta_solar_std_winter, ymin = beta_solar_winter - 2 * beta_solar_std_winter), size = 0.5) +
  geom_hline(yintercept = 0, color = "black", size = 1.2, linetype = "solid")+
  labs(title = "Winter", x = "Hour", y = expression(paste("Avg. change in hourly CO2 (tons)"))) +
  scale_x_continuous(limits = c(1, 24), breaks = 1:24) +
  scale_y_continuous(limits = c(-50, 20), breaks = seq(-50, 20, 10)) +
  theme_classic() +
  theme(panel.grid.major.y = element_line(),
        panel.grid.minor = element_blank())

figure_co2_b = ggplot(seasonal_change_co2, aes(x = hour)) +
  geom_point(aes(y = beta_solar_spring), color = "grey", size = 3) +
  geom_errorbar(aes(ymax = beta_solar_spring + 2 * beta_solar_std_spring, ymin = beta_solar_spring - 2 * beta_solar_std_spring), size = 0.5) +
  geom_hline(yintercept = 0, color = "black", size = 1.2, linetype = "solid")+
  labs(title = "Spring", x = "Hour", y = expression(paste("Avg. change in hourly CO2 (tons)"))) +
  scale_x_continuous(limits = c(1, 24), breaks = 1:24) +
  scale_y_continuous(limits = c(-50, 20), breaks = seq(-50, 20, 10)) +
  theme_classic() +
  theme(panel.grid.major.y = element_line(),
        panel.grid.minor = element_blank())

figure_co2_c = ggplot(seasonal_change_co2, aes(x = hour)) +
  geom_point(aes(y = beta_solar_summer), color = "grey", size = 3) +
  geom_errorbar(aes(ymax = beta_solar_summer + 2 * beta_solar_std_summer, ymin = beta_solar_summer - 2 * beta_solar_std_summer), size = 0.5) +
  geom_hline(yintercept = 0, color = "black", size = 1.2, linetype = "solid")+
  labs(title = "Summer", x = "Hour", y = expression(paste("Avg. change in hourly CO2 (tons)"))) +
  scale_x_continuous(limits = c(1, 24), breaks = 1:24) +
  scale_y_continuous(limits = c(-50, 20), breaks = seq(-50, 20, 10)) +
  theme_classic() +
  theme(panel.grid.major.y = element_line(),
        panel.grid.minor = element_blank())

figure_co2_d = ggplot(seasonal_change_co2, aes(x = hour)) +
  geom_point(aes(y = beta_solar_fall), color = "grey", size = 3) +
  geom_errorbar(aes(ymax = beta_solar_fall + 2 * beta_solar_std_fall, ymin = beta_solar_fall - 2 * beta_solar_std_fall), size = 0.5) +
  geom_hline(yintercept = 0, color = "black", size = 1.2, linetype = "solid")+
  labs(title = "Fall", x = "Hour", y = expression(paste("Avg. change in hourly CO2 (tons)"))) +
  scale_x_continuous(limits = c(1, 24), breaks = 1:24) +
  scale_y_continuous(limits = c(-50, 20), breaks = seq(-50, 20, 10)) +
  theme_classic() +
  theme(panel.grid.major.y = element_line(),
        panel.grid.minor = element_blank())

figure_co2_a + figure_co2_b + figure_co2_c + figure_co2_d + plot_layout(ncol = 2, nrow = 2) + plot_annotation(title = "Change in CO2 emission due to a 1 GWh increase in daily solar production by season")

```

The figure displays the estimated average effect of 1 GWh of additional daily solar output on the emissions of CO2 from CAISO generators on the same day. Our estimation suggests that during summer and fall increasing daily solar generation causes meaningful reductions of CO2 emissions during the daytime, while during the night there is no significant effect visible. During winter months we see that according to the estimation, daily solar reduces emissions over all hours of the day. During daylight hours this effect is again slightly stronger. The spring months provide the most volatile pattern. Here daily solar generation lowers the CO2 emissions during the daylight hours and has no significant effect during the early morning hours. But in the evening hours, additional solar generation causes an increase in CO2 emissions.

After we have now looked at the results for the direct emission effect of increasing solar generation, we now want to focus on the emission leakage effects due to hydro plants and market imports. As described above we analyze substitution patterns of the variables `large_hydro`, `imports` and `hydro_imports`.

**Task** `Check` the code chunk to create the combined figure of the results from the substitution pattern regressions and display it.
```{r "13_7",fig.width=10.5, fig.height=7}
linesize = 1
color = c("blue","red","green")

figure_supply_seasonal_a =  ggplot() +
  geom_line(data = seasonal_change_large_hydro, aes(x = hour, y = beta_solar_winter, color = "Hydro"), size = linesize)+
  geom_line(data = seasonal_change_imports, aes(x = hour, y = beta_solar_winter, color = "Imports"), size = linesize)+
  geom_line(data = seasonal_change_hydro_imports, aes(x = hour, y = beta_solar_winter, color = "Hydro + Imports"), size = linesize)+
  geom_hline(yintercept = 0, color = "black", size = 1.2, linetype = "solid")+
  labs(title = "Winter", x = "Hour", y = expression(paste("Change in quantity supplied (MWh)")), color = "") +
  scale_color_manual(values = color)+
  scale_x_continuous(limits = c(1, 24), breaks = 1:24) +
  scale_y_continuous(limits = c(-60, 40), breaks = seq(-60, 40, 20)) +
  theme_classic() +
  theme(panel.grid.major.y = element_line(),
        panel.grid.minor = element_blank(),
        legend.position = "bottom")

figure_supply_seasonal_b =  ggplot() +
  geom_line(data = seasonal_change_large_hydro, aes(x = hour, y = beta_solar_spring, color = "Hydro"), size = linesize)+
  geom_line(data = seasonal_change_imports, aes(x = hour, y = beta_solar_spring, color = "Imports"), size = linesize)+
  geom_line(data = seasonal_change_hydro_imports, aes(x = hour, y = beta_solar_spring, color = "Hydro + Imports"), size = linesize)+
  geom_hline(yintercept = 0, color = "black", size = 1.2, linetype = "solid")+
  labs(title = "Spring", x = "Hour", y = expression(paste("Change in quantity supplied (MWh)")), color = "") +
  scale_color_manual(values = color)+
  scale_x_continuous(limits = c(1, 24), breaks = 1:24) +
  scale_y_continuous(limits = c(-60, 40), breaks = seq(-60, 40, 20)) +
  theme_classic() +
  theme(panel.grid.major.y = element_line(),
        panel.grid.minor = element_blank(),
        legend.position = "bottom")

figure_supply_seasonal_c =  ggplot() +
  geom_line(data = seasonal_change_large_hydro, aes(x = hour, y = beta_solar_summer, color = "Hydro"), size = linesize)+
  geom_line(data = seasonal_change_imports, aes(x = hour, y = beta_solar_summer, color = "Imports"), size = linesize)+
  geom_line(data = seasonal_change_hydro_imports, aes(x = hour, y = beta_solar_summer, color = "Hydro + Imports"), size = linesize)+
  geom_hline(yintercept = 0, color = "black", size = 1.2, linetype = "solid")+
  labs(title = "Summer", x = "Hour", y = expression(paste("Change in quantity supplied (MWh)")), color = "") +
  scale_color_manual(values = color)+
  scale_x_continuous(limits = c(1, 24), breaks = 1:24) +
  scale_y_continuous(limits = c(-60, 40), breaks = seq(-60 ,40 ,20)) +
  theme_classic() +
  theme(panel.grid.major.y = element_line(),
        panel.grid.minor = element_blank(),
        legend.position = "bottom")

figure_supply_seasonal_d =  ggplot() +
  geom_line(data = seasonal_change_large_hydro, aes(x = hour, y = beta_solar_fall, color = "Hydro"), size = linesize)+
  geom_line(data = seasonal_change_imports, aes(x = hour, y = beta_solar_fall, color = "Imports"), size = linesize)+
  geom_line(data = seasonal_change_hydro_imports, aes(x = hour, y = beta_solar_fall, color = "Hydro + Imports"), size = linesize)+
  geom_hline(yintercept = 0, color = "black", size = 1.2, linetype = "solid")+
  labs(title = "Fall", x = "Hour", y = expression(paste("Change in quantity supplied (MWh)")), color = "") +
  scale_color_manual(values = color)+
  scale_x_continuous(limits = c(1, 24), breaks = 1:24) +
  scale_y_continuous(limits = c(-60, 40), breaks = seq(-60, 40, 20)) +
  theme_classic() +
  theme(panel.grid.major.y = element_line(),
        panel.grid.minor = element_blank(),
        legend.position = "bottom")

figure_supply_seasonal_a + figure_supply_seasonal_b + figure_supply_seasonal_c + figure_supply_seasonal_d + plot_layout(ncol = 2, nrow = 2) + plot_annotation(title = "Change in supplied energy of different sources due to a 1 GWh increase in daily solar production by season")
```

The figure shows that during daylight hours increasing daily solar reduces the supply of hydro energy and market imports into the Californian market while in non daylight hours, the supply is increased. However, some noteworthy findings require attention. For instance, during winter and fall months, the total increase in supply during night hours exceeds the decrease during daylight hours. In contrast, during the spring and summer months, we observe the opposite. With the help of these substitution patterns, we can calculate the estimated emission leakage effect of growing solar capacities.

To get a more vivid result of the direct and the leakage emission effect of increasing daily solar, we take a look at the following table which sums over the hourly estimation results to get average daily emission effects. There the direct emission effect as well as the substitution effect and the therefrom calculated indirect effect for each season are presented. Following Bushnell and Novan, we also sum up the Newey-West errors of the results and reported the solution as aggregate errors (Bushnell & Novan, 2021a, p. 782).

As the code to create the table is not very handy and also not very educational, I just provide the established table.

**Task** `Check` the code chunk to load the table of the aggregate daily results of the emission effects of daily solar.
```{r "13_8"}
aggregate_change_emissions = readRDS("aggregate_change_emissions.RDS")
aggregate_change_emissions
```

In the first and the third row of the table, we see the daily effects of additional daily solar on CO2 and NOx emissions of CAISO generators on the same day (the direct effect). Again, the heterogeneity across seasons is visible. The next entries show the changes in daily quantity supplied by large hydro, imports and the combination of both. Here especially the row with the combination of both is interesting for us. We see that during winter and fall, when increasing daily solar reduces the largest amounts of CAISO generator's CO2, there is an increase in the supply of large hydro plants and market imports. In spring and summer, on the other hand, there is a decrease. This pattern results in positive leakage of emissions during winter and fall. Positive leakage means that CO2 and NOx emissions are increased on different days and/or in different markets. In spring and summer, we see the opposite: "negative leakage".

The predicted leakage reported in the table is calculated by multiplying the change in daily quantity supplied by "Hydro + Imports" with the emission intensity the California Air Resources Board applies to unspecified imports coming into California (0.428 tons of CO2 and 0.06 lbs of NOx per MWh). The predicted total change is simply the sum of the change in daily CAISO emissions plus the predicted leakage.

Based on the predicted total change we can acknowledge that 1 GWh of additional daily solar reduces the total daily emissions in all seasons. Especially the reduction of CO2 is in nearly all seasons around 300 tons, which is a lot. The reduction in NOx is much more dependent on the season. During winter, spring and fall the changes in NOx only vary between -41 lbs and -94 lbs. But when looking at the summer season, when the demand for electricity on the CAISO market is higher and emission-intensive gas turbines are more likely to be the marginal producers, additional daily solar reduces the NOx emission even more, causing an estimated -277 lbs change.

Summarizing, we saw that daily solar has a considerable on-time effect on emissions produced by generators inside the Californian market. Additionally, we saw an influence due to heterogeneous effects caused by market imports and storable hydroelectric energy on emissions emitted in neighboring states and/or at shifted times. With this gained knowledge of the emission effects of increasing daily solar generation, we end this chapter about emissions and go on to the next interesting question we want to investigate. 

The next big chapter focuses on contrafactual scenarios of available solar capacity and predictions of the impacts of contrafactual capacities on prices, operating times and profits of conventional generators. So, I would say it remains interesting and before I keep you in suspense, let us move straight on to the next chapter.


## Exercise 5 -- Impacts on operating profits (counterfactual scenarios)

This new chapter is dedicated to contrafactual scenarios which help us to explore the impacts renewable capacity expansions can have in the mid and long run. To do this we created an additional dataset containing contrafactual production capacities for the year 2016, which is the last full year available in the sample data. The chapter again directly follows the steps Bushnell and Novan conduct (Bushnell & Novan, 2021a, pp. 784-793).

In the first exercise, we will use this self-created contrafactual dataset together with the estimates of the price impacts already acquired in exercise 3 to predict how RTM prices would have differed assuming the contrafactual capacities. This gives us more concrete information about how capacity growth changes the RTM prices.

The second exercise then uses these predicted contrafactual prices to calculate the estimated running times and associated profits of conventional energy generators in the CAISO market. There we will gain a deeper understanding of the reasons behind possible substitution patterns between generation technologies. Furthermore, this will show some potential consequences for the emission intensities of the electricity market.

In the last exercise of this chapter, we explore the market values of additional renewable generation produced by capacity additions. We will find that with increasing capacity the marginal energy value of renewable capacity additions decreases.


### Structure

5.1 Counterfactual prices
 
5.2 Operating profit changes for conventional generators

5.3 Marginal energy value of renewable capacity additions


## Exercise 5.1 -- Counterfactual prices

The goal of this exercise is to predict contrafactual RTM prices in the CAISO market during 2016, assuming different amounts of solar and wind capacity. Before we start the actual predictions let us talk a few words about the fundamental concepts of our contrafactual approach. In chapter 3 we already talked about the model that explains the RTM price as a linear function of the daily solar and wind production as well as some other control variables:

$$
P_{h,d} = \alpha_{h,m} + \beta^s_h \cdot \text{Solar}_d + \beta^w_h \cdot \text{Wind}_d + \beta^g_h \cdot \text{Gas price}_d + \beta^l_h \cdot \text{Load}_d + \beta^i_h \cdot \text{Inches lag}_d + \varepsilon_{h,d}
$$

Although this model is clearly a simplification of the reality, we can use the same model to predict hourly RTM prices under contrafactual capacity scenarios.

We start by reestimating the model for each hour $h$ of the day and this time also for the four different seasons $q$ to capture potential heterogeneous seasonal impacts of renewable generation on hourly prices. With this estimation, we get the estimated hourly and seasonal effects of all variables present in the model ($\hat\alpha_{h,m}$, $\hat\beta_{h,q}^s$, $\hat\beta_{h,q}^w$, $\hat\beta_{h,q}^g$, $\hat\beta_{h,q}^l$, $\hat\beta_{h,q}^i$) as well as the observed residuals ($\hat\varepsilon_{h,d}$). Assuming that the control variables are not causally affected by solar and wind production we can predict the counterfactual hourly RTM price ($\tilde{P}_{h,d}$) given counterfactual solar generation ($\widetilde{Solar_d}$) like:

$$
\tilde{P}_{h,d} = \hat\alpha_{h,m} + \hat\beta^s_{h,q} \cdot \widetilde{\text{Solar}}_d + \hat\beta^w_{h,q} \cdot \text{Wind}_d + \hat\beta^g_{h,q} \cdot \text{Gas price}_d + \hat\beta^l_{h,q} \cdot \text{Load}_d + \hat\beta^i_{h,q} \cdot \text{Inches lag}_d + \hat\varepsilon_{h,d}
$$
When predicting the contrafactual RTM price with this formula we assume that all other independent variables except for the counterfactual solar generation remain unchanged. This is the reason why the assumption of no causality is important. A second assumption is that also the distribution of the error term is independent of the daily solar and wind output. The prediction of contrafactual wind capacities works the same way only using contrafactual wind ($\widetilde{Wind_d}$) instead of solar generation. 

Before we start the prediction, we want to answer the question of how to choose and determine the contrafactual levels of energy production. Thinking about contrafactual solar **capacities**, is it easier/more sensible to focus on capacities greater or smaller than the actual ones or is there no clear answer?



Quiz: Is it easier/more sensible to focus on capacities greater or smaller than the actual ones or is there no clear answer?

(1) greater capacities than the observed ones
(2) smaller capacities than the observed ones
(3) it does not matter

```{r eval=FALSE}
# Run line to answer the quiz above
answer.quiz("question of capacity")
```

You are right, it is more useful to focus on smaller capacities than the observed ones. This is because otherwise the amount of generated energy would be greater than the actual one and we would need to extrapolate the estimations of the model over the observed support.  Therefore, we follow Bushnell and Novan and assume contrafactual solar capacities during 2016 of 2 GW, 6 GW and 10 GW (2021a, p. 786). The same argument holds for the wind capacities. There we assume 1 GW, 3 GW and 6 GW of contrafactual capacities in 2016 (Bushnell & Novan, 2021a, p. 786). As the procedure of predicting the price for contrafactual capacities for solar and wind works the same way, we will again only perform the steps for solar but also discuss the later provided solutions for wind.

So let us start to create the contrafactual datasets.
As always, we first need to reload the dataset and this time, we already perform the classification of the observations into seasons and the creation of monthly dummy variables.

**Task** `Check` the code chunk to reload the data and perform the classification into seasons and the creation of monthly dummy variables.
```{r "15_1"}
dat = readRDS("Setting_Sun_dataset.RDS")

library(dplyr)

dat = mutate(dat, season = case_when(
     month <= 2 | month >= 12 ~ 1,    
     month >= 3 & month <= 5 ~ 2,
     month >= 6 & month <= 8 ~ 3,
     month >= 9 & month <= 11 ~ 4))

for (m in 1:12) {
  dat = dat %>% 
  mutate(!!paste("m", toString(m), sep = "") := ifelse(month == m, 1, 0))
}
```

Well, to create the contrafactual solar generation based on contrafactual capacities we first need to determine the hourly solar potential for the three different contrafactual solar capacities. We achieve this by determining a factor `solar_cap_factor` for each observation that is based on the actual data of 2016. When multiplying this factor with the contrafactual capacity we should get the contrafactual potential.

Your task is now to build a formula that leads to the needed unitless factor. You will need the actual daily solar potential (`solar_potential`) which is the daily CAISO solar generation plus the curtailed solar energy in GWh and the actual solar capacity (`solar_cap`) installed in the CAISO market given in MW.

Hint: Think about the units.

**Task** Fill in the missing code to achieve a formula for a factor that when multiplied with the contrafactual capacity gives the contrafactual potential.
```{r "15_2"}
dat = mutate(dat,
  solar_cap_factor = ___ / (___ * solar_cap / ___))

```

Perfect, as we now have the solar capacity factor, we can create the contrafactual samples. Since our goal is to create one data frame containing all data (the actual data and the three contrafactual samples), we copy the original data frame containing the actual data three times and then adjust the copies to the new contrafactual solar potential. After that, we bind the three adjusted datasets to the original one. To distinguish between the different samples, we add a new column that holds an identifier for each sample.

Notice, that we use a reorganized form of the formula above to calculate the contrafactual solar potentials.

**Task** `Check` the code chunk to create a data frame `dat_all` that contains the actual as well as the contrafactual data samples. To get a feeling of how much data we are working with, use `NROW()` to view the number of rows.
```{r "15_3"}
dat_actual = dat %>% 
  mutate(solar_sample = "actual")

dat_2k = dat %>% 
  mutate(solar_potential = solar_cap_factor * 2000 * (24 / 1000),
         solar_sample = "solar_2k")

dat_6k = dat %>% 
  mutate(solar_potential = solar_cap_factor * 6000 * (24 / 1000),
         solar_sample = "solar_6k")

dat_10k = dat %>% 
  mutate(solar_potential = solar_cap_factor * 10000 * (24 / 1000),
         solar_sample = "solar_10k")

dat_all = rbind(dat_actual, dat_2k, dat_6k, dat_10k)

NROW(dat_all)
```

As you can see the new data frame has over 150 000 observations. Thankfully, we have a powerful statistics program like *R* that helps us to deal with such amounts of data.

Probably you wonder why we calculate the daily solar potential and not directly the daily generation. Theoretically, we could have determined a factor $\frac{daily\_solar}{solar\_cap}$ using the actual data and then just multiply this factor with the contrafactual capacities. The problem with this approach would be that this would assume that the amount of energy curtailment is independent of the installed generating capacity. Obviously, this is not the case.  Therefore, we have to predict the contrafactual solar curtailment to get the contrafactual daily solar generation. Notice, that $daily\_solar = solar\_potential-solar\_curtailment$.

This leads us to our next step: to predict the daily solar curtailment based on the contrafactual capacities. Following Bushnell and Novan we predict the daily solar curtailment with the following tobit model (2021b, p. 7):

$$
\text{Curtailment}^*_d = \alpha_m + \beta_1 \cdot \text{Potential}^{solar}_d + \beta_2 \cdot \text{Potential}^{solar}_d \cdot \text{Load}_d + \beta_3 \cdot \text{Wind}_d + \beta_4 \cdot \text{Gas price}_d + \beta_5 \cdot \text{Load}_d + \beta_6 \cdot\text{Inches lag}_d + \varepsilon_d
$$


```{r eval=FALSE}
# Run for additional info in the Viewer pane
info("Tobit-regression")
```

We use a Tobit regression as the curtailment naturally has to be grater or equal to zero and therefore has a lower boundary there. Also, when predicting $\text{Curtailment}^*_d$ using the results from the Tobit regression we have to check if some predictions are below zero and then adjust them. With the above regression formula we assume the daily solar energy curtailment $\text{Curtailment}^*_d$ to be dependent on some monthly fixed effects $\alpha_m$ the daily solar potential $\text{Potential}^{solar}_d$, an interaction term between the daily solar potential and the daily load $\text{Load}_d$ as well as some controls namely the daily wind generation $\text{Wind}_d$, the Henry Hub natural gas market spot price $\text{Gas price}_d$, the daily CAISO load itself $\text{Load}_d$, and the lagged measure of precipitation $\text{Inches lag}_d$.

Again, to prepare for the prediction of the curtailment levels for the contrafactual solar potentials we need to estimate the model to get the coefficients $\hat\beta_j$. We first calculate the interaction between `solar_potential` and `daily_load` and call this new variable `solar_load`. After that, we define the regression model and then use the function `tobit ()` of the package `AER` to estimate the model. You can see that we set the argument `left` to zero to define that the described variable is censored to the left by zero. At the end, we want to view the results of the regression.

**Task** Fill in the missing code to receive the above-described functionality.
```{r "15_4"}
#fill in the missing code to complete the task

library(___)

dat_all = dat_all %>% 
  mutate(solar_load = solar_potential ___ daily_load)

formula_m = paste("m", 1:12, sep = "", collapse = " + ")
formula = formula(paste("solar_curtailed ~ solar_potential + solar_load + daily_wind + gas_price + daily_load + inches_lag +", formula_m))

reg = ___(formula, left = 0, data = filter(dat_all, hour == 12 & solar_sample == "actual"))

reg

```

Focusing on the estimated coefficients of `solar_potential` and `solar_load` we see that solar curtailment increases on days with a high level of solar potential and low daily load. For example, on a day with a daily load of 583 GWh ($25^{\text{th}}$ percentile of daily load during the observation period) an increase in the solar potential of 1 GWh results in a predicted increase in solar curtailment of around 0.036 GWh ($0.205 + (-0.00029)\cdot 583 = 0.036$). Compared with a day with a daily load of 678 GWh ($75^{\text{th}}$ percentile of daily load during the observation period) we see that an additional GWh of daily solar potential only increases the predicted curtailment by 0.0084 GWh ($0.205 + (-0.00029)\cdot 678 = 0.0084$).

Using these estimates, we can predict the contrafactual curtailments in a first step and in a second step the contrafactual daily solar outputs. Notice, that we correct the fitted curtailments so that they are limited on the left to zero. In the code chunk below we used base *R* to add and edit the new column `solar_curtailed_fitted`. We do this because in the use case below it is easier and better to read. 

**Task** Just `check` the code chunk to predict the contractual curtailments and to calculate the resulting daily solar outputs.
```{r "15_5"}
library(stats)

dat_all$solar_curtailed_fitted = NA
dat_all$solar_curtailed_fitted =  predict(reg, newdata = dat_all)
dat_all$solar_curtailed_fitted[dat_all$solar_curtailed_fitted < 0 | is.na(dat_all$solar_curtailed_fitted)] = 0

dat_all = dat_all %>% 
  mutate(daily_solar = ifelse(solar_sample != "actual", solar_potential - solar_curtailed_fitted, daily_solar))
```

To get a feeling of the predicted contrafactual daily solar generations we create a figure that shows the three contrafactual generations and the actual generation in one plot. As we will focus on the year 2016, we also filter the data for this year.

**Task** Just `check` the code chunk to generate a figure of the contrafactual and the actual daily solar generation during the year 2016.
```{r "15_6",fig.width=10.5, fig.height=7}
linesize = 1
color = c("blue","red","green", "orange")

dat_plot = dat_all %>% 
  filter(year == 2016) %>% 
  select(julian, daily_solar, solar_sample) %>% 
  arrange(julian) %>%
  mutate(day = as.Date(julian, origin = as.Date("1960-01-01")))

ggplot() +
  geom_line(data = filter(dat_plot, solar_sample == "actual"), aes(x = day, y = daily_solar, color = "actual"), size = linesize)+
  geom_line(data = filter(dat_plot, solar_sample == "solar_2k"), aes(x = day, y = daily_solar, color = "solar_2k"), size = linesize)+
  geom_line(data = filter(dat_plot, solar_sample == "solar_6k"), aes(x = day, y = daily_solar, color = "solar_6k"), size = linesize)+
  geom_line(data = filter(dat_plot, solar_sample == "solar_10k"), aes(x = day, y = daily_solar, color = "solar_10k"), size = linesize)+
  labs(title = "Contrafacutal and actual daily solar generation in 2016", x = "Date", y = expression(paste("Daily solar generation (GWh)")), color = "") +
  scale_color_manual(breaks = c("actual", "solar_2k", "solar_6k", "solar_10k"), values = color)+
  theme_classic() +
  theme(panel.grid.major.y = element_line(),
        panel.grid.minor = element_blank(),
        legend.position = "bottom")
```

As expected, we see that scenarios with higher solar capacity lead to significantly higher solar generations. Probably some of you wonder why we see a higher solar generation in the `solar_10k` sample than in the `actual` one, although we argued that we chose the contractual capacities to be within the available observational support. The reason for this is that the capacity during 2016 was indeed lower than in the `solar_10k` sample. But the total available observation period goes until May 2017 and in 2017 we see greater capacities than in the contrafactual scenario which means that we also have the supportive data for this amount of capacity.

Well, now it is time to predict the actual prices.  Therefore, we first add new empty columns to the data frame which later hold the fitted RTM price `rtm_fitted`, as well as the estimated residuals `resid`. After that, we reestimate the model describing the prices to determine the coefficients needed for prediction. We execute this for every season and every hour separately to capture the potentially heterogeneous seasonal impacts of renewable generation on hourly prices. After estimating the model with the "actual" dataset we predict the RTM price for all other scenarios. To do this, we use the command `predict()` that needs the results of an estimation (in our case `reg`) and a data frame containing all necessary data as arguments. Additionally, to the price predictions itself, we also save the estimated residuals. As these residuals are only available for the dataset on which the regression is performed and we assumed that they are not affected by increasing solar, we just copy them for all scenario samples. Notice that we again use base *R* style to select the rows in which we save the predictions or the residuals.

**Task** `Check` the code chunk to perform the prediction of the contrafactual RTM prices and to save them in newly created columns in the data frame.
```{r "15_7"}

#add empty coumns
dat_all = dat_all %>%
  mutate(rtm_fitted = NA,
         resid = NA)

#define model
formula = "rtm_total ~ daily_solar + daily_wind + gas_price + load + inches_lag"

#for-loop over the seasons
for (s in 1:4) {
  dat_temp = filter(dat_all, season == s) #filter data by season

  #for-loop over the hours
  for (h in 1:24) {
    dat_reg = filter(dat_temp, hour == h & solar_sample == "actual")  #filter data by hour
    reg = lm(formula, data = dat_reg) #regress model

    filter1 = dat_all$season == s & dat_all$hour == h
    dat_all[filter1,]$rtm_fitted = predict(reg, newdata = filter(dat_all, season == s & hour == h)) #predict prices
    
    filter2 = filter1 & dat_all$solar_sample == "actual" & !is.na(dat_all$rtm_total)
    dat_all[filter2,]$resid = residuals(reg)  #save actual residuals
  }
}

#copy actual residuals to all other scenarios
dat_all[dat_all$solar_sample == "solar_2k",]$resid = dat_all[dat_all$solar_sample == "actual",]$resid
dat_all[dat_all$solar_sample == "solar_6k",]$resid = dat_all[dat_all$solar_sample == "actual",]$resid
dat_all[dat_all$solar_sample == "solar_10k",]$resid = dat_all[dat_all$solar_sample == "actual",]$resid

dat_all = dat_all %>%
  mutate(rtm_hat = rtm_fitted + resid)
```

Great, we have the fitted prices for all scenarios. To follow the prediction model described at the beginning of the exercise we add the residuals `resid`to the fitted RTM price `rtm_fitted` to get our final predicted RTM price stored in the column `rtm_hat`.

As in the exercises before we want to determine average hourly results (in this case the average hourly RTM price). We achieve this by regressing the predicted price `rtm_hat` onto some newly created hourly dummies. This procedure is repeated for all different solar samples and the results are stored in a data frame called `avg_price_solar`. Since our year of interest is still 2016, we filter our data to match this year.

**Task** `Check` the code chunk to determine the average hourly prices during 2016 for all different scenarios and to save them into a data frame called `avg_price_solar`.
```{r "15_8"}
dat_all_2016 = dat_all %>% 
  filter(year == 2016)
  
for (h in 1:24) {
  dat_all_2016 = dat_all_2016 %>% 
    mutate(!!paste("h_", toString(h), sep = "") := ifelse(hour == h, 1, 0))
}

formel_hour = paste("h_", 1:24, sep = "", collapse = " + ")

formel = formula(paste("rtm_hat ~ ",formel_hour, "+ 0"))
beta_actual = coef(lm(formel, data = filter(dat_all_2016, solar_sample == "actual" )))
beta_2k = coef(lm(formel, data = filter(dat_all_2016, solar_sample == "solar_2k")))
beta_6k = coef(lm(formel, data = filter(dat_all_2016, solar_sample == "solar_6k" )))
beta_10k = coef(lm(formel, data = filter(dat_all_2016, solar_sample == "solar_10k" )))

avg_price_solar = data.frame(
  hour = 1:24,
  actual = beta_actual,
  solar_2k = beta_2k,
  solar_6k = beta_6k,
  solar_10k = beta_10k)

rownames(avg_price_solar) = NULL
```

Before we take a look at the results by creating a figure, we now import the results for the contrafactual wind scenarios. 

**Task** `Check` the code chunk to load the data frame `avg_price_wind` containing the contrafactual prices for contrafactual wind scenarios.
```{r "15_9"}
avg_price_wind = readRDS("avg_price_wind.RDS")
```

To get a vivid look at the different results we create two figures containing the average hourly RTM prices. The first figure shows the contrafactual solar scenarios and the second one the contrafactual wind scenarios. To get a better feeling of the results we also plot the actual observed average hourly prices.

**Task** Just `check` the code chunk to create the figures containing the average hourly RTM price.
```{r "15_10",fig.width=10.5, fig.height=7}
library(ggplot2)
library(patchwork)

linesize = 1
color = c("blue","red","green", "orange")

figure_solar_contra = ggplot(avg_price_solar, aes(x = hour)) +
  geom_line(aes(y = actual, color = "actual"), size = linesize)+
  geom_line(aes(y = solar_2k, color = "2 GW"), size = linesize)+
  geom_line(aes(y = solar_6k, color = "6 GW"), size = linesize)+
  geom_line(aes(y = solar_10k, color = "10 GW"), size = linesize)+
  labs(title = "Contrafactual solar capacities", x = "Hour", y = expression(paste("Avg. hourly price ($/MWh)")), color = "Capacity Scenario:") +
  scale_color_manual(breaks = c("actual", "2 GW", "6 GW", "10 GW"), values = color) +
  scale_x_continuous(limits = c(1, 24), breaks = 1:24) +
  scale_y_continuous(limits = c(0, 60), breaks = seq(0, 60, 10)) +
  theme_classic() +
  theme(panel.grid.major.y = element_line(),
        panel.grid.minor = element_blank(),
        legend.position = "bottom")

figure_wind_contra = ggplot(avg_price_wind, aes(x = hour)) +
  geom_line(aes(y = actual, color = "actual"), size = linesize)+
  geom_line(aes(y = wind_1k, color = "1 GW"), size = linesize)+
  geom_line(aes(y = wind_3k, color = "3 GW"), size = linesize)+
  geom_line(aes(y = wind_6k, color = "6 GW"), size = linesize)+
  labs(title = "Contrafactual wind capacities", x = "Hour", y = expression(paste("Avg. hourly price ($/MWh)")), color = "Capacity Scenario:") +
  scale_color_manual(breaks = c("actual", "1 GW", "3 GW", "6 GW"), values = color) +
  scale_x_continuous(limits = c(1, 24), breaks = 1:24) +
  scale_y_continuous(limits = c(0, 70), breaks = seq(0, 70, 10)) +
  theme_classic() +
  theme(panel.grid.major.y = element_line(),
        panel.grid.minor = element_blank(),
        legend.position = "bottom")

figure_solar_contra + figure_wind_contra + plot_layout(nrow = 2) + plot_annotation(title = "Average hourly RTM price due to contrafactual solar and wind capacities")
```

First focusing on the figure containing the resulting average hourly price due to contractual solar capacities, we see that our estimation suggests that increasing solar capacity has significant price impacts during daylight hours. Comparing the scenario with a capacity of 2 GW to the scenario with 10 GW we see an estimated price change of about 25 $/MW during the midday hours. Additionally, we see that increasing solar capacity leads to a sharp rise in the RTM price during the evening hours and a small growth during the morning hours. However, during the night hours, we see no significant effect of additional solar capacity. All of these findings are in line with the results discussed in the previous exercises 3.2 and 3.3. Looking at the graph representing the actual solar capacity we can conclude that the actual average capacity during 2016 has to be located between 6 GW and 10 GW (actually 8.1 GW).

When looking at the figure containing the resulting average hourly price due to contractual wind capacities, we see that increasing wind capacity lowers the price in all hours. The only difference between the scenarios is, that during afternoon hours the price decrease is a little bit stronger when more wind capacity is available. Again, looking at the line representing the actual wind capacity, we can conclude that the actual average capacity during 2016 was around 6 GW (actually 5.7 GW).

As a consequence of the results, we can state that short and medium-term energy storage would be a great complementary technology for increasing renewable generation. With such storage facilities, it would be possible to shift energy supply from hours with oversupply and therefore low energy prices to hours with less renewable supply and higher prices. Additionally, we have seen that especially increasing solar capacity leads to a higher spread of RTM price maximum and minimum over the day. This spread is the basis on which energy storage facilities earn their profits. Therefore, increasing solar capacity helps storage facilities to operate profitably.

Overall, the results elaborated in this chapter match our economic understanding already established in the exercises 3.2 and 3.3.  Therefore, we can conclude that our findings are probably a sensible reflection of the econometric forces inside the CAISO market.

Interestingly, although we find qualitatively similar results as Bushnell and Novan do, quantitatively the results do not match exactly (Bushnell & Novan, 2021c, Counterfactual.xlsx). One explanation for this could be that *R* uses some functions a little bit differently than *stata* does, but there are also some indications that Bushnell and Novan probably used not exactly the dataset they later provided. For example, when looking at their *stata* code it looks like they work with a dataset containing slightly more observations (Bushnell & Novan, 2021c, Setting_Sun_do_file.do).

The next exercise will use the prices predicted in this exercise to estimate possible changes in generation times and consequently in operating profits of conventional generation.


## Exercise 5.2 -- Operating profit changes for conventional generators

In earlier exercises, we have seen that growing levels of renewable generation have a significant impact on the market prices of electricity. Consequently, conventional generators also experience changes regarding their operating time and profits. The goal of this exercise is to work out how these two measures change due to contrafactual levels of solar and wind capacity. This analysis comes with two key constraints and one main assumption we want to discuss.

Starting with the two key constraints:

First, although we can estimate how the operating profits of conventional generators change due to different capacity effects on RTM price, we are not able to estimate profits earned through bilateral contracts. Great energy buyers sometimes do not buy the energy over the real-time or day-ahead market but sign direct bilateral contracts with energy producers to buy their energy. As we do not have available price data for these contracts, we are not able to estimate these profits. But like Bushnell and Novan we assume that the bilateral contracts are expected to also reflect the value of electricity and therefore also adjust over time to the day-ahead and real-time market prices.  Therefore, we expect the profits earned by these contracts to be similar to our estimations (2021a, p. 784).

A second key constraint we are facing is that energy producers not only earn money by selling their produced energy but also by providing capacity or ancillary services. These are services that help the grid operator maintain a secure and stable electricity grid (NRG Editorial Voices, 2023). But as the total revenue for this type of services only accounted for less than 10 % of the total earnings of energy providers in CAISO during 2019, we are satisfied by estimating changes in the main profit stream of conventional power plants (Bushnell & Novan, 2021a, p. 784).

The main assumption we have to talk about when estimating the profit changes due to contrafactual capacity scenarios may sound familiar to you: We assume that conventional generators do not face dynamic costs or constraints (e.g., start-up costs, ramping constraints). That means that power plants will generate electricity at full capacity as long as the RTM price is higher than their marginal generation costs. In the opposite case, they will produce no energy as long as the price is below their costs. This is also one assumption of the merit order principle.

Following this assumption, we can determine the operating profits of conventional energy generators with the equation:

$$
\text{Profit}(c,K_r) = \sum_{t = 1}^{8,783}{\max{(\tilde{P}_t(K_r)-c,0)}}
$$

Here $c$ is the marginal generation cost of a conventional power plant and $\tilde{P}_t(K_r)$ is the predicted hourly contrafactual RTM price under the contrafactual capacity scenario $K_r$. The sum goes over all 8783 hourly observations available during 2016.

The operating times can be calculated in a very similar way. We just need to rethink the operating condition of a generator during a specific hour. This condition is, that a generator operates when the price is greater than the marginal costs.  Therefore, the formula looks like this:

$$
\text{Operating_Times}(c,K_r) = \sum_{t = 1}^{8,783}{X_t}
$$
where

$$
\hspace{0.8cm} X_t = 1 \hspace{0.5cm} \text{if} \hspace{0.2cm} \tilde{P}_t(K_r) \geq  c,
$$
$$
X_t = 0 \hspace{0.5cm} \text{otherwise}.
$$
We will use these two formulas to determine the estimated operating profits and operating times of conventional generators with marginal costs $c$ ranging from 0 \$/MWh to 70 \$/MWh under the four different capacity scenarios we already looked at in the previous exercise.

As always, we start by reloading the needed dataset. In contrast to other exercises this time we need the dataset created in exercise 5.1. That means we reload the dataset `dat_all` containing the observations of all four solar capacity scenarios and the predicted hourly RTM prices in these scenarios. Again, we perform the analysis only for solar and later present also results for wind.

**Task** Just `check` the code chunk to reload the needed data.
```{r "16_1"}
dat_all = readRDS("dat_all_solar.RDS")
library(dplyr)
```

After the dataset is loaded, we can convert the logic described by the equations into *R* code and apply this code to our dataset. As our year of interest is still 2016,  we start by filtering the observations. Then, we check for each observation if the RTM price is higher as the marginal cost $c$ ranging from 0 to 70. If so, we calculate the difference between the RTM price and the marginal cost to gain the possible profits.  In the end, we sum over all observations to get the total earnings and operating times of each marginal cost generator ranging from 0 to 70 in the different scenarios. The code lines further below are only necessary to get a vivid representation in a table. In the end, we take a look at the first six rows of the resulting data frame `profit_solar`.

**Task** `Check` the code chunk to perform the described tasks.
```{r "16_2"}
dat_profit = dat_all %>% 
  filter(year == 2016)

for (c in 0:70) {
  dat_profit = mutate(dat_profit, !!paste("mc_", c, sep = "") := ifelse(rtm_hat >= c, 1, 0))
  dat_profit = mutate(dat_profit, !!paste("pi_", c, sep = "") := ifelse(rtm_hat >= c, rtm_hat - c, 0))
}

dat_profit = dat_profit %>% 
  group_by(solar_sample) %>%
  summarise(across(starts_with(c("mc_", "pi_")), sum, na.rm = TRUE))

operate = as.matrix(dat_profit %>% select(starts_with("mc_")))
profit = as.matrix(dat_profit %>% select(starts_with("pi_")))

profit = t(profit)
operate = t(operate)

profit_solar = data.frame(mc = 0:70, as.data.frame(operate), as.data.frame(profit))
colnames(profit_solar) = c("mc", "operate_actual", "operate_10k", "operate_2k", "operate_6k", "profit_actual", "profit_10k", "profit_2k", "profit_6k")

profit_solar = profit_solar %>% 
  relocate("mc", "operate_actual", "operate_2k", "operate_6k", "operate_10k", "profit_actual", "profit_2k", "profit_6k", "profit_10k")

rownames(profit_solar) = NULL

head(profit_solar)
```

We view the first six rows of the data frame. This data frame holds the operation hours and the earned profits of conventional generators in 2016 depending on the marginal costs and the solar capacity scenario. We notice an expectable pattern. If the available solar capacity is high, conventional generators of all marginal costs produce during fewer hours and therefore earn less money. The higher the solar capacity, the greater this effect becomes. We see that increasing solar capacity even affects energy producers with zero marginal costs. This is due to a higher appearance of negative RTM prices. Again, Bushnell and Novan get quantitatively slightly different results as we do (Bushnell & Novan, 2021c, Counterfactual.xlsx).

To better understand the impact on profits of conventional generators we create a figure showing the percentage change in earnings comparing the 2 GW solar scenario to the other contrafactual solar scenarios. We also create a graphic for the contrafactual wind scenarios and the resulting changes of these scenarios compared to the 1 GW wind scenario.

We start by loading the provided results for contrafactual profits and generation times based on the contrafactual wind scenarios.

**Task** `Check` the code chunk to load the results for the contrafactual wind scenarios.
```{r "16_3"}
profit_wind = readRDS("profit_wind.RDS")
```

Now we need to calculate the percentage changes between the profits of the contrafactual solar and wind scenarios each compared to the scenario with the lowest capacity (2 GW for solar and 1 GW for wind).

**Task** Fill in the missing code to calculate the percentage changes in profits between the contrafactual scenarios and the lowest capacity scenario each for wind and solar.
```{r "16_4"}
#fill in the missing code to complete the task
profit_solar_plot = mutate(profit_solar,
  change_profit_6k = (___ - ___) / ___ * 100,
  change_profit_10k = (profit_10k - ___) / ___ * 100)

profit_wind_plot = mutate(profit_wind,
  change_profit_3k = (profit_3k - profit_1k) / profit_1k * 100,
  change_profit_6k = (profit_6k - profit_1k) / profit_1k * 100)

```

So now let us create the associated figures.

**Task** Just `check` the code chunk to create the figures showing the percentage changes in earnings between the lowest capacity scenarios for wind and solar to the others.
```{r "16_5",fig.height=8, fig.width=9}
sources = c("Nuclear", "Coal", "Nat. Gas CC", "Nat. Gas GT")
linesize = 1
color = c("blue", "red")

library(ggplot2)
library(patchwork)

figure_solar_profits =  ggplot(profit_solar_plot)+
  geom_rect(aes(xmin = 9, xmax = 10, ymin = -Inf, ymax = 0), fill = "#e2e2e2", alpha = 0.04)+
  geom_text(aes(x = 8, y = -4, label = sources[1], angle = 90))+
  geom_rect(aes(xmin = 24, xmax = 25, ymin = -Inf, ymax = 0), fill = "#e2e2e2", alpha = 0.04)+
  geom_text(aes(x = 23, y = -2.5, label = sources[2], angle = 90))+
  geom_rect(aes(xmin = 26, xmax = 29, ymin = -Inf, ymax = 0), fill = "#e2e2e2", alpha = 0.04)+
  geom_text(aes(x = 27.25, y = -6, label = sources[3], angle = 90))+
  geom_rect(aes(xmin = 40, xmax = 51, ymin = -Inf, ymax = 0), fill = "#e2e2e2", alpha = 0.04)+
  geom_text(aes(x = 43, y = -5.5, label = sources[4], angle = 90))+
  geom_line(aes(x = mc, y = change_profit_6k, color = "6 GW"), size = linesize)+
  geom_line(aes(x = mc, y = change_profit_10k, color = "10 GW"), size = linesize)+
  geom_hline(yintercept = 0, color = "black", size = 1.2, linetype = "solid")+
  labs(title = "", x = "Marginal costs ($/MWh)", y = expression(paste("% Change in operating profits")), color = "Solar capacity:")+
  scale_color_manual(breaks = c("6 GW", "10 GW"), values = color)+
  scale_x_continuous(limits = c(0, 52), breaks = seq(0, 52, 5))+
  scale_y_continuous(limits = c(-32, 0), breaks = seq(-32, 0, 4))+
  theme_classic()+
  theme(panel.grid.major.y = element_line(colour = "darkgrey"),
        panel.grid.minor = element_blank(),
        legend.position = "right")

figure_wind_profits =  ggplot(profit_wind_plot)+
  geom_rect(aes(xmin = 9, xmax = 10, ymin = -Inf, ymax = 0), fill = "#e2e2e2", alpha = 0.04)+
  geom_text(aes(x = 8, y = -4.5, label = sources[1], angle = 90))+
  geom_rect(aes(xmin = 24, xmax = 25, ymin = -Inf, ymax = 0), fill = "#e2e2e2", alpha = 0.04)+
  geom_text(aes(x = 23, y = -3, label = sources[2], angle = 90))+
  geom_rect(aes(xmin = 26, xmax = 29, ymin = -Inf, ymax = 0), fill = "#e2e2e2", alpha = 0.04)+
  geom_text(aes(x = 27.25, y = -6.5, label = sources[3], angle = 90))+
  geom_rect(aes(xmin = 40, xmax = 51, ymin = -Inf, ymax = 0), fill = "#e2e2e2", alpha = 0.04)+
  geom_text(aes(x = 43, y = -6, label = sources[4], angle = 90))+
  geom_line(aes(x = mc, y = change_profit_3k, color = "3 GW"), size = linesize)+
  geom_line(aes(x = mc, y = change_profit_6k, color = "6 GW"), size = linesize)+
  geom_hline(yintercept = 0, color = "black", size = 1.2, linetype = "solid")+
  labs(title = "", x = "Marginal costs ($/MWh)", y = expression(paste("% Change in operating profits")), color = "Wind capacity:")+
  scale_color_manual(breaks = c("3 GW", "6 GW"), values = color)+
  scale_x_continuous(limits = c(0, 52), breaks = seq(0, 52, 5))+
  scale_y_continuous(limits = c(-35, 0), breaks = seq(-35, 0, 5))+
  theme_classic()+
  theme(panel.grid.major.y = element_line(colour = "darkgrey"),
        panel.grid.minor = element_blank(),
        legend.position = "right")

figure_solar_profits + figure_wind_profits + plot_layout(nrow = 2) + plot_annotation(title = "Predicted operating profit changes relative to the lowest capacity scenario")
```

The figures show the change in operating profits for conventional generators with marginal costs ranging from 0 \$/MWh to 52 \$/MWh. To have a better reference, the average marginal generation costs for some generation technologies are labelled. As GT and CCGT gas power plants have a wider range of marginal costs, we see a bandwidth of the 25th and 75th percentiles. The data for this reference are gathered from the [*National Renewable Energy Lab*](https://atb.nrel.gov/electricity/).

First looking at the top figure, we again notice that based on our estimation the increase in available solar capacity comes with a decrease in the operating profits of conventional generators. Quantitatively speaking an increase from 2 GW to 6 GW of solar capacity reduces the operating profit of a hypothetical conventional power plant with marginal costs of 0 \$/MWh by around 10 %. At the same time, a hypothetical conventional plant with marginal costs of 25 \$/MWh loses around 22.5% of its initial profits. This pattern reaches its extreme at marginal costs of around 29 \$/MWh. Units with higher marginal costs recover some of the initial operating profit declines. A unit with costs of 50 \$/MWh only loses around 8 % of operating profits.

One probably would expect that increasing from 2 GW to 10 GW of solar capacity comes with an even bigger decrease in operating profits. Based on our estimation this holds for generating units with marginal costs lower than around 42 \$/MWh. Above that, we see changes that are quite similar to the ones estimated for an increase to just 6 GW. This is because in the 10 GW scenario, the high marginal cost generators recover their initial profit losses even faster. This pattern emerges due to the fact that an increase from 6 GW  to 10 GW has no meaningful additional effect on generating times of high-cost generating units.  Therefore, they continue to operate the same number of hours and as a consequence earn stable operating profits (Bushnell & Novan, 2021a, p. 790).

The described findings may have some important implications for the emission intensity of the conventional generators going forward. Our results show that in markets like CAISO, increasing solar capacity may incentivize conventional generator operators to focus on high marginal cost generators. This is because these generators experience a lower decline in profits when solar capacity increases. That means that in our example (the CAISO market) producers would invest more (or at least disinvest less) in technologies like gas turbines (GT) instead of the more fuel-efficient combined-cycle gas turbines (CCGT). This effect occurs even when neglecting ramping constraints, which are an additional advantage of GT plants. Remembering the emission rates of these two technologies available in exercise 3.3 we notice that this shift to a technology emitting 41 % more CO2 and 150 % more NOx per MWh has negative consequences on emissions. This increasing emission intensity of the conventional generator stock partially offsets the emission benefits due to the increasing solar capacity. As this argument holds for a market like CAISO where coal power plants are not really present, in a market where the favored gas turbines would substitute dirtier technologies like coal (for example in the German market) this effect may bring additional positive effects to the total emission intensity.

In the bottom figure, dedicated to the growth of wind capacity, we again see that high marginal generators can recover some of their losses in both scenarios. However, there is a significant difference between the 3 GW wind capacity scenario and the 6 GW scenario.  Therefore, we cannot conclude that high marginal generators are strongly favorable for increasing wind capacity.

In summary, our results indicate that an increase in solar or wind capacity, as outlined in our scenarios, causes generators of all marginal costs to lose some of their initial profits. The strength of this effect given a defined capacity scenario varies depending on the marginal cost of the generators. Furthermore, conventional generators with different costs also react differently to the strength of renewable capacity growth. The uneven distribution of profits can have a negative impact on the emission intensity of the conventional generation fleet in markets such as CAISO.

The next (and last) exercise will focus on the marginal energy value of renewable capacity additions. 


## Exercise 5.3 -- Marginal energy value of renewable capacity additions

We will end the chapter on contrafactual analysis by exploring how the additional energy value of marginal increases in renewable capacity vary with the level of already installed capacity. It is important to point out that we are not interested in the revenue earned by the owner of the marginal unit of renewable capacity. Instead, we want to estimate the market value of the additional renewable generation produced by the capacity additions.

The difference between these two investigation questions is: As the renewable capacity increases, the aggregate level of renewable curtailment will grow. This curtailment is experienced by the newest marginal unit. Therefore, their profits are affected. In contrast, the measure we are interested in is independent of which units are experiencing the curtailment.

As in the exercises before, we perform the analysis for solar and then just load the results for wind as a comparison. Our first step in this analysis will be to estimate the additional solar output a 1 MW capacity increase would entail. Following Bushnell and Novan we assume that the hourly solar capacity factors (hourly solar output / solar capacity) indicate the quantity of electricity that an extra megawatt of solar capacity would generate, irrespective of the total installed renewable capacity (2021a, p. 791). This assumption includes that the proportion of hourly output that is curtailed is the same as the proportion of potential hourly output that was actually curtailed during the specific hour in 2016. This assumption may overestimate curtailments at lower renewable capacity levels.

That means that, while the results will show that the marginal value of energy decreases as renewable capacity increases, these decreases are likely to underestimate the reduction in the value of energy provided by additional renewables.

To estimate the total value of the additional renewable energy produced by a 1 MW increase in solar capacity during 2016 we multiply the hourly solar capacity factors (amount of additional energy supply) by the predicted hourly counterfactual prices. By adding up all hours in 2016, we can calculate the annual value of the extra energy produced by 1 additional MW of renewable capacity.

By adding up all hours of the year we assume that the renewable energy is supplied even during hours when prices are negative. According to Bushnell and Novan this is a reasonable assumption because renewable energy sources are often incentivized to supply power even when prices are negative (2021a, p. 792). However, this assumption does not significantly affect our estimates. Even with a solar capacity of 10 GW, the predicted wholesale price falls below zero for less than 1 % of the hours.

As always, we start our analysis by loading the needed dataset. We also prepare the data by creating the season variables and the monthly dummies. 

**Task** `Check` the code chunk to load the dataset and prepare the data.
```{r "17_1"}
dat = readRDS("Setting_Sun_dataset.RDS")

library(dplyr)

dat = mutate(dat, season = case_when(
     month <= 2 | month >= 12 ~ 1,    
     month >= 3 & month <= 5 ~ 2,
     month >= 6 & month <= 8 ~ 3,
     month >= 9 & month <= 11 ~ 4))

for (m in 1:12) {
  dat = dat %>% 
  mutate(!!paste("m", toString(m), sep = "") := ifelse(month == m, 1, 0))
}
```

Well, we now create contrafactual data samples for 2016 as we did before. But this time we create samples for capacities between 2 GW and 10 GW in steps of 500 MW. Additionally, we calculate the hourly solar capacity factors. These factors are calculated by dividing the hourly solar output by the hourly solar capacity.

**Task** `Check` the code chunk to create the contrafactual scenarios and to calculate the hourly solar capacity factors.
```{r "17_2"}
dat = mutate(dat,
  solar_cap_factor = solar_potential / (24 * solar_cap / 1000))

dat_all = dat %>% 
  mutate(hourly_solar_cap_factor = solar / solar_cap,  #calculating the hourly capacity factors
         solar_sample = "actual",
         sample_id = 0)

dat_0 = dat_all

for (i in seq(2000, 10000, 500)) {
  temp = dat_0
  temp = temp %>% 
    mutate(solar_potential = solar_cap_factor * i * (24 / 1000),
           sample_id = i,
           solar_sample = paste("solar_", toString(i), sep = ""))
  
  dat_all = rbind(dat_all, temp)
}
```

After the creation of the contrafactual scenarios, we need to estimate the contrafactual curtailments. This step works exactly the same as in exercise 5.1. Therefore, it will not be discussed in more detail here.

**Task** `Check` the code chunk to predict the contrafactual solar curtailments.
```{r "17_3",warning=FALSE}
library(AER)

dat_all = dat_all %>% 
  mutate(solar_load = solar_potential * daily_load)

formula_m = paste("m", 1:12, sep = "", collapse = " + ")
formula = formula(paste("solar_curtailed ~ solar_potential + solar_load + daily_wind + gas_price + daily_load + inches_lag +", formula_m))

reg = tobit(formula, left = 0, data = filter(dat_all, hour == 12 & solar_sample == "actual"))

dat_all$solar_curtailed_fitted = NA
dat_all$solar_curtailed_fitted =  predict(reg, newdata = dat_all)
dat_all$solar_curtailed_fitted[dat_all$solar_curtailed_fitted < 0 | is.na(dat_all$solar_curtailed_fitted)] = 0

dat_all = dat_all %>% 
  mutate(daily_solar = ifelse(solar_sample != "actual", solar_potential - solar_curtailed_fitted, daily_solar))
```

Also, the prediction of the contrafactual prices is not new for us. In exercise 5.1 we have already performed this prediction. Only the last code line differs. This is due to the fact that we have different solar samples as in the exercise before.

**Task** `Check` the code chunk to predict contrafactual prices for the different solar scenarios.
```{r "17_4",warning=FALSE}
library(stats)

dat_all = dat_all %>%
  mutate(rtm_fitted = NA,
         resid = NA)

formula_m = paste("m", 1:12, sep = "", collapse = " + ")
formula = formula(paste("rtm_total ~ daily_solar + daily_wind + gas_price + load + inches_lag + ", formula_m))

#for-loop over the hours
for (h in 1:24) {
  dat_reg = filter(dat_all, hour == h & solar_sample == "actual")
  reg = lm(formula, data = dat_reg)
  
  filter1 = dat_all$hour == h
  dat_all[filter1,]$rtm_fitted = predict(reg, newdata = filter(dat_all, hour == h))
  
  filter2 = filter1 & dat_all$solar_sample == "actual" & !is.na(dat_all$rtm_total)
  dat_all[filter2,]$resid = residuals(reg)
}

residu = dat_all[dat_all$solar_sample == "actual",]$resid

for (i in names(table(dat_all$solar_sample))) {
  dat_all[dat_all$solar_sample == i,]$resid = residu
}
```

After performing the necessary preparatory work for our last analysis, we have finally arrived at the main part of interest. It is now time to calculate the estimators for the RTM price `rtm_hat` during 2016. After that, we can multiply these estimators with the hourly solar capacity factors `hourly_solar_cap_factor` to get the marginal revenues `marginal_revenue`. Then we can group the data by the different capacity scenarios `sample_id` and sum over all marginal revenues of each scenario. In the end, we want to view the results of all contrafactual scenarios in one table. 

**Task** Fill in the missing code gaps to get the described functionality.
```{r "17_5"}
#fill in the missing code to complete the task
dat_all_2016 = dat_all %>%
  mutate(rtm_hat = rtm_fitted + resid) %>%
  filter(year == 2016)

marginal_solar =  dat_all_2016 %>% 
  mutate(marginal_revenue = rtm_hat * ___) %>%
  ___(sample_id) %>% 
  summarise(marginal_revenue = ___(marginal_revenue, na.rm = TRUE)) %>% 
  filter(sample_id != 0) %>% 
  rename("solar_capacity" = "sample_id")

marginal_solar

```

As in the introduction already revealed, we see that the annual energy value of the electricity produced by the marginal solar generator decreases as solar capacity increases. We will see that the same statement holds for the wind generators and the wind capacity. To better visualize and interpret the results we create some figures that show the change in annual energy value of the marginal renewable generating unit compared to the scenario with the lowest renewable capacity (2 GW for solar and 1 GW for wind).  Therefore, we first load the associated results for wind generation.

**Task** `Check` the code chunk to load the results for the marginal energy value of wind.
```{r "17_6"}
marginal_wind = readRDS("marginal_wind.RDS")
```

Now let us calculate the relative changes and then create the corresponding figures for solar and wind.

**Task** Just `check` the code chunk to calculate the relative changes and to create the figures showing the percentage changes of the annual energy value of the marginal renewable generating unit compared to the scenario with the lowest renewable capacity.
```{r "17_7",fig.height=8, fig.width=9}
dat_solar_marginal = mutate(marginal_solar, rel_change = 100 * (marginal_revenue - max(marginal_revenue)) / max(marginal_revenue))

dat_wind_marginal = mutate(marginal_wind, rel_change = 100 * (marginal_revenue - max(marginal_revenue)) / max(marginal_revenue))

library(ggplot2)
library(patchwork)

linesize = 0.5
color = c("blue")

figure_solar_marginal =  ggplot(dat_solar_marginal, aes(x = solar_capacity )) +
  geom_line(aes(y = rel_change), color = color[1], size = linesize)+
  geom_hline(yintercept = 0, color = "black", size = 1.2, linetype = "solid")+
  labs(x = "Counterfactual solar capacity (MW)", y = expression(paste("% Change in marginal revenue"))) +
  scale_x_continuous(limits = c(2000, 10000), breaks = seq(2000, 10000, 1000)) +
  scale_y_continuous(limits = c(-60, 0), breaks = seq(-60, 0, 10)) +
  theme_classic() +
  theme(panel.grid.major.y = element_line(),
        panel.grid.minor = element_blank())

figure_wind_marginal =  ggplot(dat_wind_marginal, aes(x = wind_capacity )) +
  geom_line(aes(y = rel_change), color = color[1], size = linesize)+
  geom_hline(yintercept = 0, color = "black", size = 1.2, linetype = "solid")+
  labs(x = "Counterfactual wind capacity (MW)", y = expression(paste("% Change in marginal revenue"))) +
  scale_x_continuous(limits = c(1000, 6000), breaks = seq(1000, 6000, 500)) +
  scale_y_continuous(limits = c(-25, 0), breaks = seq(-25, 0, 5)) +
  theme_classic() +
  theme(panel.grid.major.y = element_line(),
        panel.grid.minor = element_blank())

figure_solar_marginal + figure_wind_marginal + plot_layout(nrow = 2) + plot_annotation(title = "Predicted marginal energy value changes relative to the lowest capacity scenario")
```

The above figures illustrate the relative change in energy value provided by an additional MW of solar or wind power, compared to a baseline scenario of 2 GW of solar or 1 GW of wind power.

In the first graphic, it is shown that as solar power capacity increases, the energy value of each additional solar unit decreases. This is due to the strong correlation of solar production. Although conventional generators with high marginal costs can offset some of their initial revenue losses by the rise in wholesale prices during morning and evening hours due to solar expansion, solar generators do not benefit from these price increases as these price increases occur outside their main production hours. The energy market value of the 10,000th MW of solar capacity is 52 % lower than the value of the 2,000th MW.

The second graphic shows a similar trend for wind power. The market value of energy produced by the 6,000th MW of wind capacity is 20 % less than that of the 1,000th MW. Therefore, the marginal value of new wind and solar capacity has significantly decreased as the amount of existing capacity has increased over the past five years.

These results again underline the advantages of complementary short and medium-term energy storage. With the help of such storage capacities, it would be possible to shift energy supply to hours where renewable supply is low and therefore energy prices are higher. This would lead to a lower decrease in the marginal energy value of renewable capacity additions.

Well, we have now finished our replication of all main analyses performed in the paper of Bushnell and Novan.  Therefore, the following chapter will be a recap and conclusion of all the things we have already learned and
discovered together, as well as the consequences arising from them.


## Exercise Recap & Conclusion

To end this RTutor problem set I want to recapitulate what we did and achieved during our journey through the economical and empirical background of Bushnell & Novans paper "Setting with the Sun: The Impacts of Renewable Energy on Conventional Generation".

In the first chapter, we started our journey by exploring the dataset and creating some initial graphs visualizing the market properties in which the later analysis takes place. In the first part of this initial chapter, we performed an inventory of the dataset and discussed some potential issues regarding NA-values and missing observations. Furthermore, we took our first steps in *R* and got to know powerful packages like `dplyr` and `ggplot`. The second part focused more on the qualitative description of the information contained in the available data. We talked about the key features of the later performed analysis and showed why the Californian market fits all necessary conditions for the analysis. At the end of the first chapter, we also found some initial evidence that motivates further investigations.

The next chapter led us to a more technical topic. There we talked about the main empirical approach we later used to establish the results. The method we talked about is the *linear regression using ordinary least square estimation* or OLS regression. There we started by performing some simplified regressions using a naive regression model only containing the variables of interest. On the way, we got to know confounding variables and introduced controls to prevent omitted variable bias. Another part of this chapter was the optional exercise about standard errors, confident intervals and OLS regression assumptions that can cause problems.Besides, Newey-West errors were introduced to face these potential problems.

After that, we arrived at our first major analysis, where we estimated the effects of increasing renewable capacity on real-time market wholesale prices. We started by recapitulating the main goals of the analysis and by introducing the regression model with all its control variables. One main takeaway from this chapter is the economic difference between the regression performed with hourly production variables compared to the regression with daily outputs. The latter allowed us to also estimate the non-contemporaneous effects of increasing renewables. In this chapter, we realized, that based on our results increasing renewable capacity has a strong negative effect during daylight hours. But when looking at solar energy we also saw some significant positive price effects in the morning and evening hours. As the further analysis performed in this chapter shows, this is due to substitution patterns emerging between renewables and conventional generators. Especially the changes in the output composition of natural gas units are the main reason for this effect.

The second major analysis of the impact of increasing solar energy on emissions was quite similar to the examinations discovering the substitution patterns. This is because natural gas units are the common fossil fuel power plants in the CAISO market and therefore are the main producers of CO2 and NOx. One challenge when analyzing the emission effect of solar was the appropriate integration of the spatial and temporal leakage effects due to market imports and storable hydro energy. Unsurprisingly we found that increasing solar reduces the emissions in the CAISO market a lot. Interestingly this found effect is heterogeneous across seasons.

The last great topic we were dealing with brought in a new analysis technique to investigate the impact of renewable capacity extension. This new approach was to create contrafactual capacity scenarios and predict how the CAISO market would have looked under these circumstances during the year 2016. First, we focused on the real-time market prices and predicted them under three different scenarios. That showed us results that were in line with the findings established in previous chapters. Therefore, these findings support our earlier results and the other way around. Additionally, the results underlined the statement, that storage technologies are a helpful complement to renewable capacity expansions. Furthermore, we examined the profit changes of conventional generators due to additional renewable capacity. There we worked out that conventional generators lose some of their initial profits and generation times as the energy market price is lowered. However, this effect is not equally distributed over all types of generators. Especially flexible high marginal cost generators can recover some of their initial profits when renewable capacity increases. That leads to incentives to prioritize higher marginal cost power plants. As these power plants tend to have higher emission rates in the CAISO market, this can be followed by a counter effect to the emission reduction effect of solar energy. The last analysis performed was dedicated to the marginal energy value of renewable capacity additions. This analysis showed that as renewable power capacity increases, the energy value of each additional renewable unit decreases.


### Conclusion

After we have now recapitulated all the steps the RTutor problem set led us through, I will now give a short interpretation of the collective results and draw some conclusions about future developments in renewable energy expansion.

Our performed analyses cover more or less all major benefits and challenges renewable energy expansion and especially increasing solar capacity entails. On the one hand, renewable energies help to reduce greenhouse gas emissions and thereby help to slow down human-caused climate change. Additionally, renewable energies tend to have lower marginal energy costs and can therefore provide cheap electricity. On the other hand, renewables like wind and solar energy are strongly dependent on external factors like the wind blowing and sunshine. This dependence not only causes them to be very inflexible energy sources but also leads to a high output correlation of renewable power plants. This means that the energy output of power plants dedicated to the same energy source tends to be at a time either very high or very low. For example, our analysis shows that solar output is very high during midday hours, where prices therefore decreased very much. But in other hours like the night hours, we see now significant solar output. These characteristics combined with supply incentives for renewables lead to an energy market where we see increasing renewables regulate their correlated supply not only based on demand. This results in strong price variations. Sometimes even negative prices can occur due to oversupply. The consequence of these supply and price variations is, that renewable energies do need suitable complementary technologies, such as energy storage facilities or flexible peak-load power plants. 

In our analyses, we find that in the CAISO market, there was a shift from less flexible conventional energy generators to more flexible ones, although they are less fuel-efficient and therefore more expensive. That shift can be explained by higher profit losses slow generators experience as they also produce decent amounts of energy during times when the price is drastically lowered by renewable output. We found out that this shift can explain the increases in real-time market prices during morning and evening hours. As increasing solar generation increases the price during these edge hours, while it lowers the price during midday, there emerges a price spread, which could be the basis on which possible storage facilities could earn profits. Therefore, we can conclude that the analysed market forces in the CAISO market reflect the need for complementary technologies, especially for medium-term energy storage.

Efficient storage technologies would not only solve the flexibility problem of renewable generation but also provide possibilities to address the strong temporal correlation of renewables. As this correlation is one of the main reasons for the declining marginal energy value of renewable generation, finding a way to distribute the renewable output over a longer period would weaken this value loss.

Since the expansion of renewable energy goes on in many regions around the world, we will have to adapt to the special characteristics of renewable energy generation. Therefore, it is important to understand the effects these characteristics have on existing conventional generators and on the energy market itself. With the economic journey made in this RTutor problem set we gained a deeper understanding of this topic, learned a lot about econometric methods and deepened our `R` skills.

**Task** You can now `check` this very last code chunk to view the awards you collected during our journey.
```{r "18_1"}
awards()
```


## Exercise References

Bundesnetzagentur (SMARD) (2024): *Marktdaten*. <https://www.smard.de/home/downloadcenter/download-marktdaten/>. Accessed 29.05.2024. 

Bushnell, J. & Novan, K. (2021a): *Setting with the Sun: The Impacts of Renewable Energy on Conventional Generation* Journal of the Association of Environmental and Resource Economists,  8:4, 759-796. <https://doi.org/10.1086/713249>.

___ (2021b): *Supplemental Material for: "Setting with the Sun: The Impacts of Renewable Energy on Conventional Generation"*. Journal of the Association of Environmental and Resource Economists,  8:4, 759-796.  <https://www.journals.uchicago.edu/doi/suppl/10.1086/713249>.

___ (2021c): *Replication Data for: Setting with the Sun: The impacts of renewable energy on conventional generation*. <https://doi.org/10.7910/DVN/6XQZ3L> Accessed 29.05.2024.

California Air Resources Board (2018): *STAFF REPORT: INITIAL STATEMENT OF REASONS FOR RULEMAKING*. <https://ww2.arb.ca.gov/sites/default/files/barcu/regact/2013/ghg2013/ghg2013isor.pdf>. Accessed 29.05.2024.

Energy Information Administration (EIA) (2021): *Californiaâs curtailments of solar electricity generation continue to increase*. <https://www.eia.gov/todayinenergy/detail.php?id=49276>. Accessed 29.05.2024.

___ (2023a): *Units and calculators explained "British thermal units (Btu)"*. <https://www.eia.gov/energyexplained/units-and-calculators/british-thermal-units.php>. Accessed 29.05.2024.

___ (2023b): *Glossary: "Heat rate"*. <https://www.eia.gov/tools/glossary/index.php>.  Accessed 29.05.2024.

EURACOAL (2024): *WHY IS THERE NO LIGNITE MARKET?*. <https://euracoal.eu/coal/why-is-there-no-lignite-market/>. Accessed 29.05.2024.

Greene, W. H. (2002): *Econometric Analysis*. 5th Edition, Pearson Education.

HÃ¶hne, N. E., Braun, N. et al. (2012): *Greenhouse gas emission reduction proposals and national climate policies of major economies: Policy Brief*. Netherlands Environmental Assessment Agency, Bilthoven and ECOFYS, Utrecht.

International Renewable Energy Agency IREA (2023) â processed by Our World in Data: *âGlobal installed renewable energy capacity by technologyâ*. <https://ourworldindata.org/grapher/installed-global-renewable-energy-capacity-by-technology>. Accessed 29.05.2024.

Kennedy, P. (2008): *A Guide to Econometrics*. 6th Edition, Blackwell Publishing.

National Renewable Energy Laboratory (NREL) (2017): *2017 ATB Cost and Performance Summary*. <https://atb-archive.nrel.gov/electricity/2017/summary.html>. Accessed 29.05.2024.

Newey, W. K. & K. D. West (1987): *A Simple, Positive Semi-Definite, Heteroskedasticity and Autocorrelation Consistent Covariance Matrix*. Econometrica, 55:3, 703-708.

NRG Editorial Voices (2023): *Electricity markets: whatâs the difference between a wholesale energy market and a capacity market?* <https://www.nrg.com/insights/energy-education/electricity-markets-what-s-the-difference-between-a-wholesale-en.html>. Accessed 29.05.2024.

Ritchie, H. & Rosado, P. & Roser, M. (2020): *âEmissions by sector: where do greenhouse gases come from?â*. <https://ourworldindata.org/emissions-by-sector>. Accessed 29.05.2024.

SensfuÃ, F. & Ragwitz, M. & Genoese, M. (2008): *The merit-order effect: A detailed analysis of the price effect of renewable electricity generation on spot market prices in Germany*, Energy Policy, 36:8, 3086-3094. <https://doi.org/10.1016/j.enpol.2008.03.035>.
 
Statistisches Bundesamt (2024): *Bruttostromerzeugung in Deutschland*. <https://www.destatis.de/DE/Themen/Branchen-Unternehmen/Energie/Erzeugung/Tabellen/bruttostromerzeugung.html>. Accessed 29.05.2024.

Stock, J. H. & M. W. Watson (2019): *Introduction to Econometrics*. 4th Edition, Pearson Education. 

VanderWeele, TJ. & Shpitser, I. (2013):  *On the definition of a confounder.* Ann Stat., 41:1, 196â220.  <https://doi.org/10.1214/12-AOS1058>.

Verbeek, M. (2004): *A Guide to Modern Econometrics*. 2nd Edition, John Wiley & Sons Ltd.

Wooldridge, J.M. (2013): *Introductory Econometrics: A Modern Approach*. 5th Edition, South-Western, Cengage Learning.

### R and R packages

`AER`: Kleiber, C. & Zeileis, A (2008): *Package 'AER': Applied Econometrics with R*. R package version 	1.2-12. <https://CRAN.R-project.org/package=AER>.

`car`: Fox, J. & Weisberg, S. (2019): *Package 'car': An R Companion to Applied Regression*. R package version 3.1-2. <https://CRAN.R-project.org/package=car>.

`dplyr`: Wickham, H. & FranÃ§ois, R. & Henry, L. & MÃ¼ller, K. & Vaughan, D. (2023): *Package 'dplyr': A Grammar of Data Manipulation*. R package version 1.1.2. <https://github.com/tidyverse/dplyr> , <https://dplyr.tidyverse.org>.

`ggplot2`:  Wickham, H. & W. Chang (2016): *Package 'ggplot2': Create Elegant Data Visualisations Using the Grammar of Graphics*. R package version 3.4.2. <https://github.com/tidyverse/ggplot2> , <https://ggplot2.tidyverse.org>.

`haven`: Wickham, H. & Miller, E. & Smith, D. (2023): *Package 'haven': Import and Export 'SPSS', 'Stata' and 'SAS' Files*. R package version 2.5.2. <https://github.com/tidyverse/haven> , <https://haven.tidyverse.org>.

`patchwork`: Thomas Lin Pedersen (2023): *Package 'patchwork': The Composer of Plots*. R package version 1.1.3. <https://CRAN.R-project.org/package=patchwork>.

`R`: R Core Team (2021): *R: A language and environment for statistical computing*. R version 4.1.1. <https://www.r-project.org/>.

`RTutor`: Kranz, S. (2020): *Package 'RTutor': Interactive R problem sets with automatic testing of solutions and automatic hints*. R package version 2020.11.25. <https://github.com/skranz/RTutor>.

`sandwich`: Zeileis, A. (2023): *Package 'sandwich': Robust Covariance Matrix Estimators*. R package version 3.0-2. <https://CRAN.R-project.org/package=sandwich>.

`stargazer`: Hlavac, M. (2022): *Package 'stargazer': Well-Formatted Regression and Summary Statistics Tables*. R package version 5.2.3. <https://CRAN.R-project.org/package=stargazer>.


## Exercise Appendix - German market data

Bushnell and Novan only focus on the Californian electricity market. Probably it could be interesting to search for similar patterns and results in other markets. Therefore, we are now trying to perform a similar analysis for German market data. Since this problem set is already quite long, we will just perform the first price effect analysis.

Since we do not have an already prepared dataset with German market data, we need to gather our own data.

When looking for the right data, we could try to gather data to regress a model like the one in exercise 3.1. However, when doing so we would quickly realise that this is not straight forward in the German market.

Two main problems arise early on:

When searching for data from a time period similarly long as in the paper of Bushnell and Novan the first problem appears. In the last few years external factors like the energy crisis after the Corona pandemic and the war in Ukraine, significantly affected the energy markets in Europe This leads to the assumption that these years are not a significant sample for longer time periods. But when looking for data before 2020 (the year where the first Corona lockdown occurred), there is no useful data available for free. Therefore, we make a compromise and use data from the years 2019 (before the Corona crisis) and 2023 (some time after the war started) instead. That means that the performed regressions just cover a one-year time period each.

A second obstacle that we encounter when planing to use an advanced regression model is, that the German market is more diverse and dynamic than the CAISO market. To illustrate this, we can plot a graph of the German market's electricity supply in 2019 and 2023, sorted by energy source. The data for this graph was gathered by the Federal Statistical Office of the German state (Statistisches Bundesamt, 2024).

Let us first load the dataset and the needed packages.

**Task** Just `check` the code chunk to load the data, the required packages and to look at the data.
```{r "20_1"}
library(ggplot2)
library(patchwork)
library(dplyr)
library(sandwich)
library(stats)

supply = readRDS("German_supply.RDS")
supply
```

The data set shows the amount of energy from various sources in 2019 and 2023. It also shows how much each source contributes to the total electricity supply.
Now, let us create a figure to visualize this data.

**Task** `Check` the code chunk to plot a figure showing the supply in 2019 and 2023.
```{r "20_2",fig.width=9}
supply = readRDS("German_supply.RDS")

figure_supply_2019 = ggplot(supply[-1,], aes(x = "", y = Supply_2019, fill = reorder(Source, Supply_2019)))+
  geom_bar(stat = "identity", width = 1, size = 1)+
  coord_polar("y")+
  labs(x = NULL, y = NULL, fill = "Source", title = "Supply 2019 (608 TWh)") +
  scale_fill_manual(values = c("darkblue", "blue", "grey", "yellow", "green", "black", "pink", "cyan", "darkgoldenrod", "#56B4E9"))+
  guides(fill = guide_legend(reverse = TRUE))+
  theme_classic() +
    theme(axis.line = element_blank(),
          axis.text = element_blank(),
          axis.ticks = element_blank(),
          plot.title = element_text(hjust = 0.5, color = "#666666"))
  
figure_supply_2023 = ggplot(supply[-1,], aes(x = "", y = Supply_2023, fill = reorder(Source, Supply_2023)))+
  geom_bar(stat = "identity", width = 1, size = 1)+
  coord_polar("y")+
  labs(x = NULL, y = NULL, fill = "Source", title = "Supply 2023 (515 TWh)") +
  scale_fill_manual(values = c("darkblue", "pink", "blue", "grey", "black", "green", "yellow", "cyan", "darkgoldenrod", "#56B4E9"))+
  guides(fill = guide_legend(reverse = TRUE))+
  theme_classic() +
  theme(axis.line = element_blank(),
          axis.text = element_blank(),
          axis.ticks = element_blank(),
          plot.title = element_text(hjust = 0.5, color = "#666666"))
  
figure_supply_2019 + figure_supply_2023 + plot_layout(ncol = 2)
```

As we can see in the figure, the German electricity market uses a wider range of energy sources compared to the CAISO market. The main fossil fuel electricity sources are lignite, natural gas and coal. In 2019, we also see a significant amount of nuclear power. 

In contrast, in the CAISO market, the by far most important fossil fuel technology in the observed time period was natural gas. Therefore, Bushnell and Novan included the natural gas price as a control variable to control for supply-driven trends.  In our case to control for fuel price trends we should also include the prices of the most important fossil fuels. But as for natural gas, this is comparatively easy, it is nearly impossible for lignite. This is because lignite is not traded worldwide at a defined market price. That results from the fact that the production of lignite is often vertically integrated into energy producers (EURACOAL, 2024). Therefore, there is no price data available for this most important fossil fuel.

With these challenges and some smaller issues in mind, we make a compromise to use a simplified model only containing the real-time market price as the dependent variable, the daily solar and wind production as independent variables (like the regression in exercise 2.1 but with daily production variables) and some monthly dummies.

Let us start the analysis by loading the dataset, which was gathered from the Bundesnetzagentur (Bundesnetzagentur, 2024). 

**Task** Just `check` the code chunk to load the dataset and take an initial look at the specs of it.
```{r "20_3"}
dat = readRDS("Deutschland_dataset.RDS")

NROW(dat)

colnames(dat)
```

The dataset has 17520 observations and 32 columns. It has time stamp variables, output variables for different energy sources, the RTM price and dummy variables for months. To get a first overview of the price data, let us plot the average hourly RTM prices for 2019 and 2023.

**Task** `Check` the code chunk to plot the average hourly prices of the years 2019 and 2023.
```{r "20_4"}
dat_hour_avg = dat %>% 
  group_by(hour,year) %>% 
  summarise(price = mean(rtm_price, na.rm = TRUE))

ggplot() +
  geom_line(data = filter(dat_hour_avg, year == 2019), aes(x = hour, y = price, color = "2019"))+
  geom_line(data = filter(dat_hour_avg, year == 2023), aes(x = hour, y = price, color = "2023"), linetype = "dashed")+
  ylab("Price in â¬/MWh")+
  xlab("Hour")+
  labs(title = "Average hourly price 2019 and 2023")+
  theme(legend.position = "bottom",
        legend.title = element_blank())
```

The graphs show that the average electricity prices were significantly higher in 2023 than in 2019. The peaks during morning and evening hours also seem much bigger in 2023 compared to 2019. These findings differ from the results we got in exercise 1.2 when plotting the same graph for the CAISO market in the years 2013 and 2016. In the CAISO market, prices decreased during the observation period in all hours except in the evening. Therefore, we can presume that the market environment of the German market between 2019 and 2023 is not very comparable to the one of the CAISO market between 2013 and 2016. Reasons for that might be the different market shocks triggered by the Covid-19 pandemic and the war in Ukraine. But also, different political framework conditions or general market conditions may be a reason for this discrepancy.

Nevertheless, let us perform the simple OLS regression to see if we find comparable price effects of daily solar production anyway. As before we perform the regression for each hour separately and save the result in a solution data frame. We will also compute Newey-West errors with a 7-day lag. The prices in the observed years differ a lot, so it is not sensible to regress over both years together. Therefore, we also perform individual regressions for each year.

**Task** `Check` the code chunk to perform the OLS regressions analyzing the price effects of increasing solar production.
```{r "20_5"}

rtm_change_daily_2019 = data.frame(
    hour = 1:24,
    beta_solar = NA,
    beta_wind = NA,
    stddev_solar = NA,
    stddev_wind = NA
  )

rtm_change_daily_2023 = data.frame(
    hour = 1:24,
    beta_solar = NA,
    beta_wind = NA,
    stddev_solar = NA,
    stddev_wind = NA
  )

formula_m = paste("m", 1:12, sep = "", collapse = " + ")
model = "rtm_price ~ daily_solar + daily_wind"
formula = paste(model, formula_m, sep = " + ")

dat_2019 = filter(dat, year == 2019)

for (h in 1:24){
  
  dat_filtered = filter(dat_2019, hour == h)
  
  reg_daily = lm(formula, data = dat_filtered)
  
  rtm_change_daily_2019[h, 2] = coef(reg_daily)[2]
  rtm_change_daily_2019[h, 3] = coef(reg_daily)[3]
  
  nw_error = sqrt(diag(NeweyWest(reg_daily, lag = 7, prewhite = FALSE)))
  rtm_change_daily_2019[h, 4] = nw_error[2]
  rtm_change_daily_2019[h, 5] = nw_error[3]
}

dat_2023 = filter(dat, year == 2023)

for (h in 1:24){
  
  dat_filtered = filter(dat_2023, hour == h)
  
  reg_daily = lm(formula, data = dat_filtered)
  
  rtm_change_daily_2023[h, 2] = coef(reg_daily)[2]
  rtm_change_daily_2023[h, 3] = coef(reg_daily)[3]
  
  nw_error = sqrt(diag(NeweyWest(reg_daily, lag = 7, prewhite = FALSE)))
  rtm_change_daily_2023[h, 4] = nw_error[2]
  rtm_change_daily_2023[h, 5] = nw_error[3]
}
```

Let us directly go on to the graphical representation of the results.

**Task** Just `check` the code chunk to plot the results.
```{r "20_6",fig.width=9}
figure_rtm_change_2019 = ggplot(rtm_change_daily_2019, aes(x = hour)) +
  geom_point(aes(y = beta_solar), color = "grey", size = 3) +
  geom_errorbar(aes(ymax = beta_solar + 2 * stddev_solar, ymin = beta_solar - 2 * stddev_solar), size = 0.5) +
  geom_hline(yintercept = 0, color = "black", size = 1.2, linetype = "solid")+
  labs(title = expression(paste("Change of avg. hourly price due to an \n additional GWh of daily solar production \n (2019)")), x = "Hour", y = expression(paste("Change in avg. hourly price \n (Euro/MWh)"))) +
  scale_x_continuous(limits = c(1, 24), breaks = 1:24) +
  theme_classic()+
  theme(
    panel.grid.major.y = element_line(),
    panel.grid.minor = element_blank(),
    plot.margin = margin(1, 0, 0, 1, "cm"))

figure_rtm_change_2023 = ggplot(rtm_change_daily_2023, aes(x = hour)) +
  geom_point(aes(y = beta_solar), color = "grey", size = 3) +
  geom_errorbar(aes(ymax = beta_solar + 2 * stddev_solar, ymin = beta_solar - 2 * stddev_solar), size = 0.5) +
  geom_hline(yintercept = 0, color = "black", size = 1.2, linetype = "solid")+
  labs(title = expression(paste("Change of avg. hourly price due to an \n additional GWh of daily solar production \n (2023)")), x = "Hour", y = expression(paste("Change in avg. hourly price \n (Euro/MWh)"))) +
  scale_x_continuous(limits = c(1, 24), breaks = 1:24) +
  theme_classic()+
  theme(
    panel.grid.major.y = element_line(),
    panel.grid.minor = element_blank(),
    plot.margin = margin(1, 0, 0, 1, "cm"))

figure_rtm_change_2019 + figure_rtm_change_2023 + plot_layout(ncol = 2)
```

The figures show the estimated price effects of one GWh of additional solar output based on the data from the years 2019 respectively 2023. We can see that both pictures look qualitatively similar. As in the analysis of the CAISO market (exercise 3.2), our estimations suggest that increasing daily solar production comes with a strong decrease in RTM prices during the daytime hours. Unlike the CAISO analysis, this time the strength of the price effect is much more dependent on the daytime hour. This shows up in a narrower slope, with a much more defined minimum.

During night hours our estimation suggests no significant price effects of daily solar for 2019. For 2023, however, we see small price-decreasing effects in the night hours. These effects weaken in the morning hours and become insignificant here as well. The original analysis found small positive price effects during the morning and early night hours.

In the evening hours, when we found the strongest positive price effects in the original analysis, the estimation suggests very weak and insignificant but also positive price effects.

When looking at the results quantitatively, we see that in 2019 the found effects are much weaker than in 2023. This makes sense as the general average electricity price in 2019 was significantly lower than in 2023. Therefore, daily solar had less potential to reduce the price.

Overall, we conclude that we can indeed find some rough similarities between the effects daily solar has on RTM prices in the German market and in the CAISO market. However, in detail, the effects differ. The reasons for these differences are not easy to determine as there are many possible explanations for this. For example, as already mentioned Germany has different political frameworks and market conditions as the CAISO market. Also, the times when the observations took place are quite different. On the one hand, when thinking of technological improvements and on the other hand when looking at global political tensions. And finally, the model for the analysis of the German market is less sophisticated than the model used in the original analysis. 

However, we do not have time to look further into the German market, so we will leave it at this insight and conclude the additional chapter on German market data.



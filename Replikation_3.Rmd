---
title: "Replikation3"
author: "Thomas Reumiller"
date: "20 10 2023"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


*****************************************************************************************
*****************************************************************************************
** ADDITIONAL ROBUSTNESS CHECKS

*****************************************************************************************

** The section below estimates the average change in hourly RTM price by using the potential daily renewable output
** as instruments for daily solar and wind generation. For comparison, the standard OLS estimates of Eq. 1 are also
** repeated below over the same time period for which the potential wind and solar generaiton is observed. The
** resulting IV and OLS point estimates are displayed in Figure A12.



```{r}
library(haven)
library(dplyr)
library(ggplot2)
library(fixest)
library(sandwich) # für NeweyWest
library(ggpubr) # für ggarrange

library(AER)
```


Daten einlesen
```{r}
data = read_dta('Setting_Sun_dataset.dta')
```


```{r}
for (m in 1:12) {
  data = data %>% 
  mutate(!!paste("m_", toString(m), sep = "") := ifelse(month == m, 1, 0))
}

data$week = as.numeric(format(as.Date(dat$julian, origin="1960-01-01"), "%U")) + 1
data$year_week = dat$year*100 + dat$week

```

```{r}
dat = data
output_1 = data.frame(hour = 1:24, beta_solar = NA, beta_wind = NA, stddev_solar = NA, stddev_wind = NA)

for (h in 1:24) {
  fit =  ivreg(rtm_total_lmp ~ daily_solar + daily_wind + spot + load + inches_lag + as.factor(month) | solar_potential + wind_potential + spot + load + inches_lag + as.factor(month),data = filter(dat, hour == h))
  
  cov_raw = vcovHC(fit, cluster = "group", type = "HC", group = dat$year_week)
  
  output_1[h,2] = coef(fit)[2]
  output_1[h,3] = coef(fit)[3]
  output_1[h,4] = sqrt((cov_raw[2, 2]))
  output_1[h,5] = sqrt((cov_raw[3, 3]))
}

output_1
```

** Estimate average change in price by hour-of-day WITHOUT INSTRUMENTING but over same time period

```{r}
dat = data
output_2 = data.frame(hour = 1:24, beta_solar = NA, beta_wind = NA, stddev_solar = NA, stddev_wind = NA)

for (h in 1:24) {
  fit =  lm(rtm_total_lmp ~ daily_solar + daily_wind + spot + load + inches_lag + as.factor(month) ,data = filter(dat, hour == h & !is.na(solar_potential) & !is.na(wind_potential ) ))
  
  cov_raw = vcovHC(fit, cluster = "group", type = "HC", group = dat$year_week)
  
  output_2[h,2] = coef(fit)[2]
  output_2[h,3] = coef(fit)[3]
  output_2[h,4] = sqrt((cov_raw[2, 2]))
  output_2[h,5] = sqrt((cov_raw[3, 3]))
}

output_2
```

```{r}

figure_a12a = ggplot() +
  geom_point(data = output_1, aes(x = hour, y = beta_solar),color = "grey", size = 3) +
  geom_errorbar(data = output_1, aes(x = hour, ymax = beta_solar+2*stddev_solar, ymin = beta_solar-2*stddev_solar), size = 0.5) +
  geom_line(data = output_2, aes(x = hour, y = beta_solar),color = "red", size = 0.5)+
  geom_hline(yintercept = 0, color = "black", size = 1.2, linetype = "solid")+
  labs(x = "Hour", y = expression(paste("Change in Avg. Hourly Price \n ($/MWh)"))) +
  scale_x_continuous(limits = c(1,24), breaks = 1:24) +
  scale_y_continuous(limits = c(-2,0.5), breaks = seq(-2,0.5,0.5)) +
  theme_classic() +
  theme(plot.title = element_text(size = 20, face = "bold"),
        plot.subtitle = element_text(size = 16, face = "bold"),
        axis.title = element_text(size = 14),
        axis.text = element_text(size = 12),
        legend.position = "none",
        panel.grid.major.y = element_line(),
        panel.grid.minor = element_blank(),
        panel.background = element_rect(fill = "white"),
        plot.margin = margin(0, 0, 0, 1, "cm"))

figure_a12b = ggplot() +
  geom_point(data = output_1, aes(x = hour, y = beta_wind),color = "grey", size = 3) +
  geom_errorbar(data = output_1, aes(x = hour, ymax = beta_wind+2*stddev_wind, ymin = beta_wind-2*stddev_wind), size = 0.5) +
  geom_line(data = output_2, aes(x = hour, y = beta_wind),color = "red", size = 0.5)+
  geom_hline(yintercept = 0, color = "black", size = 1.2, linetype = "solid")+
  labs(x = "Hour", y = expression(paste("Change in Avg. Hourly Price \n ($/MWh)"))) +
  scale_x_continuous(limits = c(1,24), breaks = 1:24) +
  scale_y_continuous(limits = c(-0.7,0.3), breaks = seq(-0.7,0.3,0.1)) +
  theme_classic() +
  theme(plot.title = element_text(size = 20, face = "bold"),
        plot.subtitle = element_text(size = 16, face = "bold"),
        axis.title = element_text(size = 14),
        axis.text = element_text(size = 12),
        legend.position = "none",
        panel.grid.major.y = element_line(),
        panel.grid.minor = element_blank(),
        panel.background = element_rect(fill = "white"),
        plot.margin = margin(0, 0, 0, 1, "cm"))

figure_a12a
figure_a12b
```



*****************************************************************************************
** Variants of Equation (1):
** Exploiting short-run solar fluctuations (Appendix A and Figure A9)


```{r}
dat <- data %>%
  arrange(hour) %>%
  mutate(id = row_number())

for (y in 1:5) {
  for (m in 1:12) {
    if (!(y == 5 & m >5)) {
      dat$temp = ifelse(dat$month == m & dat$year == y+2012, 1, 0)
      dat = rename(dat,!!paste("y", toString(y), "_m", toString(m), sep = "") := "temp")  
    }
  }
}

output_31 = data.frame(hour = 1:24, beta_solar = NA, stddev_solar = NA, beta_wind = NA, stddev_wind = NA)

for (h in 1:24) {
  formel_y_m = paste(colnames(dat[,grep("^y[1-9]_m[1-9][0-9]?$", colnames(dat))]), sep = "", collapse = " + ")
  formel = paste("rtm_total_lmp ~ daily_solar + daily_wind + spot + load + inches_lag", formel_y_m, sep = " + ")
  fit = lm(formel, data = filter(dat, hour == h))
  
  nw_error = sqrt(diag(NeweyWest(fit, lag = 7, prewhite = FALSE)))
  output_31[h,2] = coef(fit)[2]
  output_31[h,3] = nw_error[2]
  output_31[h,4] = coef(fit)[3]
  output_31[h,5] = nw_error[3]
}

output_32 = data.frame(hour = 1:24, beta_solar = NA, stddev_solar = NA, beta_wind = NA, stddev_wind = NA)

for (h in 1:24) {

  fit = lm(rtm_total_lmp ~ daily_solar + daily_wind + spot + load + inches_lag + as.factor(month), data = filter(dat, hour == h))
  
  nw_error = sqrt(diag(NeweyWest(fit, lag = 7, prewhite = FALSE)))
  output_32[h,2] = coef(fit)[2]
  output_32[h,3] = nw_error[2]
  output_32[h,4] = coef(fit)[3]
  output_32[h,5] = nw_error[3]
}

output_32

output_33 = data.frame(hour = 1:24, beta_solar = NA, stddev_solar = NA, beta_wind = NA, stddev_wind = NA)

for (h in 1:24) {

  fit = lm(dam_total_lmp ~ daily_solar + daily_wind + spot + load + inches_lag + as.factor(month), data = filter(dat, hour == h))
  
  nw_error = sqrt(diag(NeweyWest(fit, lag = 7, prewhite = FALSE)))
  output_33[h,2] = coef(fit)[2]
  output_33[h,3] = nw_error[2]
  output_33[h,4] = coef(fit)[3]
  output_33[h,5] = nw_error[3]
}

output_33
```


figure a9 und a13
```{r}

figure_a9a = ggplot() +
  geom_point(data = output_32, aes(x = hour, y = beta_solar),color = "grey", size = 3) +
  geom_errorbar(data = output_32, aes(x = hour, ymax = beta_solar+2*stddev_solar, ymin = beta_solar-2*stddev_solar), size = 0.5) +
  geom_line(data = output_31, aes(x = hour, y = beta_solar),color = "red", size = 0.5)+
  geom_hline(yintercept = 0, color = "black", size = 1.2, linetype = "solid")+
  labs(x = "Hour", y = expression(paste("Change in Avg. Hourly Price \n ($/MWh)"))) +
  scale_x_continuous(limits = c(1,24), breaks = 1:24) +
  scale_y_continuous(limits = c(-1.8,0.6), breaks = seq(-1.8,0.6,0.3)) +
  theme_classic() +
  theme(plot.title = element_text(size = 20, face = "bold"),
        plot.subtitle = element_text(size = 16, face = "bold"),
        axis.title = element_text(size = 14),
        axis.text = element_text(size = 12),
        legend.position = "none",
        panel.grid.major.y = element_line(),
        panel.grid.minor = element_blank(),
        panel.background = element_rect(fill = "white"),
        plot.margin = margin(0, 0, 0, 1, "cm"))

figure_a9b = ggplot() +
  geom_point(data = output_32, aes(x = hour, y = beta_wind),color = "grey", size = 3) +
  geom_errorbar(data = output_32, aes(x = hour, ymax = beta_wind+2*stddev_wind, ymin = beta_wind-2*stddev_wind), size = 0.5) +
  geom_line(data = output_31, aes(x = hour, y = beta_wind),color = "red", size = 0.5)+
  geom_hline(yintercept = 0, color = "black", size = 1.2, linetype = "solid")+
  labs(x = "Hour", y = expression(paste("Change in Avg. Hourly Price \n ($/MWh)"))) +
  scale_x_continuous(limits = c(1,24), breaks = 1:24) +
  scale_y_continuous(limits = c(-0.6,0.2), breaks = seq(-0.6,0.2,0.1)) +
  theme_classic() +
  theme(plot.title = element_text(size = 20, face = "bold"),
        plot.subtitle = element_text(size = 16, face = "bold"),
        axis.title = element_text(size = 14),
        axis.text = element_text(size = 12),
        legend.position = "none",
        panel.grid.major.y = element_line(),
        panel.grid.minor = element_blank(),
        panel.background = element_rect(fill = "white"),
        plot.margin = margin(0, 0, 0, 1, "cm"))


figure_a13 = ggplot() +
  geom_point(data = output_33, aes(x = hour, y = beta_solar),color = "grey", size = 3) +
  geom_errorbar(data = output_33, aes(x = hour, ymax = beta_solar+2*stddev_solar, ymin = beta_solar-2*stddev_solar), size = 0.5) +
  geom_hline(yintercept = 0, color = "black", size = 1.2, linetype = "solid")+
  labs(x = "Hour", y = expression(paste("Change in Avg. Hourly Price \n ($/MWh)"))) +
  scale_x_continuous(limits = c(1,24), breaks = 1:24) +
  scale_y_continuous(limits = c(-0.3,0.3), breaks = seq(-0.3,0.3,0.1)) +
  theme_classic() +
  theme(plot.title = element_text(size = 20, face = "bold"),
        plot.subtitle = element_text(size = 16, face = "bold"),
        axis.title = element_text(size = 14),
        axis.text = element_text(size = 12),
        legend.position = "none",
        panel.grid.major.y = element_line(),
        panel.grid.minor = element_blank(),
        panel.background = element_rect(fill = "white"),
        plot.margin = margin(0, 0, 0, 1, "cm"))

figure_a13
figure_a9a
figure_a9b


```


** RTM energy component impacts (Figure A4)

```{r}
dat <- data %>%
  arrange(hour) %>%
  mutate(id = row_number())

output_4 = data.frame(hour = 1:24, beta_solar = NA, stddev_solar = NA)
output_plot = data.frame(hour = 1:24, 
                         beta_solar_energy = NA, 
                         beta_solar_price = NA)

for (h in 1:24) {
  fit = lm(rtm_energy_lmp ~ daily_solar + daily_wind + spot + load + inches_lag + as.factor(month), data = filter(dat, hour == h))
  
  nw_error = sqrt(diag(NeweyWest(fit, lag = 7, prewhite = FALSE)))
  output_4[h,2] = coef(fit)[2]
  output_4[h,3] = nw_error[2]
  output_plot[h,2] = coef(fit)[2]
  
  fit = lm(rtm_total_lmp ~ daily_solar + daily_wind + spot + load + inches_lag + as.factor(month), data = filter(dat, hour == h))
  output_plot[h,3] = coef(fit)[2]
}


output_4
```

figure A4
```{r}

linesize = 0.5
color = c("blue","red","green","black")
yscale_max = 0.4
yscale_min = -0.8
step = 0.2

figure_a4 =  ggplot(output_plot, aes(x = hour)) +
  geom_line(aes(y = beta_solar_energy),color = color[1], size = linesize)+
  geom_line(aes(y = beta_solar_price ),color = color[2], size = linesize)+
  geom_hline(yintercept = 0, color = "black", size = 1.2, linetype = "solid")+
  labs(x = "Hour", y = expression(paste("Avg. Change in Hourly Generation (MWh)"))) +
  scale_x_continuous(limits = c(1,24), breaks = 1:24) +
  scale_y_continuous(limits = c(yscale_min,yscale_max), breaks = seq(yscale_min,yscale_max,step)) +
  theme_classic() +
  theme(plot.title = element_text(size = 20, face = "bold"),
        plot.subtitle = element_text(size = 16, face = "bold"),
        axis.title = element_text(size = 14),
        axis.text = element_text(size = 12),
        legend.position = "none",
        panel.grid.major.y = element_line(),
        panel.grid.minor = element_blank(),
        panel.background = element_rect(fill = "white"),
        plot.margin = margin(0, 0, 0, 1, "cm"))


figure_a4
```


** The impact of hourly -- instead of daily -- wind generation (Figure A14)

```{r}
dat <- data %>%
  arrange(hour) %>%
  mutate(id = row_number())

output_41 = data.frame(hour = 1:24, beta_wind = NA, stddev_wind = NA)

for (h in 1:24) {
  fit = lm(rtm_total_lmp ~ daily_solar + wind + spot + load + inches_lag + as.factor(month), data = filter(dat, hour == h))
  
  nw_error = sqrt(diag(NeweyWest(fit, lag = 7, prewhite = FALSE)))
  output_41[h,2] = coef(fit)[3]
  output_41[h,3] = nw_error[3]
}



output_42 = data.frame(hour = 1:24, beta_wind = NA, stddev_wind = NA)

for (h in 1:24) {
  fit = lm(rtm_energy_lmp ~ daily_solar + wind + spot + load + inches_lag + as.factor(month), data = filter(dat, hour == h))
  
  nw_error = sqrt(diag(NeweyWest(fit, lag = 7, prewhite = FALSE)))
  output_42[h,2] = coef(fit)[3]
  output_42[h,3] = nw_error[3]
}

output_42
```

figure a14
```{r}
figure_a14a = ggplot(output_41, aes(x = hour)) +
  geom_point(aes(y = beta_wind),color = "grey", size = 3) +
  geom_errorbar(aes(ymax = beta_wind+2*stddev_wind, ymin = beta_wind-2*stddev_wind), size = 0.5) +
  geom_hline(yintercept = 0, color = "black", size = 1.2, linetype = "solid")+
  labs(x = "Hour", y = expression(paste("Change in Avg. Hourly Price \n ($/MWh)"))) +
  scale_x_continuous(limits = c(1,24), breaks = 1:24) +
  scale_y_continuous(limits = c(-0.014,0), breaks = seq(-0.014,0,0.002)) +
  theme_classic() +
  theme(plot.title = element_text(size = 20, face = "bold"),
        plot.subtitle = element_text(size = 16, face = "bold"),
        axis.title = element_text(size = 14),
        axis.text = element_text(size = 12),
        legend.position = "none",
        panel.grid.major.y = element_line(),
        panel.grid.minor = element_blank(),
        panel.background = element_rect(fill = "white"),
        plot.margin = margin(0, 0, 0, 1, "cm"))


dat_plot = 
  mutate(data, add_wind = wind/daily_wind)

dat_plot = group_by(dat_plot, hour) %>% 
  summarise(wind = mean(add_wind))

figure_a14b = ggplot(dat_plot, aes(x = hour)) +
  geom_line(aes(y = wind),color = "blue", size = 0.5) +
  labs(x = "Hour", y = expression(paste("Additional Wind (MWh) by hour"))) +
  scale_x_continuous(limits = c(1,24), breaks = 1:24) +
  scale_y_continuous(limits = c(0,60), breaks = seq(0,60,10)) +
  theme_classic() +
  theme(plot.title = element_text(size = 20, face = "bold"),
        plot.subtitle = element_text(size = 16, face = "bold"),
        axis.title = element_text(size = 14),
        axis.text = element_text(size = 12),
        legend.position = "none",
        panel.grid.major.y = element_line(),
        panel.grid.minor = element_blank(),
        panel.background = element_rect(fill = "white"),
        plot.margin = margin(0, 0, 0, 1, "cm"))


dat_plot1 = mutate(output_41,
                   beta_wind = beta_wind*dat_plot$wind,
                   stddev_wind = stddev_wind*dat_plot$wind)

dat_plot2 =
  data.frame(
    hour = 1:24,
    beta_wind = NA,
    stddev_wind = NA
  )

for (h in 1:24) {
  formel = formula(rtm_total_lmp ~ daily_solar + daily_wind + spot + load + inches_lag + as.factor(month))
  ols = lm(formel, data = data[data$hour == h, ])
  
  dat_plot2[h,2] = coef(ols)[3]
  nw_error = sqrt(diag(NeweyWest(ols, lag = 7, prewhite = FALSE)))
  dat_plot2[h,3] = nw_error[3]
}

dat_plot2$conf_upper = dat_plot2$beta_wind+2*dat_plot2$stddev_wind
dat_plot2$conf_lower = dat_plot2$beta_wind-2*dat_plot2$stddev_wind


figure_a14c = ggplot(dat_plot1, aes(x = hour)) +
  geom_point(aes(y = beta_wind),color = "grey", size = 3) +
  geom_errorbar(aes(ymax = beta_wind+2*stddev_wind, ymin = beta_wind-2*stddev_wind), size = 0.5) +
  geom_line(data = dat_plot2, aes(x = hour, y = beta_wind),color = "red", size = 0.8)+
  geom_line(data = dat_plot2, aes(x = hour, y = conf_upper),color = "red", size = 0.5)+
  geom_line(data = dat_plot2, aes(x = hour, y = conf_lower),color = "red", size = 0.5)+
  geom_hline(yintercept = 0, color = "black", size = 1.2, linetype = "solid")+
  labs(x = "Hour", y = expression(paste("Predicted Avg. Price Change \n ($/MWh)"))) +
  scale_x_continuous(limits = c(1,24), breaks = 1:24) +
  scale_y_continuous(limits = c(-0.8,0.2), breaks = seq(-0.8,0.2,0.2)) +
  theme_classic() +
  theme(plot.title = element_text(size = 20, face = "bold"),
        plot.subtitle = element_text(size = 16, face = "bold"),
        axis.title = element_text(size = 14),
        axis.text = element_text(size = 12),
        legend.position = "none",
        panel.grid.major.y = element_line(),
        panel.grid.minor = element_blank(),
        panel.background = element_rect(fill = "white"),
        plot.margin = margin(0, 0, 0, 1, "cm"))



figure_a14a
figure_a14b
figure_a14c
```


** Nonlinear response to short-run variation in solar generation

```{r}
dat = filter(data, year == 2016 & hour == 12)

fit = lm(daily_solar ~ daily_wind + load + spot + inches_lag + factor(month), data = dat)
dat = mutate(dat,daily_solar_resid = resid(fit))

fit = lm(rtm_total_lmp ~ daily_wind + load + spot + inches_lag + factor(month), data = dat)
dat = mutate(dat,lmp_resid = NA)
dat[!is.na(dat$rtm_total_lmp) ,"lmp_resid"] = resid(fit)


```

figure a10
```{r}
figure_a10 = ggplot(dat, aes(x=daily_solar_resid)) +
  geom_histogram(binwidth=2, fill="blue", color="black") +
  theme_minimal()

figure_a10
```

figure a11
```{r}
summary_resid = quantile(dat$daily_solar_resid, probs = c(0.05, 0.95))

min = summary_resid[1]
max = summary_resid[2]

dat_plot <- dat %>%
  filter(daily_solar_resid >= min & daily_solar_resid <= max)



#fit = loess(lmp_resid ~ daily_solar_resid, data = dat_plot, span = 5)
#dat_plot$fitted = predict(fit, dat_plot$daily_solar_resid)
#
#
#ggplot(dat_plot, aes(x = daily_solar_resid)) +
#  geom_line(aes(y = fitted), colour = "red") +
#  labs(title = "Figure A11: LOESS Fit of lmp_resid vs daily_solar_resid",
#       x = "daily_solar_resid",
#       y = "lmp_resid") +
#  theme_minimal()

figure_a11 = ggplot(dat_plot, aes(x=daily_solar_resid, y=lmp_resid)) +
  geom_smooth(method = "loess", span = 5) +
  theme_minimal()

figure_a11


#stimmt nicht ganz
```









